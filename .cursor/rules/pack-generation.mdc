---
description: Полный пайплайн генерации пака — Concept → Boss → Captions → Scenes → сборка (при «сгенерируй пак»)
---

# Pack Generation — полный пайплайн

Когда пользователь просит **сгенерировать пак** (фразы вроде «сгенерируй пак», «pack по запросу», «стикерпак на тему», «сделай пак: офисный юмор») — выполни полный пайплайн **в рамках одного чата**, последовательно играя роли агентов. Используй логику из соответствующих rule-файлов и из `docs/pack-multiagent-requirements.md`.

**Повторная генерация той же темы:** если пользователь снова запрашивает ту же тему (напр. уже генерировали «День интроверта» и снова «сгенерируй пак День интроверта»), без дополнительных указаний модель часто выдаёт те же фразы и моменты. Чтобы получить **другой набор подписей и сцен**, пользователь может добавить в запрос: «другой вариант», «новый угол», «другие формулировки», «более ироничный» и т.п. — тогда передай это в Concept (и далее в цепочке), чтобы агенты сознательно варьировали тон, моменты и подписи. Если пользователь не указал вариацию — выполни пайплайн как обычно; в ответе можно кратко напомнить: «Для другого набора фраз в следующий раз добавь в запрос «другой вариант» или «новый угол»».

## Порядок действий

1. **Контекст фото.** Если пользователь не указал — уточни или прими subject_type по умолчанию (напр. single) и напиши в ответе, какой контекст использован.
2. **Concept:** по запросу + контексту фото выдай бриф (JSON: subject_type, setting, persona, tone, timeline=one_day, situation_types, shareability_hook, title_hint). Концепт должен подходить под персонажа(ов) на фото. Правила — как в @pack-concept.mdc.
3. **Boss:** по брифу выдай план (JSON: id, pack_template_id, subject_mode, name_ru/en, carousel_description_ru/en, mood, sort_order, segment_id, story_arc, tone, day_structure, moments[9]). Правила — как в @pack-boss.mdc.
4. **Captions:** по плану выдай labels и labels_en (по 9 строк). Правила — как в @pack-captions.mdc.
5. **Scenes:** по плану и подписям выдай scene_descriptions (9 строк с {subject}). Правила — как в @pack-scenes.mdc.
6. **Сборка:** собери итог в формат **pack_content_sets** (раздел 1 докa): одна строка со всеми колонками (id, pack_template_id, name_ru, name_en, carousel_description_ru/en, labels, labels_en, scene_descriptions, sort_order, is_active=true, mood, sticker_count=9, subject_mode, cluster=false, segment_id). Выдай в виде таблицы или JSON, готового для вставки в миграцию/БД.
7. **Опционально:** если пользователь просит проверку — выполни роль Critic (@pack-critic.mdc) и при pass=false предложи итерацию.

## Обязательно учитывать

- **STICKER PACK MASTER SYSTEM** (раздел 5 докa): моменты, не эмоции; 70% интенсивность; без статичных поз; баланс сетки 3×3; подписи = внутренний комментарий; один день, виральность.
- **Контекст фото** (раздел 0.6): концепт и план под того, кто на фото (single/couple, пол при необходимости).
- Итоговый формат выхода = схема таблицы `pack_content_sets` (раздел 1).

Если запрос короткий (напр. «сгенерируй пак: офисный юмор»), выполни все шаги подряд и в конце выдай готовую спеку. Если ответ получается слишком длинным — можно выдать итог компактно (таблица по разделу 1) и предложить по шагам через @pack-concept.mdc → @pack-boss.mdc и т.д. для правок.
