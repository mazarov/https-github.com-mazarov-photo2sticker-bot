---
description: Full pack generation pipeline — Concept → Boss → Captions → Scenes → assembly (on "generate pack")
---

# Pack Generation — full pipeline

When the user asks to **generate a pack** (phrases like "generate pack", "pack on request", "sticker pack on theme", "make a pack: office humor") — run the full pipeline **in one chat**, playing each agent role in sequence. Use the logic from the corresponding rule files and from `docs/pack-multiagent-requirements.md`.

**Regenerating the same theme:** If the user requests the same theme again (e.g. already generated "Introvert's day" and again "generate pack Introvert's day"), without extra instructions the model often outputs the same phrases and moments. To get a **different set of captions and scenes**, the user can add to the request: "different take", "new angle", "different wording", "more ironic", etc. — then pass this to Concept (and down the chain) so agents consciously vary tone, moments, and captions. If the user did not specify variation — run the pipeline as usual; in the reply you can briefly remind: "For a different set of phrases next time add 'different take' or 'new angle' to the request."

## Order of steps

1. **Photo context.** If the user did not specify — clarify or assume default subject_type (e.g. single) and state in the reply which context was used.
2. **Concept:** from request + photo context output brief (JSON: subject_type, setting, persona, tone, timeline=one_day, situation_types, shareability_hook, title_hint). Concept must fit the character(s) in the photo. Rules — as in @pack-concept.mdc.
3. **Boss:** from brief output plan (JSON: id, pack_template_id, subject_mode, name_ru/en, carousel_description_ru/en, mood, sort_order, segment_id, story_arc, tone, day_structure, moments[9]). Rules — as in @pack-boss.mdc.
4. **Captions:** from plan output labels and labels_en (9 strings each). Rules — as in @pack-captions.mdc.
5. **Scenes:** from plan and captions output scene_descriptions (9 strings with {subject}). Rules — as in @pack-scenes.mdc.
6. **Assembly:** assemble the result into **pack_content_sets** format (section 1 of doc): one row with all columns (id, pack_template_id, name_ru, name_en, carousel_description_ru/en, labels, labels_en, scene_descriptions, sort_order, is_active=true, mood, sticker_count=9, subject_mode, cluster=false, segment_id). Output as table or JSON ready for migration/DB insert.
7. **Critic (mandatory):** run the Critic role (@pack-critic.mdc) on the assembled spec. If pass=false — apply suggestions: re-run Captions (and if needed Scenes) with the feedback, then reassemble and run Critic again until pass=true. Do not skip this step.

## Must account for

- **STICKER PACK MASTER SYSTEM** (section 5 of doc): moments not emotions; 70% intensity; no static poses; 3×3 grid balance; captions = internal comment; one day, virality.
- **Photo context** (section 0.6): concept and plan for who is in the photo (single/couple, gender if needed).
- Final output format = `pack_content_sets` table schema (section 1).

If the request is short (e.g. "generate pack: office humor"), run all steps in a row and at the end output the ready spec. If the reply gets too long — you can output the result compactly (table per section 1) and offer step-by-step edits via @pack-concept.mdc → @pack-boss.mdc etc.
