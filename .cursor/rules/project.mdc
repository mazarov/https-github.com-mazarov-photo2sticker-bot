# Photo2Sticker Bot — Project Rules

## Перед деплоем (ОБЯЗАТЕЛЬНО)

1. **Проверить билд локально:**
   ```bash
   npm run build
   ```
   Если есть ошибки TypeScript — исправить до коммита.

2. **При изменении select запросов** — проверить что все нужные поля включены в select.

3. **Перед каждым релизом / деплоем:**
   - Проверить, что новые изменения не ломают существующую логику (стили, assistant, платежи, рассылки)
   - Оценить пересечения с текущими callback, handler'ами и flow
   - Остановиться и дождаться явного подтверждения от пользователя («Готово к релизу» / «можно деплоить»)
   - Без подтверждения — не коммитить и не пушить

## Работа с кодом

- После создания SQL миграции — напомнить пользователю выполнить в Supabase
- Новые фичи документировать в `docs/` перед реализацией
- Читать `docs/known-bugs.md` при работе с соответствующими компонентами

## Коммиты

- Формат: `type: description` (feat, fix, docs, refactor)
- Пушить сразу после коммита

## Деплой

### Архитектура
Проект работает на **Dockhost** — 4 отдельных Docker-контейнера, каждый со своим Dockerfile:
- `Dockerfile.api` → API бот (Telegram webhook / long polling)
- `Dockerfile.worker` → Воркер генерации стикеров
- `Dockerfile.support` → Саппорт бот
- `Dockerfile.rembg` → Self-hosted rembg сервер (удаление фона)

### Прод (main)
- Деплой автоматический через GitHub Actions при пуше в `main`
- **НЕ использовать** Dockhost API для редеплоя — endpoint не работает
- После `git push` просто дождаться автодеплоя

### Тест (feature ветки)
1. Создать feature-ветку: `git checkout -b feature/my-feature`
2. Запушить: `git push -u origin feature/my-feature`
3. **Применить SQL-миграции** в Supabase (единая БД для прод и тест, разделение по колонке `env`)
4. **Редеплой тестовых контейнеров на Dockhost вручную:**
   - Зайти в Dockhost → выбрать тестовый контейнер (api / worker)
   - Сменить ветку на feature-ветку → Rebuild
   - Или: пользователь делает это сам через UI Dockhost
5. Тестовый бот использует `.env.test` с `APP_ENV=test` — все данные (users, sessions, jobs) фильтруются по `env = 'test'`

### Локальный запуск для отладки
```bash
npm run dev:test:api      # API с .env.test (long polling)
npm run dev:test:worker   # Воркер с .env.test
```
⚠️ Локальный запуск конфликтует с запущенным на Dockhost тестовым ботом (409 Conflict) — нужно сначала остановить контейнер на Dockhost

### Разделение окружений
- `APP_ENV=prod` / `APP_ENV=test` — колонка `env` в таблицах `users`, `sessions`, `jobs`, `stickers`
- Одна Supabase БД для обоих окружений
- Разные Telegram боты (разные токены)

## Известные ограничения

- Support bot не может писать первым — использовать deep links из основного бота
- Telegram API `sendMediaGroup` рендерит прозрачность как белый фон
- `pendingFeedback` и `pendingIssues` в support-bot хранятся в памяти, теряются при рестарте

## Структура проекта

```
src/
├── index.ts        — основной бот (Telegraf)
├── worker.ts       — воркер генерации стикеров
├── support-bot.ts  — саппорт бот
├── config.ts       — конфигурация
└── lib/
    ├── alerts.ts   — алерты и нотификации
    ├── supabase.ts — клиент Supabase
    ├── telegram.ts — утилиты Telegram API
    └── texts.ts    — локализация (ru/en)

docs/           — требования и документация
docs/done/      — завершённые фичи
sql/            — миграции (нумерация 001, 002...)
```

## Локализация

- Все пользовательские сообщения через `getText(lang, key)`
- Поддерживаемые языки: `ru`, `en`
- Тексты в `src/lib/texts.ts`

## База данных (Supabase)

- Таблицы: users, sessions, jobs, stickers, sticker_sets, transactions, notification_triggers, sticker_ratings, sticker_issues
- RPC функции: `claim_job` (атомарный захват job воркером)
- При добавлении полей — создавать миграцию в `sql/`

## Модели генерации

- Основная: `gemini-2.5-flash-image`
- Для текста (планируется): `gemini-3-pro-vision` (Nano Banana Pro)
- Выбор модели в `worker.ts`
