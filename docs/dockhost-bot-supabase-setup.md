# Пошаговая настройка в Dockhost: бот в одном проекте, Supabase в другом

Цель: чтобы контейнеры бота (API, Worker) могли обращаться к Supabase (БД и Storage) в другом проекте через Kong.

---

## Шаг 1. Узнать адрес Kong (уже сделано)

- Проект с Supabase → сервис **supabase-kong** → параметры/сеть.
- Внутренний IP: **10.177.250.48**, порт **80**.

---

## Шаг 2. Разрешить трафик между проектами

По ответу поддержки Dockhost:

> Между проектами можно разрешить трафик: **Настройки / DNS и сеть**. Контейнеры смогут общаться по IP адресу сервиса (внутренний IP), или можно задать DNS-имя на этот IP.

### Что сделать в панели Dockhost

1. Открой **Настройки** (иконка шестерёнки или пункт меню «Настройки»).  
   Это могут быть настройки **текущего проекта** (где бот) или **общие настройки аккаунта** — в зависимости от того, как в Dockhost организован доступ между проектами.

2. Найди раздел **«DNS и сеть»** (или «Сеть», «Network»).

3. В этом разделе должна быть возможность **разрешить трафик между проектами** (whitelist, peer project, «разрешить доступ к проекту X» и т.п.).  
   - Укажи, что проект с **ботом** может обращаться к проекту с **Supabase** (или к сети проекта с Supabase).  
   - Если интерфейс предлагает «добавить проект» или «разрешить исходящий трафик в проект» — выбери проект, где крутится Supabase.

4. Сохрани изменения.

**Если такого пункта нет или непонятно:**

- Официальная документация:  
  - [DNS и сеть проекта](https://docs.dockhost.ru/manual/project/network/dns)  
  - [Создание домена](https://docs.dockhost.ru/manual/network/domain/create)  
  - [Создание маршрута](https://docs.dockhost.ru/manual/network/route/create)  
- Напиши в поддержку Dockhost:  
  «Нужно разрешить трафик из проекта с ботом к проекту с Supabase (к сервису supabase-kong, IP 10.177.250.48:80). В разделе Настройки → DNS и сеть не нахожу, где включается доступ между проектами. Подскажите, в каком разделе это настраивается и какие шаги выполнить.»

---

## Шаг 3. (Опционально) DNS-имя на IP Kong

Если в разделе «DNS и сеть» можно задать **DNS-запись** (имя → IP):

- Создай имя (например, `supabase-kong-internal`) и привяжи его к **10.177.250.48**.
- Тогда в env бота можно указать `http://supabase-kong-internal:80` вместо сырого IP.  
Если такой возможности нет — используй в шаге 4 просто IP.

---

## Шаг 4. Переменные окружения бота

В проекте, где крутятся **API** и **Worker**:

| Переменная | Значение |
|------------|----------|
| `SUPABASE_SUPABASE_PUBLIC_URL` | `http://10.177.250.48:80` (или созданный в шаге 3 DNS, или уже настроенный домен вида `https://bk07-67ud-ea1y.gw-1a.dockhost.net`) |
| `SUPABASE_SERVICE_ROLE_KEY` | Service role key **этого же** Supabase (из проекта с БД) |
| `SUPABASE_STORAGE_BUCKET` | `stickers` (по умолчанию) |
| `SUPABASE_STORAGE_BUCKET_EXAMPLES` | `stickers-examples` (по умолчанию) |

Проверь, что имя переменной именно **SUPABASE_SUPABASE_PUBLIC_URL** (одно подчёркивание между словами).

---

## Шаг 5. Бакеты Storage (если ещё не созданы)

В проекте с Supabase нужно иметь бакеты **stickers** и **stickers-examples**:

- Через админку **MinIO**: порт **9001**. Чтобы открыть её снаружи, в Dockhost создают домен и маршрут на порт 9001 (см. [домен](https://docs.dockhost.ru/manual/network/domain/create), [маршрут](https://docs.dockhost.ru/manual/network/route/create)).
- Либо после того как связь через Kong заработает — через API Supabase (например, из скрипта или вручную по документации Supabase).

Для лендинга бакет **stickers-examples** должен быть **Public**.

---

## Шаг 6. Перезапуск и проверка

1. Сохрани переменные окружения (шаг 4).
2. **Перезапусти** контейнеры API и Worker.
3. Проверь логи: не должно быть ошибок «fetch failed» при обращении к БД и к Storage.

---

## Кратко: что за «домен и маршрут» в ответе поддержки

Поддержка писала:

> Для доступа к контейнеру **из вне** (не используя Kong) необходимо настроить домен и маршрут.

Это про доступ **напрямую к контейнеру снаружи** (минуя Kong). Для нашего бота это **не нужно**: бот должен ходить **через Kong** по одному URL (БД + Storage). Домен и маршрут нужны, если захочешь, например, открыть админку MinIO (порт 9001) в браузере — тогда создаёшь домен и маршрут на 9001.
