# –û–ø–ª–∞—Ç–∞ –≤ —Ä—É–±–ª—è—Ö ‚Äî –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã –≤ —Ä—É–±–ª—è—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ª–æ–∫–∞–ª—å—é `ru`. –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–∫–∞–ª–µ–π –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Telegram Stars.

---

## –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç—ã –≤ Stars
- –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars (XTR)

---

## –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### –î–ª—è `lang !== "ru"` (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

```
[–ö—É–ø–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã]
    ‚Üì
–í–∞—à –±–∞–ª–∞–Ω—Å: X –∫—Ä–µ–¥–∏—Ç–æ–≤

[2 ‚Äî 15‚≠ê]  [5 ‚Äî 30‚≠ê]
[10 ‚Äî 60‚≠ê] [20 ‚Äî 100‚≠ê]
[‚ùå –û—Ç–º–µ–Ω–∞]
```

### –î–ª—è `lang === "ru"` (–Ω–æ–≤—ã–π —à–∞–≥)

```
[–ö—É–ø–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã]
    ‚Üì
–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:
[‚≠ê Telegram Stars]
[üí≥ –ö–∞—Ä—Ç–∞ (—Ä—É–±–ª–∏)]
[‚ùå –û—Ç–º–µ–Ω–∞]
    ‚Üì
(–µ—Å–ª–∏ Stars)              (–µ—Å–ª–∏ –†—É–±–ª–∏)
–í–∞—à –±–∞–ª–∞–Ω—Å: X –∫—Ä–µ–¥–∏—Ç–æ–≤    –í–∞—à –±–∞–ª–∞–Ω—Å: X –∫—Ä–µ–¥–∏—Ç–æ–≤

[2 ‚Äî 15‚≠ê]  [5 ‚Äî 30‚≠ê]      [2 ‚Äî 20‚ÇΩ]  [5 ‚Äî 50‚ÇΩ]
[10 ‚Äî 60‚≠ê] [20 ‚Äî 100‚≠ê]    [10 ‚Äî 100‚ÇΩ] [20 ‚Äî 200‚ÇΩ]
[‚ùå –û—Ç–º–µ–Ω–∞]                [‚ùå –û—Ç–º–µ–Ω–∞]
```

---

## –¢–∞—Ä–∏—Ñ—ã

| –ö—Ä–µ–¥–∏—Ç—ã | Stars | RUB |
|---------|-------|-----|
| 2 | 15‚≠ê | 20‚ÇΩ |
| 5 | 30‚≠ê | 50‚ÇΩ |
| 10 | 60‚≠ê | 100‚ÇΩ |
| 20 | 100‚≠ê | 200‚ÇΩ |

–¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö: **10‚ÇΩ –∑–∞ 1 –∫—Ä–µ–¥–∏—Ç**.

---

## –ü–ª–∞—Ç—ë–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

**–ÆKassa** —á–µ—Ä–µ–∑ Telegram Payments API:
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ webhook
- –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `sendInvoice`
- –ù—É–∂–µ–Ω `provider_token` –∏–∑ BotFather

### –ü–æ–ª—É—á–µ–Ω–∏–µ provider_token

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ [yookassa.ru](https://yookassa.ru)
2. –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω, –ø—Ä–æ–π—Ç–∏ –º–æ–¥–µ—Ä–∞—Ü–∏—é
3. –í BotFather: `/mybots` ‚Üí –±–æ—Ç ‚Üí Payments ‚Üí Connect –ÆKassa
4. –ü–æ–ª—É—á–∏—Ç—å `provider_token`

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
YOOKASSA_PROVIDER_TOKEN=your_provider_token_here
```

### 2. –ö–æ–Ω—Ñ–∏–≥ (config.ts)

```typescript
yookassaProviderToken: process.env.YOOKASSA_PROVIDER_TOKEN || "",
```

### 3. –¢–∞—Ä–∏—Ñ—ã (index.ts)

```typescript
const CREDIT_PACKS_STARS = [
  { credits: 2, price: 15 },
  { credits: 5, price: 30 },
  { credits: 10, price: 60 },
  { credits: 20, price: 100 },
];

const CREDIT_PACKS_RUB = [
  { credits: 2, price: 20 },
  { credits: 5, price: 50 },
  { credits: 10, price: 100 },
  { credits: 20, price: 200 },
];
```

### 4. Callback handlers

```typescript
// –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è ru)
bot.action("pay_stars", async (ctx) => {
  // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–∫–µ—Ç—ã –≤ Stars
});

bot.action("pay_rub", async (ctx) => {
  // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–∫–µ—Ç—ã –≤ —Ä—É–±–ª—è—Ö
});

// –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ –≤ Stars (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
bot.action(/^pack_(\d+)_(\d+)$/, async (ctx) => { ... });

// –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ –≤ —Ä—É–±–ª—è—Ö (–Ω–æ–≤—ã–π)
bot.action(/^pack_rub_(\d+)_(\d+)$/, async (ctx) => { ... });
```

### 5. sendInvoice –¥–ª—è —Ä—É–±–ª–µ–π

```typescript
await axios.post(`https://api.telegram.org/bot${token}/sendInvoice`, {
  chat_id: telegramId,
  title: "10 –∫—Ä–µ–¥–∏—Ç–æ–≤",
  description: "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ 10 –∫—Ä–µ–¥–∏—Ç–æ–≤",
  payload: `[${transactionId}]`,
  provider_token: config.yookassaProviderToken, // <-- –æ—Ç–ª–∏—á–∏–µ –æ—Ç Stars
  currency: "RUB",                               // <-- –æ—Ç–ª–∏—á–∏–µ –æ—Ç Stars
  prices: [{ label: "–ö—Ä–µ–¥–∏—Ç—ã", amount: 10000 }], // –∫–æ–ø–µ–π–∫–∏! 100‚ÇΩ = 10000
});
```

**–í–∞–∂–Ω–æ:** –î–ª—è RUB `amount` —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ **–∫–æ–ø–µ–π–∫–∞—Ö** (100‚ÇΩ = 10000).

### 6. –ü–æ–ª–µ –≤ transactions

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∞–ª—é—Ç—ã:

```sql
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS currency varchar(3) DEFAULT 'XTR';
```

---

## –¢–µ–∫—Å—Ç—ã (localization)

### –ù–æ–≤—ã–µ –∫–ª—é—á–∏

| –ö–ª—é—á | RU | EN |
|------|----|----|
| `payment.choose_method` | –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã | Choose payment method |
| `btn.pay_stars` | ‚≠ê Telegram Stars | ‚≠ê Telegram Stars |
| `btn.pay_rub` | üí≥ –ö–∞—Ä—Ç–∞ (—Ä—É–±–ª–∏) | üí≥ Card (rubles) |

---

## SQL –º–∏–≥—Ä–∞—Ü–∏—è

```sql
-- 010_rub_payments.sql

-- Currency field for transactions
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS currency varchar(3) DEFAULT 'XTR';

-- Payment method texts
INSERT INTO bot_texts_new (lang, key, text) VALUES
  ('ru', 'payment.choose_method', '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã'),
  ('en', 'payment.choose_method', 'Choose payment method'),
  ('ru', 'btn.pay_stars', '‚≠ê Telegram Stars'),
  ('en', 'btn.pay_stars', '‚≠ê Telegram Stars'),
  ('ru', 'btn.pay_rub', 'üí≥ –ö–∞—Ä—Ç–∞ (—Ä—É–±–ª–∏)'),
  ('en', 'btn.pay_rub', 'üí≥ Card (rubles)')
ON CONFLICT (lang, key) DO UPDATE SET
  text = EXCLUDED.text,
  updated_at = now();
```

---

## –õ–æ–≥–∏–∫–∞ sendBuyCreditsMenu

```typescript
async function sendBuyCreditsMenu(ctx: any, user: any, messageText?: string) {
  const lang = user.lang || "en";

  // –î–ª—è ru ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
  if (lang === "ru") {
    const text = messageText || await getText(lang, "payment.choose_method");
    const buttons = [
      [Markup.button.callback(await getText(lang, "btn.pay_stars"), "pay_stars")],
      [Markup.button.callback(await getText(lang, "btn.pay_rub"), "pay_rub")],
      [Markup.button.callback(await getText(lang, "btn.cancel"), "cancel")],
    ];
    await ctx.reply(text, Markup.inlineKeyboard(buttons));
    return;
  }

  // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî —Å—Ä–∞–∑—É –ø–∞–∫–µ—Ç—ã –≤ Stars
  await sendStarsPacksMenu(ctx, user, messageText);
}

async function sendStarsPacksMenu(ctx: any, user: any, messageText?: string) {
  // –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ —Å CREDIT_PACKS_STARS
}

async function sendRubPacksMenu(ctx: any, user: any) {
  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å CREDIT_PACKS_RUB
  // callback_data: pack_rub_{credits}_{price}
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ (pre_checkout_query / successful_payment)

–õ–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–π –∂–µ ‚Äî Telegram Payments API —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –†–∞–∑–ª–∏—á–∏–µ —Ç–æ–ª—å–∫–æ –≤:
- `provider_token` (–ø—É—Å—Ç–æ–π –¥–ª—è Stars, –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–ª—è –ÆKassa)
- `currency` (XTR vs RUB)
- `amount` (Stars ‚Äî —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, RUB ‚Äî –∫–æ–ø–µ–π–∫–∏)

---

## –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –î–æ–±–∞–≤–∏—Ç—å `YOOKASSA_PROVIDER_TOKEN` –≤ config
- [ ] –†–∞–∑–¥–µ–ª–∏—Ç—å `CREDIT_PACKS` –Ω–∞ Stars –∏ RUB
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—ã –≤ fallbackTexts
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å `sendBuyCreditsMenu` –¥–ª—è ru
- [ ] –î–æ–±–∞–≤–∏—Ç—å `sendRubPacksMenu`
- [ ] –î–æ–±–∞–≤–∏—Ç—å callbacks: `pay_stars`, `pay_rub`, `pack_rub_*`
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å sendInvoice –¥–ª—è RUB (provider_token, currency, amount –≤ –∫–æ–ø–µ–π–∫–∞—Ö)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `currency` –≤ transactions
- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è `010_rub_payments.sql`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–ß–µ–∫–∏ 54-–§–ó:** –ü–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º (—Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏–¥–µ—é)
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ÆKassa:** ~10-50‚ÇΩ (20‚ÇΩ –∑–∞ 2 –∫—Ä–µ–¥–∏—Ç–∞ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏)
- **–í–æ–∑–≤—Ä–∞—Ç—ã:** –ß–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa –≤—Ä—É—á–Ω—É—é
