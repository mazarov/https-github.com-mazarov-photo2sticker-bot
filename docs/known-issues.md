# Known Issues

Список известных проблем и ограничений системы.

---

## 1. Белый фон у стикера в уведомлениях

**Статус:** Open  
**Приоритет:** Low  
**Компонент:** `src/lib/alerts.ts`, `src/worker.ts`

### Описание
При отправке уведомления `new_sticker` результат генерации (стикер) отображается с белым фоном вместо прозрачного.

### Причина
- Стикер — это WebP с прозрачным фоном
- Telegram API `sendMediaGroup` с `type: "photo"` рендерит прозрачность как белый фон
- Нельзя смешивать разные типы медиа (photo + sticker) в одном media group

### Возможные решения
1. Отправлять 2 отдельных сообщения: photo с caption + sticker (через `sendSticker`)
2. Отправлять результат как document (сохранит прозрачность, но отображается как файл)
3. Добавлять фон к результату перед отправкой (шахматная сетка)

### Workaround
Пока оставлено как есть — функционально работает, визуально не критично.

---

## 2. Нет retry логики для Telegram API

**Статус:** Open  
**Приоритет:** Medium  
**Компонент:** `src/lib/telegram.ts`, `src/lib/alerts.ts`

### Описание
Если отправка сообщения в Telegram API упала (таймаут, 5xx ошибка), нет автоматических повторных попыток.

### Причина
Не реализовано.

### Возможные решения
1. Добавить exponential backoff retry (3 попытки с задержкой 1s, 2s, 4s)
2. Использовать библиотеку типа `p-retry`
3. Для критичных сообщений — сохранять в очередь и обрабатывать worker'ом

### Workaround
Нет. При ошибке сообщение теряется.

---

## 3. In-memory Maps теряются при рестарте

**Статус:** Open  
**Приоритет:** Low  
**Компонент:** `src/support-bot.ts`

### Описание
`pendingFeedback` и `pendingIssues` Maps хранятся в памяти. При рестарте контейнера данные теряются — пользователь, начавший писать feedback, не сможет его завершить.

### Причина
Архитектурное решение для простоты. Feedback flow короткий (< 1 минуты).

### Возможные решения
1. Хранить pending состояния в Redis/Supabase
2. Использовать session middleware Telegraf с persistence
3. Оставить как есть — рестарты редки, flow короткий

### Workaround
Пользователь может начать заново через deep link.

---

## 4. Нет rate limiting

**Статус:** Open  
**Приоритет:** Medium  
**Компонент:** `src/index.ts`, `src/worker.ts`

### Описание
Нет защиты от спама и abuse. Пользователь может отправлять неограниченное количество запросов.

### Причина
Не реализовано. Пока трафик небольшой.

### Возможные решения
1. Rate limit на уровне бота: X сообщений в минуту на пользователя
2. Rate limit на уровне генерации: X jobs в минуту на пользователя
3. Использовать Telegraf middleware `telegraf-ratelimit`
4. Cloudflare / API Gateway rate limiting

### Workaround
Кредиты служат естественным ограничением — без кредитов генерация невозможна.

---

## Шаблон для новых issues

```markdown
## N. Название проблемы

**Статус:** Open | In Progress | Resolved  
**Приоритет:** Critical | High | Medium | Low  
**Компонент:** путь к файлу

### Описание
Что происходит.

### Причина
Почему это происходит.

### Возможные решения
1. Вариант 1
2. Вариант 2

### Workaround
Временное решение (если есть).
```
