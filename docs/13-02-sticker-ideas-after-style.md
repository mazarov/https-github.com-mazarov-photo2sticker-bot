# –ò–¥–µ–∏ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ñ–æ—Ç–æ (AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç)

## –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∏–π —Ñ–ª–æ—É AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π:
```
–§–æ—Ç–æ ‚Üí LLM —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Ç–∏–ª—å ‚Üí LLM —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —ç–º–æ—Ü–∏—é ‚Üí LLM —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–∑—É ‚Üí –ó–µ—Ä–∫–∞–ª–æ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
```
5 —à–∞–≥–æ–≤ –æ—Ç —Ñ–æ—Ç–æ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç—Å—è, –æ—Ç–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è.

## –ù–æ–≤—ã–π —Ñ–ª–æ—É

```
/start ‚Üí "–ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ" ‚Üí –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
    ‚Üì
‚è≥ "–ü–æ–¥–±–∏—Ä–∞—é –∏–¥–µ–∏..." (LLM –≥–µ–Ω–µ—Ä–∏—Ç –∏–¥–µ–∏ –ø–æ —Ñ–æ—Ç–æ + —Å—Ç–∏–ª—é, ~3-5 —Å–µ–∫)
    ‚Üì
üí° –ò–¥–µ—è 1/8
üé® –°—Ç–∏–ª—å: üéå –ê–Ω–∏–º–µ
üòÇ –•–æ—Ö–æ—á–µ—Ç –¥–æ —Å–ª—ë–∑
–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–º–µ—ë—Ç—Å—è, –¥–µ—Ä–∂–∞—Å—å –∑–∞ –∂–∏–≤–æ—Ç

[üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)]
[üîÑ –î—Ä—É–≥–æ–π —Å—Ç–∏–ª—å] [‚û°Ô∏è –î—Ä—É–≥–∞—è –∏–¥–µ—è]
[‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è]
[‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Äî –æ–±—ã—á–Ω—ã–π –¥–∏–∞–ª–æ–≥]
    ‚Üì
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è: style + idea ‚Üí generatePrompt() ‚Üí Gemini
    ‚Üì
–°—Ç–∏–∫–µ—Ä + —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
```

**1 —à–∞–≥** –æ—Ç —Ñ–æ—Ç–æ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –°—Ç–∏–ª—å + —ç–º–æ—Ü–∏—è + –ø–æ–∑–∞ ‚Äî –≤—Å—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ —Å—Ä–∞–∑—É.

## –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –∏–¥–µ–∏

### LLM –≥–µ–Ω–µ—Ä–∏—Ç –∏–¥–µ–∏ (–∫–∞–∫ `generatePackIdeas`)

–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø–æ–¥—Ö–æ–¥ —á—Ç–æ –∏ —Ñ–∏—á–∞ "–ò–¥–µ–∏ –¥–ª—è –ø–∞–∫–∞":
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º **—Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** + **prompt_hint –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è** –≤ GPT-4o-mini
- –ü—Ä–æ—Å–∏–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 8 —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö –∏–¥–µ–π –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ç–æ—Ç –∂–µ `StickerIdea[]`

–û—Ç–ª–∏—á–∏–µ –æ—Ç `generatePackIdeas`:
- `generatePackIdeas` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç **—É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∏–∫–µ—Ä** (—Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∏–ª—å, –æ–¥–µ–∂–¥—É)
- –ó–¥–µ—Å—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º **–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ** (–±–µ–∑ —Å—Ç–∏–ª—è) ‚Äî –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–º–ø—Ç –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è

–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `generateStickerIdeasFromPhoto(opts)`:
```typescript
async function generateStickerIdeasFromPhoto(opts: {
  photoFileId: string;     // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  stylePresetId: string;   // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å
  lang: string;
}): Promise<StickerIdea[]>
```

–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM:
```
You are a professional sticker designer.
Analyze the user's photo and suggest 8 unique sticker ideas in the style: {styleName} ({styleHint}).

For each idea ‚Äî describe a new expressive pose, emotion, or scene for the character.
Match ideas to the person in the photo (their appearance, vibe, energy).

CRITICAL: promptModification must describe what the CHARACTER is DOING, not the style.
The style comes from the preset ‚Äî ideas add emotion/pose/action on top.

Categories: emotion, reaction, action, scene, text_meme, greeting, farewell, sarcasm...
```

**Fallback**: –µ—Å–ª–∏ LLM –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º `getDefaultIdeas(lang)` (–∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫).

**–°—Ç–æ–∏–º–æ—Å—Ç—å**: ~$0.003 –∑–∞ –≤—ã–∑–æ–≤ GPT-4o-mini —Å —Ñ–æ—Ç–æ. –ü—Ä–∏–µ–º–ª–µ–º–æ.
**–í—Ä–µ–º—è**: ~3-5 —Å–µ–∫. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "‚è≥ –ü–æ–¥–±–∏—Ä–∞—é –∏–¥–µ–∏..." –ø–æ–∫–∞ –∂–¥—ë–º.

–°—Ç–∏–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∫–∞–∑–µ ‚Äî **—Å–ª—É—á–∞–π–Ω—ã–π –∏–∑ `style_presets_v2`**.

## –ö–∞–∫ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç

–ß–µ—Ä–µ–∑ `prompt_generator` –∞–≥–µ–Ω—Ç (—Ç–æ—Ç –∂–µ LLM —á—Ç–æ –∏ —Ä—É—á–Ω–æ–π/–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º):

```
userText = preset.prompt_hint + ", " + idea.promptModification
    ‚Üì
generatePrompt(userText)
    ‚Üì
promptFinal (–ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Gemini image generation)
```

LLM-–∞–≥–µ–Ω—Ç –¥–æ–±–∞–≤–∏—Ç: –∫–æ–º–ø–æ–∑–∏—Ü–∏—é, —Ñ–æ–Ω, –∫–∞—á–µ—Å—Ç–≤–æ, –∑–∞–ø—Ä–µ—Ç –Ω–∞ –±–æ—Ä–¥–µ—Ä –∏ —Ç.–¥.

–ü—Ä–∏–º–µ—Ä:
```
userText = "Anime style, big expressive eyes, clean lines, vibrant colors, laughing hysterically, holding belly, tears of joy"
    ‚Üì
generatePrompt(userText)
    ‚Üì
promptFinal = "Create a high-quality character illustration. Style: Anime with big expressive eyes...
Subject: Analyze the provided photo. If ONE person ‚Äî use their face...
Composition: Head, shoulders visible with generous padding...
Background: Flat uniform single color...
..."
```

**Fallback**: –µ—Å–ª–∏ `generatePrompt` —É–ø–∞–ª ‚Äî `buildAssistantPrompt` –∫–∞–∫ —à–∞–±–ª–æ–Ω.

## –§–æ—Ä–º–∞—Ç –∏–¥–µ–∏

–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `StickerIdea` (—Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç —á—Ç–æ –≤ pack_ideas):
```typescript
interface StickerIdea {
  emoji: string;
  titleRu: string;
  titleEn: string;
  descriptionRu: string;
  descriptionEn: string;
  promptModification: string;
  hasText: boolean;
  textSuggestion: string | null;
  textPlacement: string | null;
  category: string;
}
```

## UI: –∫–∞—Ä—Ç–æ—á–∫–∞ –∏–¥–µ–∏

```
üí° –ò–¥–µ—è 1/8

üé® –°—Ç–∏–ª—å: üéå –ê–Ω–∏–º–µ
üòÇ –•–æ—Ö–æ—á–µ—Ç –¥–æ —Å–ª—ë–∑
–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–º–µ—ë—Ç—Å—è, –¥–µ—Ä–∂–∞—Å—å –∑–∞ –∂–∏–≤–æ—Ç

[üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)]
[üîÑ –î—Ä—É–≥–æ–π —Å—Ç–∏–ª—å ‚ñ∏] [‚û°Ô∏è –î—Ä—É–≥–∞—è –∏–¥–µ—è]
[‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è]
[‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å]
```

### –ö–Ω–æ–ø–∫–∏

| –ö–Ω–æ–ø–∫–∞ | Callback | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|----------|
| üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å | `asst_idea_gen:{idx}` | `prompt_hint + promptModification` ‚Üí `generatePrompt()` ‚Üí `startGeneration()` |
| üîÑ –î—Ä—É–≥–æ–π —Å—Ç–∏–ª—å | `asst_idea_style:{idx}` | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç inline-–∫–Ω–æ–ø–∫–∏ —Å–æ —Å—Ç–∏–ª—è–º–∏ (2-3 –≤ —Ä—è–¥) |
| ‚û°Ô∏è –î—Ä—É–≥–∞—è –∏–¥–µ—è | `asst_idea_next:{idx}` | –°–ª–µ–¥—É—é—â–∞—è –∏–¥–µ—è –∏–∑ —Å–ø–∏—Å–∫–∞ (circular) |
| ‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è | `asst_idea_custom` | –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç state ‚Üí `assistant_chat`, LLM-–¥–∏–∞–ª–æ–≥ |
| ‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å | `asst_idea_skip` | –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç state ‚Üí `assistant_chat`, –æ–±—ã—á–Ω—ã–π LLM-–¥–∏–∞–ª–æ–≥ |

### –ú–∏–Ω–∏-–∫–∞—Ä—É—Å–µ–ª—å —Å—Ç–∏–ª–µ–π (–ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–î—Ä—É–≥–æ–π —Å—Ç–∏–ª—å")

```
üé® –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å:

[üéå –ê–Ω–∏–º–µ] [üñåÔ∏è –ú—É–ª—å—Ç—Ñ–∏–ª—å–º] [üéÆ –ü–∏–∫—Å–µ–ª—å]
[‚úèÔ∏è –°–∫–µ—Ç—á] [üß∏ Chibi] [üíé 3D]
```

–ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ = `asst_idea_restyle:{styleId}:{ideaIdx}`.
–ü—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∏–ª—è **–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–∏–ª—å** ‚Äî –∏–¥–µ–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –∏–¥–µ—è —Å –Ω–æ–≤—ã–º —Å—Ç–∏–ª–µ–º. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ, –±–µ–∑ LLM-–≤—ã–∑–æ–≤–∞.

## –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–í `sessions` –Ω–æ–≤–æ–µ JSONB-–ø–æ–ª–µ `sticker_ideas_state`:
```json
{
  "styleId": "anime_v2",
  "ideaIndex": 0,
  "ideas": [/* –º–∞—Å—Å–∏–≤ StickerIdea –∏–∑ LLM */]
}
```

- `styleId` ‚Äî —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å
- `ideaIndex` ‚Äî —Ç–µ–∫—É—â–∞—è –ø–æ–∫–∞–∑–∞–Ω–Ω–∞—è –∏–¥–µ—è
- `ideas` ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ LLM –∏–¥–µ–∏ (8 —à—Ç)

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Ö—Ä–∞–Ω–∏—Ç—å –≤ `assistant_sessions` –≤ –ø–æ–ª–µ `goal` –∏–ª–∏ –Ω–æ–≤–æ–º JSONB-–ø–æ–ª–µ.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `generateStickerIdeasFromPhoto()`

–ê–Ω–∞–ª–æ–≥ `generatePackIdeas`, –Ω–æ:
- –ù–∞ –≤—Ö–æ–¥ ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ (–Ω–µ —Å—Ç–∏–∫–µ—Ä)
- –ü—Ä–æ–º–ø—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω: "analyze the person in the photo, suggest sticker ideas in style X"
- Fallback –Ω–∞ `getDefaultIdeas(lang)`

### 2. –•—ç–Ω–¥–ª–µ—Ä `assistant_wait_photo` (src/index.ts, ~—Å—Ç—Ä–æ–∫–∞ 2117)

–ó–∞–º–µ–Ω–∏—Ç—å –±–ª–æ–∫ "—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ ‚Üí callAIChat()" –Ω–∞:
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ, state ‚Üí `assistant_wait_idea`
- –í—ã–±—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∏–ª—å –∏–∑ `style_presets_v2`
- –ü–æ–∫–∞–∑–∞—Ç—å "‚è≥ –ü–æ–¥–±–∏—Ä–∞—é –∏–¥–µ–∏..."
- –í—ã–∑–≤–∞—Ç—å `generateStickerIdeasFromPhoto(photo, style)`
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–¥–µ–∏ –≤ `sticker_ideas_state`
- –ü–æ–∫–∞–∑–∞—Ç—å `showStickerIdeaCard()`

### 3. –ù–æ–≤—ã–π session state: `assistant_wait_idea`

–°–µ—Å—Å–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "—Ñ–æ—Ç–æ –µ—Å—Ç—å, –∂–¥—ë–º –≤—ã–±–æ—Ä –∏–¥–µ–∏/—Å—Ç–∏–ª—è".

### 4. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `showStickerIdeaCard()`

–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ + inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (—Å–º. UI –≤—ã—à–µ).

### 5. Callback handlers

- `asst_idea_gen:{idx}` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –∏–¥–µ–µ–π:
  ```
  userText = preset.prompt_hint + ", " + idea.promptModification
  promptResult = await generatePrompt(userText)
  ‚Üí startGeneration(ctx, user, session, lang, { generationType: "style", promptFinal, ... })
  ```
- `asst_idea_next:{idx}` ‚Äî —Å–ª–µ–¥—É—é—â–∞—è –∏–¥–µ—è (—Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å)
- `asst_idea_style:{idx}` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏-–∫–∞—Ä—É—Å–µ–ª—å —Å—Ç–∏–ª–µ–π
- `asst_idea_restyle:{styleId}:{idx}` ‚Äî —Å–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏
- `asst_idea_custom` ‚Äî state ‚Üí `assistant_chat`, LLM-–¥–∏–∞–ª–æ–≥
- `asst_idea_skip` ‚Äî state ‚Üí `assistant_chat`, LLM-–¥–∏–∞–ª–æ–≥

### 6. SQL-–º–∏–≥—Ä–∞—Ü–∏—è

```sql
ALTER TABLE sessions ADD COLUMN sticker_ideas_state jsonb DEFAULT NULL;
```

## –ß—Ç–æ –ù–ï –º–µ–Ω—è–µ—Ç—Å—è

- `worker.ts` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏–∫–µ—Ä–∞
- –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –§–∏—á–∞ "–ò–¥–µ–∏ –¥–ª—è –ø–∞–∫–∞" (–ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, `generatePackIdeas`) ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- `handleAssistantConfirm` / `buildAssistantPrompt` ‚Äî –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ fallback –¥–ª—è LLM-–¥–∏–∞–ª–æ–≥–∞
- –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (–∫–∞—Ä—É—Å–µ–ª—å —Å—Ç–∏–ª–µ–π –±–µ–∑ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
- `getDefaultIdeas()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback
