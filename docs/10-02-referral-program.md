# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

## –¶–µ–ª—å

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏–≥–ª–∞—à–∞—é—Ç –¥—Ä—É–∑–µ–π –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∞—é—Ç –±–æ–Ω—É—Å–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã. –≠—Ç–æ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –±–µ–∑ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.

---

## –ú–µ—Ö–∞–Ω–∏–∫–∞

1. –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É:
   ```
   https://t.me/Photo_2_StickerBot?start=ref_42269230
   ```
   –≥–¥–µ `42269230` ‚Äî telegram_id –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ

2. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí –±–æ—Ç –ø–∞—Ä—Å–∏—Ç `ref_{telegram_id}` –∏–∑ payload ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `referred_by` –∏ `referred_at` –≤ —Ç–∞–±–ª–∏—Ü—É users.

3. –í —Ç–µ—á–µ–Ω–∏–µ 30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π —Å `referred_at` –ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è 50% –æ—Ç —Å—É–º–º—ã —ç—Ç–æ–π –æ–ø–ª–∞—Ç—ã.

---

## –ú–æ–¥–µ–ª—å –Ω–∞–≥—Ä–∞–¥: 50% —Å –æ–ø–ª–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π

- **–û–∫–Ω–æ:** 30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–µ—Ä–µ—à—ë–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ (—Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–∞—Ç—É –ø—Ä–∏–≤—è–∑–∫–∏ `referred_by`).
- **–£—Å–ª–æ–≤–∏–µ:** –ø—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π –ø–æ–ª—É—á–∞–µ—Ç **50% –æ—Ç –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç—ã** –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ, —Å–æ–≤–µ—Ä—à—ë–Ω–Ω–æ–π –≤ —Ç–µ—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –æ–∫–Ω–∞.
- **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ:** 50% –æ—Ç —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä—É ‚Äî –≤ –∫—Ä–µ–¥–∏—Ç–∞—Ö –ø–æ —Ç–µ–∫—É—â–µ–º—É —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É (–∏–ª–∏ –≤ —Ä—É–±–ª—è—Ö, —Å–º. —Å—Ö–µ–º—É –¥–∞–Ω–Ω—ã—Ö).

| –°–æ–±—ã—Ç–∏–µ | –ü—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π –ø–æ–ª—É—á–∞–µ—Ç | –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–æ–ª—É—á–∞–µ—Ç |
|---------|----------------------|-----------------------|
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ. —Å—Å—ã–ª–∫–µ | ‚Äî | –æ–±—ã—á–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ |
| –õ—é–±–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π | 50% –æ—Ç —Å—É–º–º—ã —ç—Ç–æ–π –æ–ø–ª–∞—Ç—ã | –¥–æ—Å—Ç—É–ø –∫ –∫—É–ø–ª–µ–Ω–Ω–æ–º—É |

**–ü—Ä–∏–º–µ—Ä:** –¥—Ä—É–≥ –æ–ø–ª–∞—Ç–∏–ª –ø–∞–∫–µ—Ç –Ω–∞ 200 ‚ÇΩ –Ω–∞ 5-–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí —Ä–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç 100 ‚ÇΩ (–∏–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ –∫—Ä–µ–¥–∏—Ç–∞—Ö). –û–ø–ª–∞—Ç–∞ –Ω–∞ 31-–π –¥–µ–Ω—å –≤ –æ–∫–Ω–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç.

---

## –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `users`

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS referred_by UUID REFERENCES users(id);
ALTER TABLE users ADD COLUMN IF NOT EXISTS referred_at TIMESTAMPTZ; -- –º–æ–º–µ–Ω—Ç –ø—Ä–∏–≤—è–∑–∫–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (—Å—Ç–∞—Ä—Ç –ø–æ ref-—Å—Å—ã–ª–∫–µ)
ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_earnings INT DEFAULT 0; -- —Å—É–º–º–∞—Ä–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ (–≤ –∫–æ–ø–µ–π–∫–∞—Ö –∏–ª–∏ –≤ –∫—Ä–µ–¥–∏—Ç–∞—Ö ‚Äî –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
```

`referred_at` –Ω—É–∂–Ω–∞, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–∫–Ω–æ ¬´30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π¬ª –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç—ã –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ.

### –¢–∞–±–ª–∏—Ü–∞ `referral_rewards` (–ª–æ–≥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π 50% —Å –æ–ø–ª–∞—Ç)

```sql
CREATE TABLE referral_rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID NOT NULL REFERENCES users(id),
  referred_id UUID NOT NULL REFERENCES users(id),
  reward_type TEXT NOT NULL, -- 'payment_share'
  payment_id UUID, -- —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞—Ç—ë–∂ (payments –∏–ª–∏ –≤–Ω–µ—à–Ω—è—è —Å–∏—Å—Ç–µ–º–∞)
  amount_cents INT NOT NULL, -- 50% –æ—Ç –æ–ø–ª–∞—Ç—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  credits_awarded INT, -- —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ –∫—Ä–µ–¥–∏—Ç–∞—Ö (–µ—Å–ª–∏ –Ω–∞—á–∏—Å–ª—è–µ–º –∫—Ä–µ–¥–∏—Ç–∞–º–∏)
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_referral_rewards_referrer ON referral_rewards(referrer_id);
CREATE INDEX idx_referral_rewards_referred ON referral_rewards(referred_id);
CREATE INDEX idx_referral_rewards_created ON referral_rewards(created_at);
```

–ü—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º `referred_at + 30 days >= now()`, –µ—Å–ª–∏ –æ–∫ ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ `referral_rewards`, –Ω–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä—É.

---

## UX –≤ –±–æ—Ç–µ

### –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É

–ö–Ω–æ–ø–∫–∞ "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞" –≤ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/referral`.

–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
```
üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏ 50% —Å –µ–≥–æ –æ–ø–ª–∞—Ç!

–¢–≤–æ—è —Å—Å—ã–ª–∫–∞:
https://t.me/Photo_2_StickerBot?start=ref_42269230

–ú—ã –¥–µ–ª–∏–º—Å—è —Å —Ç–æ–±–æ–π 50% –æ—Ç –≤—Å–µ—Ö –æ–ø–ª–∞—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ.

üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 5 –¥—Ä—É–∑–µ–π
–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 450 ‚ÇΩ (–∏–ª–∏ N –∫—Ä–µ–¥–∏—Ç–æ–≤)
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:**
- –ü—Ä–∏–≥–ª–∞—à–∞—é—â–µ–º—É: "üéâ –í–∞—à –¥—Ä—É–≥ @username –ø–µ—Ä–µ—à—ë–ª –ø–æ —Å—Å—ã–ª–∫–µ! –í—ã –ø–æ–ª—É—á–∏—Ç–µ 50% —Å –µ–≥–æ –æ–ø–ª–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π."
- –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–º—É: –æ–±—ã—á–Ω—ã–π onboarding

**–ü—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –¥–Ω–µ–π:**
- –ü—Ä–∏–≥–ª–∞—à–∞—é—â–µ–º—É: "üí∞ –í–∞—à –¥—Ä—É–≥ @username –æ–ø–ª–∞—Ç–∏–ª –ø–æ–∫—É–ø–∫—É. –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 50%: +X ‚ÇΩ (–∏–ª–∏ N –∫—Ä–µ–¥–∏—Ç–æ–≤)"

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UTM

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π payload `ref_{telegram_id}` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `parseStartPayload()`:
- `source` = `"ref"`
- `medium` = `null`
- `campaign` = `"{telegram_id}"`

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –≤ –æ–±—â–µ–π UTM-–∞–Ω–∞–ª–∏—Ç–∏–∫–µ.

---

## –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–∞

- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä (–Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å `referred_by`)
- –†–µ—Ñ–µ—Ä–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–Ω–æ–≤—ã–º** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (existing users –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- –°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –∑–∞–ø—Ä–µ—â—ë–Ω (`referrer.telegram_id !== new_user.telegram_id`)
- –ú–∞–∫—Å–∏–º—É–º 50 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 50% ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞ –æ–ø–ª–∞—Ç—ã, –¥–∞—Ç–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–∫–Ω–æ `[referred_at, referred_at + 30 days]` –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–ø–ª–∞—Ç—ã

---

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
```sql
SELECT
  u.username,
  u.telegram_id,
  u.referral_count,
  u.referral_earnings
FROM users u
WHERE u.referral_count > 0
ORDER BY u.referral_count DESC
LIMIT 20;
```

### –ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```sql
SELECT
  COUNT(*) as total_referred,
  COUNT(*) FILTER (WHERE has_purchased) as paid_referred,
  ROUND(100.0 * COUNT(*) FILTER (WHERE has_purchased) / NULLIF(COUNT(*), 0), 1) as conversion_pct
FROM users
WHERE referred_by IS NOT NULL;
```

### –õ–æ–≥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π (50% —Å –æ–ø–ª–∞—Ç)
```sql
SELECT
  rr.reward_type,
  COUNT(*) as count,
  SUM(rr.amount_cents) / 100.0 as total_amount_rub,
  SUM(rr.credits_awarded) as total_credits
FROM referral_rewards rr
WHERE rr.created_at > now() - interval '30 days'
GROUP BY rr.reward_type;
```

---

## –ß–µ–∫–ª–∏—Å—Ç

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –∫–æ–ª–æ–Ω–∫–∏ `referred_by`, `referred_at`, `referral_count`, `referral_earnings` –≤ users
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: —Ç–∞–±–ª–∏—Ü–∞ `referral_rewards` (reward_type `payment_share`, amount_cents, payment_id)
- [ ] –ü–∞—Ä—Å–∏–Ω–≥ `ref_{telegram_id}` –≤ `parseStartPayload()`
- [ ] –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ –ø–æ ref-—Å—Å—ã–ª–∫–µ: –∑–∞–ø–∏—Å—å `referred_by` –∏ `referred_at` –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ: –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫ ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª –∏ –æ–ø–ª–∞—Ç–∞ –≤ –æ–∫–Ω–µ 30 –¥–Ω–µ–π –æ—Ç `referred_at`
- [ ] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 50% –æ—Ç —Å—É–º–º—ã –æ–ø–ª–∞—Ç—ã —Ä–µ—Ñ–µ—Ä–µ—Ä—É (–∑–∞–ø–∏—Å—å –≤ `referral_rewards`, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `referral_earnings`)
- [ ] –ö–æ–º–∞–Ω–¥–∞ `/referral` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–∑–∞—Ä–∞–±–æ—Ç–æ–∫ –≤ ‚ÇΩ –∏–ª–∏ –∫—Ä–µ–¥–∏—Ç–∞—Ö)
- [ ] –ö–Ω–æ–ø–∫–∞ "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞" –≤ –º–µ–Ω—é
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –≤ –æ–∫–Ω–µ 30 –¥–Ω–µ–π
- [ ] –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–∞ (–æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä, –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–µ —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª, –æ–∫–Ω–æ 30 –¥–Ω–µ–π)
