# Feedback Survey (–æ—Ç–¥–µ–ª—å–Ω—ã–π Support –±–æ—Ç)

## –¶–µ–ª—å
–ü–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞ –æ—Ç –ø–æ–∫—É–ø–∫–∏ —á–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ–ø—Ä–æ—Å, –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  photo2sticker  ‚îÇ     ‚îÇ     Worker      ‚îÇ     ‚îÇ  p2s_support    ‚îÇ
‚îÇ   (–æ—Å–Ω–æ–≤–Ω–æ–π)    ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ   (feedback)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ              UPDATE feedback_trigger_at       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
         ‚îÇ                                               ‚îÇ
         ‚îÇ                              cron: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
         ‚îÇ                              text: –ø—Ä–∏—ë–º –æ—Ç–≤–µ—Ç–æ–≤
         ‚îÇ                              reply: –æ—Ç–≤–µ—Ç—ã –∞–¥–º–∏–Ω–∞
         ‚îÇ                                               ‚îÇ
         ‚îÇ                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                                    ‚îÇ   Support Channel   ‚îÇ
         ‚îÇ                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–∞–Ω–∞–ª—ã

| –ö–∞–Ω–∞–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| **Alert Channel** | –û—à–∏–±–∫–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã, –±–∏–∑–Ω–µ—Å-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ |
| **Support Channel** | –§–∏–¥–±–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–∏–∞–ª–æ–≥–∏ |

## –¢—Ä–∏–≥–≥–µ—Ä

**–£—Å–ª–æ–≤–∏—è:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (–ø–µ—Ä–≤—ã–π —Å—Ç–∏–∫–µ—Ä)
2. –ü—Ä–æ—à–ª–æ **15 –º–∏–Ω—É—Ç**
3. –ë–∞–ª–∞–Ω—Å = **0 –∫—Ä–µ–¥–∏—Ç–æ–≤**
4. –û–ø—Ä–æ—Å **–µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è**

## –í–æ–ø—Ä–æ—Å (–æ—Ç p2s_support –±–æ—Ç–∞)

```
üëã –ü—Ä–∏–≤–µ—Ç! –í—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∏–∫–µ—Ä –≤ @photo2sticker_bot.

–ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç? –ß—Ç–æ –ø–æ–º–µ—à–∞–ª–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?

–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ ‚Äî –º—ã —á–∏—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç üôè
```

## –ê–ª–µ—Ä—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ (Support Channel)

```
üìù –§–∏–¥–±–µ–∫

üë§ @ivan (42269230)
üí¨ "–¥–æ—Ä–æ–≥–æ, —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –¥–µ—à–µ–≤–ª–µ"

[üì© –û—Ç–≤–µ—Ç–∏—Ç—å]
```

–ö–Ω–æ–ø–∫–∞ ‚Üí `https://t.me/p2s_support_bot?start=reply_42269230`

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏—è

```sql
-- –ü–æ–ª–µ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –≤ users
ALTER TABLE users ADD COLUMN feedback_trigger_at timestamptz;

-- –¢–∞–±–ª–∏—Ü–∞ feedback
CREATE TABLE user_feedback (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) UNIQUE,
  telegram_id bigint NOT NULL,
  username text,
  question_sent_at timestamptz DEFAULT now(),
  answer_text text,
  answer_at timestamptz,
  admin_reply_text text,
  admin_reply_at timestamptz,
  created_at timestamptz DEFAULT now()
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è cron-–∑–∞–ø—Ä–æ—Å–∞
CREATE INDEX users_feedback_trigger_idx 
  ON users(feedback_trigger_at) 
  WHERE feedback_trigger_at IS NOT NULL;
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
ALERT_CHANNEL_ID=-100xxx      # –æ—à–∏–±–∫–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã

# –ù–æ–≤—ã–µ
SUPPORT_BOT_TOKEN=xxx         # —Ç–æ–∫–µ–Ω @p2s_support_bot
SUPPORT_CHANNEL_ID=-100yyy    # —Ñ–∏–¥–±–µ–∫, –¥–∏–∞–ª–æ–≥–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. worker.ts ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞, fire-and-forget
if (user.credits === 0 && !user.feedback_trigger_at) {
  supabase.from("users")
    .update({ feedback_trigger_at: new Date().toISOString() })
    .eq("id", user.id)
    .then(() => console.log("Feedback trigger set"))
    .catch(console.error);
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–ª–æ—É:** –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (1 UPDATE –±–µ–∑ await)

### 2. support-bot.ts ‚Äî –Ω–æ–≤—ã–π —Ñ–∞–π–ª

```typescript
import { Telegraf } from "telegraf";
import { supabase } from "./lib/supabase";
import { config } from "./config";

const bot = new Telegraf(config.supportBotToken);
const ADMIN_IDS = [42269230]; // telegram_id –∞–¥–º–∏–Ω–æ–≤

// –°–æ—Å—Ç–æ—è–Ω–∏–µ reply –≤ –ø–∞–º—è—Ç–∏
const pendingReplies = new Map<number, number>(); // admin_id -> target_user_id

// /start handler
bot.start(async (ctx) => {
  const payload = ctx.startPayload;
  
  // –ê–¥–º–∏–Ω —Ö–æ—á–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å
  if (payload?.startsWith("reply_") && ADMIN_IDS.includes(ctx.from.id)) {
    const targetId = parseInt(payload.replace("reply_", ""));
    pendingReplies.set(ctx.from.id, targetId);
    
    const { data: feedback } = await supabase
      .from("user_feedback")
      .select("username, answer_text")
      .eq("telegram_id", targetId)
      .maybeSingle();
    
    await ctx.reply(
      `–û—Ç–≤–µ—á–∞–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @${feedback?.username || targetId}\n` +
      `–ï–≥–æ –æ—Ç–≤–µ—Ç: "${feedback?.answer_text}"\n\n` +
      `–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç:`
    );
    return;
  }
  
  await ctx.reply("–≠—Ç–æ –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ photo2sticker. –û–∂–∏–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –Ω–∞—Å!");
});

// Text handler
bot.on("text", async (ctx) => {
  const oderId = ctx.from.id;
  
  // –ê–¥–º–∏–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  if (ADMIN_IDS.includes(userId) && pendingReplies.has(userId)) {
    const targetId = pendingReplies.get(userId)!;
    pendingReplies.delete(userId);
    
    await bot.telegram.sendMessage(targetId, ctx.message.text);
    
    await supabase.from("user_feedback")
      .update({ 
        admin_reply_text: ctx.message.text,
        admin_reply_at: new Date().toISOString()
      })
      .eq("telegram_id", targetId);
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Support Channel
    await sendToSupportChannel(
      `‚úÖ *–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω*\n\n` +
      `üë§ –ö–æ–º—É: @${ctx.from.username || targetId} (${targetId})\n` +
      `üí¨ "${ctx.message.text}"`
    );
    
    await ctx.reply("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
    return;
  }
  
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ feedback
  const { data: feedback } = await supabase
    .from("user_feedback")
    .select("*")
    .eq("telegram_id", userId)
    .is("answer_text", null)
    .maybeSingle();
  
  if (feedback) {
    await supabase.from("user_feedback")
      .update({ 
        answer_text: ctx.message.text,
        answer_at: new Date().toISOString()
      })
      .eq("id", feedback.id);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç –≤ Support Channel
    await sendFeedbackAlert(ctx.from, ctx.message.text);
    
    await ctx.reply("–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç! üôè");
    return;
  }
  
  await ctx.reply("–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è.");
});

// Cron: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
async function sendFeedbackQuestions() {
  const { data: users } = await supabase
    .from("users")
    .select("id, telegram_id, username, feedback_trigger_at, credits")
    .not("feedback_trigger_at", "is", null)
    .lt("feedback_trigger_at", new Date(Date.now() - 15 * 60 * 1000).toISOString())
    .eq("credits", 0)
    .limit(10);
  
  if (!users?.length) return;
  
  for (const user of users) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ feedback –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è
    const { data: existing } = await supabase
      .from("user_feedback")
      .select("id")
      .eq("user_id", user.id)
      .maybeSingle();
    
    if (existing) continue;
    
    try {
      await bot.telegram.sendMessage(user.telegram_id,
        "üëã –ü—Ä–∏–≤–µ—Ç! –í—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∏–∫–µ—Ä –≤ @photo2sticker_bot.\n\n" +
        "–ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç? –ß—Ç–æ –ø–æ–º–µ—à–∞–ª–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?\n\n" +
        "–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ ‚Äî –º—ã —á–∏—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç üôè"
      );
      
      await supabase.from("user_feedback").insert({
        user_id: user.id,
        telegram_id: user.telegram_id,
        username: user.username,
      });
      
      console.log(`Feedback question sent to ${user.telegram_id}`);
    } catch (err) {
      console.error(`Failed to send feedback to ${user.telegram_id}:`, err);
    }
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Support Channel
async function sendToSupportChannel(text: string) {
  const channelId = config.supportChannelId;
  if (!channelId) return;
  
  await fetch(`https://api.telegram.org/bot${config.supportBotToken}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: channelId,
      text,
      parse_mode: "Markdown",
    })
  });
}

// –ê–ª–µ—Ä—Ç —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–≤–µ—Ç–∞
async function sendFeedbackAlert(from: any, text: string) {
  const channelId = config.supportChannelId;
  if (!channelId) return;
  
  const message = 
    `üìù *–§–∏–¥–±–µ–∫*\n\n` +
    `üë§ @${from.username || from.id} (${from.id})\n` +
    `üí¨ "${text}"`;
  
  await fetch(`https://api.telegram.org/bot${config.supportBotToken}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: channelId,
      text: message,
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: [[
          { text: "üì© –û—Ç–≤–µ—Ç–∏—Ç—å", url: `https://t.me/p2s_support_bot?start=reply_${from.id}` }
        ]]
      }
    })
  });
}

// –ó–∞–ø—É—Å–∫
bot.launch();
setInterval(sendFeedbackQuestions, 60 * 1000);

console.log("Support bot started");
```

### 3. config.ts ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã

```typescript
export const config = {
  // ...existing
  supportBotToken: process.env.SUPPORT_BOT_TOKEN || "",
  supportChannelId: process.env.SUPPORT_CHANNEL_ID || "",
};
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –†–∏—Å–∫ |
|------|-----------|------|
| worker.ts | +5 —Å—Ç—Ä–æ–∫ (UPDATE trigger) | ‚úÖ –ù—É–ª–µ–≤–æ–π |
| config.ts | +2 —Å—Ç—Ä–æ–∫–∏ | ‚úÖ –ù—É–ª–µ–≤–æ–π |
| index.ts | ‚ùå –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π | ‚úÖ –ù—É–ª–µ–≤–æ–π |

## Checklist

- [ ] –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞ @p2s_support_bot –≤ BotFather
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª "P2S Support"
- [ ] –î–æ–±–∞–≤–∏—Ç—å @p2s_support_bot –∫–∞–∫ –∞–¥–º–∏–Ω–∞ –≤ –∫–∞–Ω–∞–ª
- [ ] –î–æ–±–∞–≤–∏—Ç—å SUPPORT_BOT_TOKEN –≤ env
- [ ] –î–æ–±–∞–≤–∏—Ç—å SUPPORT_CHANNEL_ID –≤ env
- [ ] –î–æ–±–∞–≤–∏—Ç—å ADMIN_IDS –≤ env (—Ç–≤–æ–π telegram_id)
- [x] SQL –º–∏–≥—Ä–∞—Ü–∏—è (feedback_trigger_at + user_feedback) ‚Üí `sql/022_feedback.sql`
- [x] –û–±–Ω–æ–≤–∏—Ç—å worker.ts (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞)
- [x] –°–æ–∑–¥–∞—Ç—å support-bot.ts
- [x] –û–±–Ω–æ–≤–∏—Ç—å config.ts
- [x] –°–æ–∑–¥–∞—Ç—å Dockerfile.support
- [ ] –î–µ–ø–ª–æ–π support –±–æ—Ç–∞
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
