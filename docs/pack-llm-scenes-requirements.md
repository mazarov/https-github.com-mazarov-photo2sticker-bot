# Требования: сцены/подписи для паков через LLM

**Область:** только для паков (flow «Сделать пак»). На единичные стикеры не распространяется.

---

## Идея

Сюжеты и подписи для ячеек пака не брать из БД (`pack_templates.scene_descriptions`, `labels`), а генерировать через LLM по фото пользователя — чтобы сцены и эмоции были актуальны для этого фото и уже отражались на превью сетки.

---

## Требования

1. **Момент генерации**  
   Сцены/эмоции генерируются **до** генерации превью пака (до джобы `pack_preview`), по фото пользователя.

2. **Вход**  
   Одно фото пользователя (`session.current_photo_file_id`).

3. **Выход LLM**  
   Массив из N коротких описаний сцен/эмоций (N = число стикеров в шаблоне, например 4 или 16), релевантных фото.  
   Примеры: «romantic, hugging tenderly», «blowing a kiss», «sleeping together», «eating together» — или короткие подписи «Моя», «Люблю», «Спим?», «Вкусно?» в зависимости от выбранного формата.

4. **Использование при генерации превью**  
   Эти сцены подставляются в промпт пака (в блок сцен в `[TASK — PACK GRID ONLY]`) вместо `template.scene_descriptions`.  
   Воркер читает кастомные сцены из сессии или из `pack_batches` (новое поле) и строит `sceneList` из них; иначе fallback на `template.scene_descriptions`.

5. **Подписи под стикерами**  
   Те же тексты (или их короткие варианты от LLM) используются как подписи при сборке пака (labels над/под стикерами).

6. **Хранение**  
   Результат вызова LLM сохранять в сессии или в `pack_batches` (например, `custom_scene_descriptions` / `custom_labels`), чтобы воркер превью и этап сборки пака могли их прочитать.

7. **Fallback**  
   Если LLM не вызван или ответ не прошёл валидацию — использовать текущую логику: `template.scene_descriptions` и `template.labels` из БД.

8. **Ограничения**  
   - Длина подписей (например, до 15–20 символов для лейблов).  
   - Модерация/фильтр на неуместный контент.  
   - Язык и тон согласованы с шаблоном/локалью.

---

## Текущее состояние (справка)

- Сцены для сетки: `pack_templates.scene_descriptions` (jsonb), подставляются в воркере в `packTaskBlock` (`src/worker.ts`).
- Подписи: `pack_templates.labels` / `labels_en`, используются при сборке пака.
- Оплата превью: `pack_preview_pay` в `src/index.ts` — место, где перед постановкой джобы `pack_preview` можно вызвать LLM по `session.current_photo_file_id` и сохранить результат в сессию/батч.

---

*Документ только для паков; единичные стикеры и ассистент не затрагиваются.*
