# Карусель эмоций: примеры поверх блоков и сохранение примеров

**Дата:** 27.02.2026  
**Формат:** требования (docs)  
**Контекст:** Сейчас карусель эмоций (`sendEmotionKeyboard`) — только кнопки с emoji и названием. Нужно показывать картинку-пример эмоции поверх блоков, хранить примеры в Storage и дать админам возможность сохранять сгенерированный стикер как пример для эмоции.

---

## 1. Требования

### 1.1. Картинка-пример эмоции поверх карусели

- **Карусель не меняем:** те же кнопки (те же ряды, те же callback_data), как сейчас.
- **Одно сообщение:** поверх карусели показывается **одно** фото-пример + под ним та же карусель кнопок. В Telegram одно сообщение может содержать: одно фото + caption + reply_markup (inline keyboard). Так и делаем: **одно сообщение = одно фото (пример) сверху + подпись (текст «Выбери эмоцию») + та же inline-клавиатура с кнопками эмоций.**
- **Какое фото показывать:** берём первый пресет эмоции по `sort_order`, у которого в Storage есть пример (файл по пути примера этой эмоции). Его пример и показываем сверху. Если ни у одного пресета нет примера в Storage — отправляем сообщение **без фото**: только текст + клавиатура (текущее поведение).
- Итог: пользователь видит один пример эмоции сверху и сразу под ним всю карусель выбора; карусель не трогаем.

### 1.2. Хранение примеров эмоций в Storage

- Для каждой эмоции в **Storage** лежит **свой** пример — один файл на пресет эмоции.
- Примеры должны быть на основе **реалистичного стиля** (фото): чтобы в карусели пользователь видел «как это выглядит» в реалистичной манере.
- **Путь в Storage:** единый бакет (например `stickers-examples`) и папка `emotion-examples/`. Путь к файлу: `emotion-examples/{emotion_preset_id}.webp`. Если файла по этому пути нет — считаем, что примера у эмоции нет; в сообщении карусели тогда фото не прикладываем (см. п. 1.1).

### 1.3. Кнопка «Сохранить пример для эмоции» в алертах после генерации пака (batch)

- **Когда:** в алертах, которые отправляются **после генерации пака** — когда создаётся сразу 9 стикеров (batch flow: превью пака → оплата/подтверждение → сборка). **Не** для одиночного флоу (смена эмоции по одному стикеру).
- **Что:** в таком алерте (фото результата пака в админ-канал) добавляется кнопка: **«Сохранить пример для эмоции»** (или аналог: «Сделать примером эмоции»). Уточнение: для какого именно стикера из 9 и с каким `emotion_preset_id` — задаётся в реализации (например, первый стикер + выбор эмоции админом или одна кнопка на пресет).
- **Поведение по нажатию:** по callback сохраняем изображение из алерта в Storage по пути примера этой эмоции (см. п. 1.2) и при необходимости обновляем ссылку в БД (если храним путь в `emotion_presets`). После этого при следующем открытии карусели этот пример может отображаться сверху (если эта эмоция станет «первой с примером» по sort_order, см. п. 1.1).

---

## 2. Детальная реализация и встраивание в текущий код

### 2.1. Storage и БД

- **Бакет:** тот же, что для примеров стилей — `config.supabaseStorageBucketExamples` (`stickers-examples`). Публичный.
- **Путь к файлу примера эмоции:** `emotion-examples/{emotion_preset_id}.webp`. Проверка наличия: `supabase.storage.from(bucket).list('emotion-examples')` или попытка `download('emotion-examples/{id}.webp')` и проверка на ошибку 404; либо колонка в БД (см. ниже).
- **БД:** колонку в `emotion_presets` не вводим — наличие примера определяем по наличию файла в Storage по конвенции пути. При желании позже можно добавить `example_storage_path` для кэширования.

### 2.2. Карусель эмоций — куда встраивать

**Файл:** `src/index.ts`. **Функция:** `sendEmotionKeyboard` (вызывается из хендлеров `change_emotion`, `change_emotion:ID`, onboarding и т.д.).

**Текущее поведение:** один вызов `ctx.reply(getText(lang, "emotion.choose"), Markup.inlineKeyboard(buttons))` — только текст и кнопки.

**Новое поведение (пошагово):**

1. Как сейчас: получить `presets` через `getEmotionPresets()` (уже по `sort_order`), собрать `buttons` — **логику кнопок не менять**.
2. **Проверка примеров:** в цикле по `presets` (порядок уже по `sort_order`) проверить для каждого пресета наличие файла в Storage: путь `emotion-examples/${preset.id}.webp` в бакете `config.supabaseStorageBucketExamples`. Проверка: `storage.from(bucket).download(path)` или `list` по префиксу — при успехе без 404 считаем, что пример есть. Найти **первый** пресет с существующим файлом.
3. **URL для фото:** если такой пресет найден — получить публичный URL: `supabase.storage.from(config.supabaseStorageBucketExamples).getPublicUrl('emotion-examples/' + preset.id + '.webp').data.publicUrl`.
4. **Отправка:**
   - Если URL есть: `ctx.replyWithPhoto(photoUrl, { caption: await getText(lang, "emotion.choose"), reply_markup: { inline_keyboard: ... } })`. Клавиатуру собрать из тех же `buttons` в формате Telegram (массив рядов, каждый ряд — массив `{ text, callback_data }`).
   - Если ни у одного пресета нет примера: оставить текущий вызов `ctx.reply(..., Markup.inlineKeyboard(buttons))` (без фото).

**Важно:** Telegram принимает в `replyWithPhoto` либо `file_id`, либо URL. Публичный бакет Supabase отдаёт URL — используем его.

### 2.3. Алерт после генерации пака (batch, 9 стикеров) — куда встраивать

**Контекст:** кнопка «Сохранить пример для эмоции» нужна **только в batch flow** (когда генерируется пак из 9 стикеров). Для одиночного флоу (смена эмоции по одному стикеру) такой алерт **не** отправляем.

**Сейчас:** после сборки пака воркер вызывает `sendAlert({ type: "pack_completed" / "pack_partial", ... })` и опционально `sendPackCompletedLandingAlert(batchId, stickerBuffers[0], ...)` (`src/worker.ts`, runPackAssembleJob). Есть превью пака (pack preview) с кнопкой «Сделать примером» для стиля.

**Нужно:** в алерте после генерации пака (например, рядом с `sendPackCompletedLandingAlert` или в отдельном сообщении с одним из стикеров пака) добавить сообщение с **фото** (один из стикеров пака или превью) и кнопкой «Сохранить пример для эмоции». Привязка к `emotion_preset_id`: на усмотрение реализации (например, одна кнопка на каждую эмоцию с callback `emotion_make_example:${emotionId}` и один выбранный стикер; или один стикер и одна кнопка с выбором эмоции в callback).

**Вариант встраивания:**

- В **worker** в `runPackAssembleJob` после успешной сборки пака (когда есть `stickerBuffers`): вызвать из `src/lib/alerts.ts` функцию `sendEmotionExampleAlert(emotionId, imageBuffer, details?)` — передать, например, первый буфер стикера и один выбранный `emotionId` (из контент-сета/метаданных пака или константа для «первая эмоция»). Либо реализовать `sendPackEmotionExampleAlert(batchId, stickerBuffers, emotionPresetIds?)` с несколькими кнопками.
- В **alerts.ts** функция `sendEmotionExampleAlert` уже есть: фото + caption + кнопка `emotion_make_example:${emotionId}`. Использовать её из batch flow, передав буфер одного из стикеров пака и нужный `emotionId`.

### 2.4. Обработка callback «Сохранить пример для эмоции»

**Где:** основной бот (`src/index.ts`), т.к. алерты шлёт он и кнопка в его чате. По аналогии с `pack_make_example` и `make_example`.

**Новый хендлер:** `bot.action(/^emotion_make_example:(.+)$/, async (ctx) => { ... })`.

**Логика:**

1. `safeAnswerCbQuery(ctx)`. Проверка админа: `ctx.from?.id` в `config.adminIds`; иначе выйти.
2. Из `ctx.match[1]` взять `emotionPresetId`.
3. Получить фото из сообщения, на котором висит кнопка: `const msg = ctx.callbackQuery?.message; const photo = msg?.photo;` — массив размеров. Взять `file_id` у последнего (наибольший размер): `photo[photo.length - 1].file_id`.
4. Скачать файл по `file_id` через Telegram API (`getFile` → `download` по `file_path`), получить буфер.
5. Загрузить буфер в Storage: бакет `config.supabaseStorageBucketExamples`, путь `emotion-examples/${emotionPresetId}.webp`, `contentType: 'image/webp'`, `upsert: true`.
6. Очистить кэш пресетов эмоций: в `index.ts` сбросить `emotionPresetsCache = null` (или вызвать существующую функцию сброса, если есть), чтобы при следующем открытии карусели `getEmotionPresets` подтянул свежие данные, а проверка наличия примера в Storage уже увидела новый файл.
7. Редактировать подпись сообщения в алерте: `ctx.editMessageCaption('✅ Сохранено как пример для эмоции "' + emotionPresetId + '"').catch(() => {})`.

**Важно:** в сообщении алерта должно быть фото (как у `pack_make_example`), чтобы из `msg.photo` взять `file_id`. Поэтому алерт для эмоции должен отправлять именно сообщение с фото и кнопкой, а не отдельное текстовое сообщение с кнопкой.

### 2.5. Кэш пресетов эмоций

- Сейчас: `emotionPresetsCache` в `index.ts`, TTL 5 минут. При сохранении нового примера эмоции через callback нужно сбросить кэш: присвоить `emotionPresetsCache = null`. Тогда при следующем вызове `sendEmotionKeyboard` пресеты запросятся заново из БД; проверка «есть ли пример в Storage» делается в момент отправки карусели и увидит новый файл.

### 2.6. Сводка: где что менять

| Что | Файл | Действие |
|-----|------|----------|
| Показ примера поверх карусели | `src/index.ts` | В `sendEmotionKeyboard`: до `ctx.reply` проверить Storage на первый пресет с файлом `emotion-examples/{id}.webp`; если есть — `ctx.replyWithPhoto(publicUrl, { caption, reply_markup })`, иначе оставить текущий `ctx.reply`. |
| Алерт с кнопкой «Сохранить пример для эмоции» | `src/lib/alerts.ts` | Новая функция `sendEmotionExampleAlert(emotionId, imageBuffer, details?)` — фото + caption + кнопка `emotion_make_example:${emotionId}`. |
| Вызов алерта после генерации пака (batch) | `src/worker.ts` | В `runPackAssembleJob` после сборки пака: вызвать `sendEmotionExampleAlert(emotionId, stickerBuffer, { user: ... })` с одним из буферов стикеров пака и выбранным `emotionId`. Для одиночного флоу (смена эмоции) этот алерт **не** вызывать. |
| Обработка нажатия кнопки | `src/index.ts` | Новый хендлер `bot.action(/^emotion_make_example:(.+)$/, ...)`: админ, взять file_id из сообщения, скачать фото из Telegram, загрузить в Storage `emotion-examples/${emotionId}.webp`, обнулить `emotionPresetsCache`, отредактировать caption. |
| Проверка «есть ли пример» | `src/index.ts` или хелпер | В `sendEmotionKeyboard` при формировании карусели: для пресетов по порядку проверять наличие файла в Storage (например `download` или `list`) и взять первый с существующим файлом. |

---

## 3. Критерии приёмки

- [ ] Карусель эмоций — одно сообщение: сверху одно фото-пример (первый пресет по sort_order с примером в Storage), снизу та же inline-клавиатура кнопок; карусель кнопок не меняется.
- [ ] Для каждой эмоции пример в Storage один, путь `emotion-examples/{emotion_preset_id}.webp`; примеры на основе реалистичного стиля.
- [ ] Если ни у одного пресета нет примера — сообщение без фото (только текст + клавиатура), как сейчас.
- [ ] В алерте после генерации пака (batch, 9 стикеров) есть кнопка «Сохранить пример для эмоции». В одиночном флоу (смена эмоции) такой алерт не отправляется.
- [ ] По нажатию кнопки изображение сохраняется в Storage как пример данной эмоции и при следующем открытии карусели пример отображается.

---

## 4. Связанные документы и код

- Карусель эмоций: `src/index.ts` — `sendEmotionKeyboard`, `getEmotionPresets`.
- Алерты: `src/lib/alerts.ts` — `sendAlert`, `sendPackPreviewAlert` (аналог кнопки «Сделать примером» для пака).
- Storage: `docs/architecture/08-deployment.md` — бакеты `stickers`, `stickers-examples`.
- БД: `docs/architecture/04-database.md` — таблица `emotion_presets`.

---

## 5. Не в scope

- Примеры для **motion** (движения) — отдельная фича при необходимости.
- Редактирование примеров эмоций через админку вне алертов — отдельная задача.
