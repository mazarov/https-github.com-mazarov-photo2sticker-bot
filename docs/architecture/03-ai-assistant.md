# AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî `src/lib/ai-chat.ts` + `src/lib/assistant-db.ts`

–ß–∞—Ç-–±–æ—Ç –Ω–∞ –±–∞–∑–µ LLM —Å function calling. –í–µ–¥—ë—Ç –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º,
—Å–æ–±–∏—Ä–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∏–∫–µ—Ä–∞, —É–ø—Ä–∞–≤–ª—è–µ—Ç trial credits –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ –ø–æ–∫—É–ø–∫—É.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
flowchart TB
    subgraph "Bot (index.ts)"
        HANDLER[Text / Photo Handler]
        PROCESS[processAssistantResult]
        CONFIRM[handleAssistantConfirm]
    end

    subgraph "AI Chat (ai-chat.ts)"
        PROMPT[buildSystemPrompt]
        CALL[callAIChat]
        GEMINI[callGemini]
        OPENAI[callOpenAI]
    end

    subgraph "Assistant DB (assistant-db.ts)"
        CREATE[createAssistantSession]
        UPDATE[updateAssistantSession]
        TOOLS[handleToolCall]
        STATE[buildStateInjection]
    end

    subgraph "LLM"
        LLM_API[Gemini / OpenAI]
    end

    HANDLER --> PROMPT
    PROMPT --> STATE
    STATE --> CALL
    CALL --> GEMINI
    CALL --> OPENAI
    GEMINI --> LLM_API
    OPENAI --> LLM_API
    LLM_API --> PROCESS
    PROCESS --> TOOLS
    TOOLS --> UPDATE
    PROCESS --> CONFIRM
```

## –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã AI

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –ú–æ–¥–µ–ª—å | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ |
|-----------|--------|-----------|
| Gemini (default) | gemini-2.0-flash | `AI_CHAT_PROVIDER=gemini` |
| OpenAI | gpt-4o-mini | `AI_CHAT_PROVIDER=openai` |

–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ env `AI_CHAT_PROVIDER`. –¢–∞–π–º–∞—É—Ç: 30 —Å–µ–∫—É–Ω–¥. Retry: 2 –ø–æ–ø—ã—Ç–∫–∏.

## Function Calling (Tools)

AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 6 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:

### `update_sticker_params`
–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∏–∫–µ—Ä–∞. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é:
- `style` ‚Äî —Å—Ç–∏–ª—å (—Ç–µ–∫—Å—Ç, verbatim –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `emotion` ‚Äî —ç–º–æ—Ü–∏—è
- `pose` ‚Äî –ø–æ–∑–∞/–∂–µ—Å—Ç

### `confirm_and_generate`
–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.
**–ü—Ä–∞–≤–∏–ª–∞**: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –≤—Å–µ 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
—è–≤–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª (—Å–∫–∞–∑–∞–ª "–¥–∞", "–æ–∫", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é").

### `request_photo`
–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é –≤ `assistant_wait_photo`.

### `show_style_examples`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤ –ø–æ —Å—Ç–∏–ª—è–º. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `style_id`.

### `grant_trial_credit`
–†–µ—à–µ–Ω–∏–µ –æ –≤—ã–¥–∞—á–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–∞. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `decision` ‚Äî "grant" / "deny"
- `confidence` ‚Äî 1-10
- `reason` ‚Äî –ø—Ä–∏—á–∏–Ω–∞ (–¥–ª—è –ª–æ–≥–æ–≤)

### `check_balance`
–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–µ—Ç—ã —Å —Ü–µ–Ω–∞–º–∏.

## –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `generatePrompt()` (prompt_generator agent) –¥–ª—è **–≤—Å–µ—Ö** —Å—Ç–∏–ª–µ–π.
`buildAssistantPrompt()` ‚Äî fallback, –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
[Persona] ‚Üí –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Å—Ç–∏–∫–µ—Ä–∞–º
[Tools] ‚Üí –û–ø–∏—Å–∞–Ω–∏–µ 6 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
[User Context] ‚Üí –ò–º—è, —è–∑—ã–∫, –∫—Ä–µ–¥–∏—Ç—ã, premium, –∏—Å—Ç–æ—Ä–∏—è
[Language Rules] ‚Üí –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
[Dialog Flow] ‚Üí 8 —à–∞–≥–æ–≤ —Å–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
[CRITICAL RULES] ‚Üí –ó–∞–ø—Ä–µ—Ç—ã –Ω–∞ confirm_and_generate
[Trial Credit Rules] ‚Üí –ö–æ–≥–¥–∞ –¥–∞–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—Ä–µ–¥–∏—Ç
[Sales Techniques] ‚Üí Investment escalation, loss aversion
[Balance & Pricing] ‚Üí –†–∞–±–æ—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–æ–º
[SYSTEM STATE] ‚Üí –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –ë–î
```

`buildAssistantPrompt()` –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É multi-person (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π –Ω–∞ —Ñ–æ—Ç–æ)
–∏ –ø—Ä–∞–≤–∏–ª–∞ generous padding –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **–°–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**: —Å—Ç–∏–ª—å ‚Üí —ç–º–æ—Ü–∏—è ‚Üí –ø–æ–∑–∞ (–ø–æ –ø–æ—Ä—è–¥–∫—É, –∏–ª–∏ –≤—Å–µ —Å—Ä–∞–∑—É)
2. **Mirror message**: –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –≤—Å–µ—Ö 3 –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –∏ –∂–¥–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
3. **–ó–∞–ø—Ä–µ—Ç confirm_and_generate**:
   - –ï—Å–ª–∏ –ª—é–±–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä null
   - –í —Ç–æ—Ç –∂–µ —Ö–æ–¥, –∫–æ–≥–¥–∞ —Å–æ–±—Ä–∞–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä
   - –ö–æ–≥–¥–∞ credits=0 –∏ has_purchased=false (–Ω—É–∂–µ–Ω grant_trial_credit)
4. **Trial credit**: AI —Ä–µ—à–∞–µ—Ç –¥–∞–≤–∞—Ç—å –ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—Ä–µ–¥–∏—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ engagement, intent, traffic source

### State Injection

–í –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ AI –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –±–ª–æ–∫ `[SYSTEM STATE]`:

```
[SYSTEM STATE]
- style: "–∞–Ω–∏–º–µ"
- emotion: null ‚Üê MISSING
- pose: null ‚Üê MISSING
- confirmed: false
- has_photo: true
- credits: 0
- has_purchased: false
- paywall_shown: false
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç LLM —Ç–æ—á–Ω–æ –∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- `has_photo` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `sessions.current_photo_file_id` (–∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ system prompt –≤ –∏—Å—Ç–æ—Ä–∏–∏).
- –ï—Å–ª–∏ LLM –≤—ã–∑—ã–≤–∞–µ—Ç `request_photo`, –Ω–æ —Ñ–æ—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ —Ç–µ–∫—É—â–µ–π session, API-guard –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç flow –≤ `assistant_wait_photo` –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

## –¢–∞–±–ª–∏—Ü–∞ `assistant_sessions`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | uuid | PK |
| `session_id` | uuid | FK ‚Üí sessions |
| `user_id` | uuid | FK ‚Üí users |
| `goal` | text | –¶–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `style` | text | –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å |
| `emotion` | text | –í—ã–±—Ä–∞–Ω–Ω–∞—è —ç–º–æ—Ü–∏—è |
| `pose` | text | –í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–æ–∑–∞ |
| `sticker_text` | text | –¢–µ–∫—Å—Ç –Ω–∞ —Å—Ç–∏–∫–µ—Ä–µ |
| `border` | boolean | –ë–µ–ª–∞—è —Ä–∞–º–∫–∞ |
| `confirmed` | boolean | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã |
| `messages` | jsonb | –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ |
| `error_count` | int | –°—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ AI |
| `paywall_shown` | boolean | –ü–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –ª–∏ paywall |
| `sales_attempts` | int | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ |
| `status` | text | active / completed / abandoned / error |

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ AI

```mermaid
flowchart TD
    AI[–í—ã–∑–æ–≤ AI] --> ERR{–û—à–∏–±–∫–∞?}
    ERR -->|–ù–µ—Ç| OK[–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    ERR -->|1-—è –æ—à–∏–±–∫–∞| RETRY[Soft fallback:<br/>"–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑"]
    ERR -->|2-—è –æ—à–∏–±–∫–∞| RETRY
    ERR -->|3-—è –æ—à–∏–±–∫–∞| ESCAPE[Escape –≤ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º:<br/>"–ü–æ–º–æ—â–Ω–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω,<br/>–Ω–∞–∂–º–∏ üé® –°—Ç–∏–ª–∏"]
```

- `error_count` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `assistant_sessions`
- –ü–æ—Å–ª–µ 3 –æ—à–∏–±–æ–∫ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π escape –≤ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º
- Alert –≤ –∫–∞–Ω–∞–ª –ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–µ

## Sticker Ideas After Photo

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ (–∏–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ç–æ –≤ —Å–µ—Å—Å–∏–∏), –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç
LLM-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–¥–µ–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ `generateStickerIdeasFromPhoto()` (GPT-4o-mini).

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å, —Å–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å, –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∏–¥–µ—é –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç.

- **–°–æ—Å—Ç–æ—è–Ω–∏–µ**: `assistant_wait_idea`
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: `sessions.sticker_ideas_state` (JSONB)

## Race Condition Guard

–ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°—Ç–∏–ª–∏" –ø–æ–∫–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥—É–º–∞–µ—Ç):
1. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI ‚Äî –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –∏–∑ –ë–î
2. –ï—Å–ª–∏ `session.state !== "assistant_chat"` ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
3. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ

## Legacy: `src/lib/gemini-chat.ts`

–°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ —á–µ—Ä–µ–∑ HTML-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –æ—Ç–≤–µ—Ç–µ:
```
–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫–æ–π —Å—Ç–∏–ª—å —Ö–æ—á–µ—à—å?
<!-- PARAMS: style=null, emotion=null, pose=null -->
```

–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `ai-chat.ts` —Å –Ω–∞—Ç–∏–≤–Ω—ã–º function calling.
–§–∞–π–ª –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ, –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ai-chat.ts`.
