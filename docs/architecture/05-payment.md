# –û–ø–ª–∞—Ç–∞ ‚Äî Telegram Stars

## –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤

| ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –ö—Ä–µ–¥–∏—Ç—ã | –¶–µ–Ω–∞ (Stars) | –ó–∞ —Å—Ç–∏–∫–µ—Ä | –£—Å–ª–æ–≤–∏—è |
|----|----------|---------|--------------|-----------|---------|
| test | üîß Test | 1 | 1‚≠ê | 1‚≠ê | –¢–æ–ª—å–∫–æ admin |
| try | Try | 2 | 20‚≠ê | 10‚≠ê | –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ |
| start | Start | 10 | 150‚≠ê | 15‚≠ê | ‚Äî |
| pop | Pop | 30 | 300‚≠ê | 10‚≠ê | ‚Äî |
| pro | Pro | 100 | 700‚≠ê | 7‚≠ê | ‚Äî |
| max | Max | 250 | 1500‚≠ê | 6‚≠ê | ‚Äî |

–¢–∞–∫–∂–µ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø–∞–∫–µ—Ç—ã —Å–æ —Å–∫–∏–¥–∫–æ–π (-10%, -15%, -25%) –¥–ª—è –ø—Ä–æ–º–æ –∏ admin-–¥–∏—Å–∫–æ–Ω—Ç–æ–≤.

## –§–ª–æ—É –æ–ø–ª–∞—Ç—ã

```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant BOT as Bot
    participant TG as Telegram
    participant DB as PostgreSQL

    U->>BOT: –í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞ (pack_10_150)
    BOT->>DB: Cancel old transactions
    BOT->>DB: INSERT transaction (state: created)
    BOT->>TG: sendInvoice (Stars)
    TG->>U: –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞—Ç—ë–∂–Ω—É—é —Ñ–æ—Ä–º—É

    U->>TG: –û–ø–ª–∞—Ç–∏—Ç—å
    TG->>BOT: pre_checkout_query
    BOT->>TG: answerPreCheckoutQuery(ok: true)
    Note over BOT: Instant OK ‚Äî –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

    TG->>BOT: successful_payment
    BOT->>DB: Idempotency check (charge_id)
    BOT->>DB: UPDATE transaction ‚Üí state: done
    Note over DB: Trigger: add_credits_on_transaction
    DB-->>BOT: User credits updated

    alt –ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞
        BOT->>DB: +2 bonus credits
        BOT->>DB: has_purchased = true
    end

    alt –°–µ—Å—Å–∏—è –∂–¥—ë—Ç –∫—Ä–µ–¥–∏—Ç—ã
        BOT->>BOT: –ê–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    end

    BOT->>U: "–ö—Ä–µ–¥–∏—Ç—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã! ‚úÖ"
```

## Paywall

### –ö–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

```mermaid
flowchart TD
    START[startGeneration] --> CHECK{credits >= needed?}
    CHECK -->|–î–∞| DEDUCT[–°–ø–∏—Å–∞—Ç—å –∫—Ä–µ–¥–∏—Ç—ã<br/>‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è]
    CHECK -->|–ù–µ—Ç| PURCHASED{has_purchased?}
    PURCHASED -->|–ù–µ—Ç| FIRST[wait_first_purchase<br/>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:<br/>"–ü–µ—Ä–≤—ã–π —Å—Ç–∏–∫–µ—Ä –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π<br/>–Ω–µ –ø–æ–ª—É—á–∏–ª—Å—è? –ö—É–ø–∏ –ø–∞–∫–µ—Ç!"]
    PURCHASED -->|–î–∞| BUY[wait_buy_credit<br/>"–ö—Ä–µ–¥–∏—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å,<br/>–≤—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç"]
    FIRST --> PACKS[–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–∫–µ—Ç—ã]
    BUY --> PACKS
```

### –ê–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

–ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –≤ `wait_first_purchase` –∏–ª–∏ `wait_buy_credit`:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `session.prompt_final` ‚Äî –µ—Å—Ç—å –ª–∏ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
2. –ï—Å–ª–∏ –¥–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö—Ä–µ–¥–∏—Ç—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã, –≤—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å"

–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞, –∏ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

## –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:
1. `telegram_payment_charge_id` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
2. UPDATE —Å —É—Å–ª–æ–≤–∏–µ–º `state = 'created'` ‚Äî —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
3. –ï—Å–ª–∏ charge_id —É–∂–µ –µ—Å—Ç—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

## Trial Credits (AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)

AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—Ä–µ–¥–∏—Ç —á–µ—Ä–µ–∑ `grant_trial_credit`:

- **–õ–∏–º–∏—Ç**: 20 trial credits –≤ –¥–µ–Ω—å (–≥–ª–æ–±–∞–ª—å–Ω–æ)
- **–£—Å–ª–æ–≤–∏—è**: `credits = 0`, `has_purchased = false`
- **–§–∞–∫—Ç–æ—Ä—ã —Ä–µ—à–µ–Ω–∏—è**: engagement, intent quality, traffic source
- **Traffic source –±–æ–Ω—É—Å**: yandex, google –∏ –¥—Ä—É–≥–∏–µ –ø–ª–∞—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –ø–æ–ª—É—á–∞—é—Ç –±–æ–ª–µ–µ –ª—ë–≥–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ

## Abandoned Cart

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ `state: created` –±–æ–ª–µ–µ N –º–∏–Ω—É—Ç ‚Äî abandoned cart:
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è reminder –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- Alert –≤ –∫–∞–Ω–∞–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –ò–Ω–¥–µ–∫—Å—ã: `idx_transactions_abandoned_cart`, `idx_transactions_abandoned_cart_alert`
