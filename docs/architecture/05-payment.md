# –û–ø–ª–∞—Ç–∞ ‚Äî Telegram Stars

## –≠–∫–æ–Ω–æ–º–∏–∫–∞

### –ö—É—Ä—Å—ã –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| 100 Telegram Stars | $1.30 |
| 1 Star | $0.013 ‚âà 1.04 ‚ÇΩ |
| –ö—É—Ä—Å ‚ÇΩ/$ | 80 ‚ÇΩ –∑–∞ $1 |
| 1 –ø–∞–∫ —Å—Ç–∏–∫–µ—Ä–æ–≤ | 10 –∫—Ä–µ–¥–∏—Ç–æ–≤ (10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π) |
| –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å 1 –ø–∞–∫–∞ | **15 ‚ÇΩ** |
| –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | ~1.5 ‚ÇΩ |

### –§–æ—Ä–º—É–ª–∞ –º–∞—Ä–∂–∏

```
–ú–∞—Ä–∂–∞ % = (–í—ã—Ä—É—á–∫–∞ ‚ÇΩ ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚ÇΩ) / –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚ÇΩ √ó 100

–í—ã—Ä—É—á–∫–∞ ‚ÇΩ = Stars √ó 1.04
–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å ‚ÇΩ = (–ö—Ä–µ–¥–∏—Ç—ã / 10) √ó 15‚ÇΩ
```

–î–ª—è trial-–ø–∞–∫–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç **–∏—Ç–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–æ–≤** (–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö + –±–æ–Ω—É—Å–Ω—ã—Ö),
–ø–æ—Ç–æ–º—É —á—Ç–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥—É—é—Ç —Ä–µ—Å—É—Ä—Å—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –æ–ø–ª–∞—á–µ–Ω—ã –æ–Ω–∏ –∏–ª–∏ –Ω–µ—Ç.

---

## –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã

| ID | –ù–∞–∑–≤–∞–Ω–∏–µ | –ö—Ä–µ–¥–∏—Ç—ã | –ë–æ–Ω—É—Å | –ò—Ç–æ–≥–æ | –¶–µ–Ω–∞ Stars | ~‚ÇΩ | Stars/–≥–µ–Ω | –ú–∞—Ä–∂–∞ % | –£—Å–ª–æ–≤–∏–µ |
|---|---|---|---|---|---|---|---|---|---|
| test | üîß –¢–µ—Å—Ç | 1 | ‚Äî | 1 | 1‚≠ê | 1‚ÇΩ | 1.0 | ‚Äî | adminOnly |
| try | üéÅ –ü–æ–ø—Ä–æ–±—É–π | 5 | +4 | **9** | 49‚≠ê | 51‚ÇΩ | 5.4 | 278% | trialOnly (1—è –ø–æ–∫—É–ø–∫–∞) |
| start | ‚≠ê –°—Ç–∞—Ä—Ç | 10 | ‚Äî | 10 | 75‚≠ê | 78‚ÇΩ | 7.5 | 420% | ‚Äî |
| pop | üíé –ü–æ–ø | 30 | ‚Äî | 30 | 175‚≠ê | 182‚ÇΩ | 5.8 | 304% | ‚Äî |
| pro | üëë –ü—Ä–æ | 100 | ‚Äî | 100 | 500‚≠ê | 520‚ÇΩ | 5.0 | 247% | ‚Äî |
| max | üöÄ –ú–∞–∫—Å | 250 | ‚Äî | 250 | 1125‚≠ê | 1170‚ÇΩ | 4.5 | 212% | ‚Äî |

### –°–∫–∏–¥–æ—á–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (hidden)

–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ UI. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø—Ä–æ–º–æ, abandoned cart, admin-–¥–∏—Å–∫–æ–Ω—Ç–æ–≤.

| –°–∫–∏–¥–∫–∞ | –ü–æ–ø—Ä–æ–±—É–π | –°—Ç–∞—Ä—Ç | –ü–æ–ø | –ü—Ä–æ | –ú–∞–∫—Å |
|---|---|---|---|---|---|
| –ë–∞–∑–æ–≤–∞—è | 49‚≠ê | 75‚≠ê | 175‚≠ê | 500‚≠ê | 1125‚≠ê |
| -10% | 44‚≠ê | 68‚≠ê | 158‚≠ê | 450‚≠ê | 1013‚≠ê |
| -15% | 42‚≠ê | 64‚≠ê | 149‚≠ê | 425‚≠ê | 956‚≠ê |
| -25% | 37‚≠ê | 56‚≠ê | 131‚≠ê | 375‚≠ê | 844‚≠ê |

### Trial-–ø–∞–∫–µ—Ç: bonus_credits

–ü–∞–∫–µ—Ç `üéÅ –ü–æ–ø—Ä–æ–±—É–π` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `bonus_credits`:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç –∑–∞ 5 –∫—Ä–µ–¥–∏—Ç–æ–≤, –ø–æ–ª—É—á–∞–µ—Ç 9 (5 + 4 –±–æ–Ω—É—Å).
- –í `successful_payment` –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è `credits + bonus_credits`.
- –°–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ `has_purchased = true`.

---

## –§–ª–æ—É –æ–ø–ª–∞—Ç—ã

```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant BOT as Bot
    participant TG as Telegram
    participant DB as PostgreSQL

    U->>BOT: –í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞ (pack_10_75)
    BOT->>DB: Cancel old transactions
    BOT->>DB: INSERT transaction (state: created)
    BOT->>TG: sendInvoice (Stars)
    TG->>U: –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞—Ç—ë–∂–Ω—É—é —Ñ–æ—Ä–º—É

    U->>TG: –û–ø–ª–∞—Ç–∏—Ç—å
    TG->>BOT: pre_checkout_query
    BOT->>TG: answerPreCheckoutQuery(ok: true)
    Note over BOT: Instant OK ‚Äî –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

    TG->>BOT: successful_payment
    BOT->>DB: Idempotency check (charge_id)
    BOT->>DB: UPDATE transaction ‚Üí state: done
    Note over DB: Trigger: add_credits_on_transaction
    BOT->>DB: credits += pack.credits + pack.bonus_credits
    DB-->>BOT: User credits updated

    alt –ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞
        BOT->>DB: has_purchased = true
    end

    alt –°–µ—Å—Å–∏—è –∂–¥—ë—Ç –∫—Ä–µ–¥–∏—Ç—ã
        BOT->>BOT: –ê–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    end

    BOT->>U: "–ö—Ä–µ–¥–∏—Ç—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã! ‚úÖ"
```

## Paywall

### –ö–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

```mermaid
flowchart TD
    START[startGeneration] --> CHECK{credits >= needed?}
    CHECK -->|–î–∞| DEDUCT[–°–ø–∏—Å–∞—Ç—å –∫—Ä–µ–¥–∏—Ç—ã<br/>‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è]
    CHECK -->|–ù–µ—Ç| PURCHASED{has_purchased?}
    PURCHASED -->|–ù–µ—Ç| FIRST[wait_first_purchase<br/>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:<br/>"–ü–µ—Ä–≤—ã–π —Å—Ç–∏–∫–µ—Ä –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π<br/>–Ω–µ –ø–æ–ª—É—á–∏–ª—Å—è? –ö—É–ø–∏ –ø–∞–∫–µ—Ç!"]
    PURCHASED -->|–î–∞| BUY[wait_buy_credit<br/>"–ö—Ä–µ–¥–∏—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å,<br/>–≤—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç"]
    FIRST --> PACKS[–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–∫–µ—Ç—ã]
    BUY --> PACKS
```

### –ê–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

–ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –≤ `wait_first_purchase` –∏–ª–∏ `wait_buy_credit`:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `session.prompt_final` ‚Äî –µ—Å—Ç—å –ª–∏ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
2. –ï—Å–ª–∏ –¥–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö—Ä–µ–¥–∏—Ç—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã, –≤—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å"

–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞, –∏ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

## –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:
1. `telegram_payment_charge_id` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
2. UPDATE —Å —É—Å–ª–æ–≤–∏–µ–º `state = 'created'` ‚Äî —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
3. –ï—Å–ª–∏ charge_id —É–∂–µ –µ—Å—Ç—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

## Trial Credits (AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)

AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—Ä–µ–¥–∏—Ç —á–µ—Ä–µ–∑ `grant_trial_credit`:

- **–õ–∏–º–∏—Ç**: 20 trial credits –≤ –¥–µ–Ω—å (–≥–ª–æ–±–∞–ª—å–Ω–æ)
- **–£—Å–ª–æ–≤–∏—è**: `credits = 0`, `has_purchased = false`
- **–§–∞–∫—Ç–æ—Ä—ã —Ä–µ—à–µ–Ω–∏—è**: engagement, intent quality, traffic source
- **Traffic source –±–æ–Ω—É—Å**: yandex, google –∏ –¥—Ä—É–≥–∏–µ –ø–ª–∞—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –ø–æ–ª—É—á–∞—é—Ç –±–æ–ª–µ–µ –ª—ë–≥–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ

## Abandoned Cart

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ `state: created` –±–æ–ª–µ–µ N –º–∏–Ω—É—Ç ‚Äî abandoned cart:
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è reminder –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- Alert –≤ –∫–∞–Ω–∞–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –ò–Ω–¥–µ–∫—Å—ã: `idx_transactions_abandoned_cart`, `idx_transactions_abandoned_cart_alert`
