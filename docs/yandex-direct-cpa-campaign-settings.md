# Яндекс Директ: кампания с оплатой за конверсии (CPA)

Переход с **оплаты за клики (CPC)** на **оплату за конверсии**, где конверсия = **оплата** в боте.

## Что уже есть в проекте

- **Лендинг:** передаёт `yclid` и UTM в deep link при клике из Директа.
- **Бот:** при оплате отправляет офлайн-конверсию в Метрику (yclid, цель `purchase` / `purchase_try` / `purchase_start` и т.д., сумма в ₽).
- **Метрика:** счётчик 106534984; в нём должны быть созданы цели с идентификаторами `purchase`, `purchase_try`, `purchase_start`, `purchase_pop`, `purchase_pro`, `purchase_max` (см. [13-02-yandex-direct-conversions.md](./done/02/13-02-yandex-direct-conversions.md)).

Без этого Директ не сможет считать конверсии и перейти на стратегию «Оптимизация конверсий».

---

## 1. Связка Метрики и Директа

1. [Яндекс Директ](https://direct.yandex.ru/) → **Настройки** → **Связь с Метрикой** (или в кампании).
2. Привязать счётчик Метрики **106534984** к аккаунту Директа.
3. Убедиться, что в Метрике в целях указаны **ровно** идентификаторы из бота: `purchase`, `purchase_try`, `purchase_start`, `purchase_pop`, `purchase_pro`, `purchase_max`.

---

## 2. Стратегия показа: «Оптимизация конверсий»

Вместо **«Ручное управление»** или **«Средняя цена клика»**:

1. Открыть кампанию (или создать новую).
2. **Стратегия показа** → выбрать **«Оптимизация конверсий»**.
3. **Цель в Метрике:** выбрать одну или несколько целей, по которым считать конверсию:
   - Рекомендуется: **одна общая цель** — например, `purchase` (любая оплата), чтобы Директ оптимизировался по всем покупкам.
   - Альтернатива: только «первая покупка» — тогда выбрать цель `purchase_try` (trial-пакет), если важнее считать именно первый платёж.
4. **Целевая стоимость конверсии (ЦК):** указать желаемый CPA в рублях, например **200–400 ₽** за одну оплату (ориентир: средний чек ~50–200 ₽, допустимо платить за привлечение до 2–3× среднего чека на старте).
5. **Недельный бюджет** — задать лимит, чтобы система могла распределять ставки (обычно от 5–10 тыс. ₽/нед для стабильной оптимизации).

Итог: Директ сам подбирает ставки так, чтобы получать конверсии (оплаты) около целевого CPA, а не максимизировать клики.

---

## 3. Рекомендуемые настройки кампании

| Настройка | Рекомендация |
|-----------|--------------|
| **Тип кампании** | Поиск и/или РСЯ (рекламная сеть). Для CPA часто включают РСЯ — больше объём, быстрее набираются конверсии для обучения. |
| **Стратегия** | **Оптимизация конверсий** (см. выше). |
| **Цель** | Одна: `purchase` (все оплаты) — проще и стабильнее для алгоритма. |
| **Целевая ЦК** | 200–400 ₽ на старте; через 2–3 недели снижать по данным (если реальный CPA ниже — уменьшить целевой ЦК). |
| **Недельный бюджет** | Не меньше 5–10 тыс. ₽, иначе мало конверсий и стратегия плохо обучается. |
| **Гео** | РФ (или только регионы, где реально платят). |
| **Минимальная цена клика** | Оставить по умолчанию или задать разумный минимум (например, 15–30 ₽), чтобы не отсекать дешёвый трафик с РСЯ. |
| **Частота показов** | Не чаще 1–2 раз в день на пользователя (особенно РСЯ), чтобы не переплачивать за одних и тех же. |

---

## 4. Объявления и ключевые слова

- **URL объявления:** `https://photo2sticker.ru/?utm_source=yandex&utm_medium=cpc&utm_campaign=ВАША_КАМПАНИЯ` (обязательно без лишних параметров, которые режет лендинг). Директ сам подставит `yclid` при клике.
- Ключевые слова: оставить релевантные (стикеры из фото, сделать стикеры и т.д.), без избыточно общих запросов.
- Объявления: чёткий оффер (пак стикеров из фото, цена от 45₽), призыв открыть бота.

---

## 5. Что проверить после переключения

1. **Метрика → Отчёты → Конверсии:** через 1–2 часа после оплаты с Директа должны появляться офлайн-конверсии с целями `purchase` и т.д. и суммой (Price).
2. **Директ → Отчёт по кампании:** в колонках «Конверсии» и «Стоимость конверсии» появятся данные (с задержкой до суток).
3. **Логи бота:** при каждой оплате пользователя с `yclid` — строка `[metrika] Conversion sent` (или ошибка в алерте).

Если конверсии в Метрике есть, а в Директе нет — проверить связку счётчика с Директом и что выбранная цель совпадает с идентификатором в Метрике.

---

## 6. Риски и ограничения

- **Мало конверсий (<10–30 в неделю):** автостратегия обучается медленно, ЦК может «плавать». Решение: повысить бюджет или временно расширить гео/РСЯ.
- **Высокий реальный CPA в первые дни:** нормально; через 1–2 недели система начнёт отсекать нецелевой трафик. При необходимости поднять целевую ЦК на старте, затем снижать.
- **Конверсия только при оплате:** все переходы без оплаты для Директа «не конверсия» — так и задумано при оплате за конверсии.

---

## Краткий чеклист перехода с CPC на CPA

- [ ] Метрика привязана к Директу, цели `purchase*` созданы.
- [ ] В кампании выбрана стратегия **«Оптимизация конверсий»**.
- [ ] Выбрана цель **`purchase`** (или нужный набор `purchase_*`).
- [ ] Заданы **целевая ЦК** (₽) и **недельный бюджет**.
- [ ] В объявлениях URL лендинга с UTM; `yclid` подставляется Директом.
- [ ] Через 1–2 дня проверены конверсии в Метрике и в отчёте Директа.
