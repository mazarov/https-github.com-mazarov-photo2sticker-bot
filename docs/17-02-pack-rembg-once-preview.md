# Идея: один rembg на превью пака вместо rembg по каждому стикеру

**Дата:** 17.02.2026  
**Проект:** photo2sticker-bot  
**Связано:** [15-02-pack-flow-requirements.md](15-02-pack-flow-requirements.md)

---

## 1. Суть идеи

**As is:** После генерации сетки Gemini нарезаем её на N ячеек, для **каждой** ячейки отдельно запускаем rembg (удаление фона), затем накладываем подписи и собираем стикерпак. Итого N вызовов rembg.

**To be:** Удаляем фон **один раз** — с целого листа превью (сетки). Пользователю отдаём превью **уже без хромакея** (magenta/green убраны, прозрачный или нейтральный фон). При нажатии «Получить пак» — **просто режим**: нарезаем этот же очищенный лист на N ячеек, накладываем подписи, загружаем в Telegram. Повторного rembg по ячейкам нет.

---

## 2. Цели

- Сократить время и нагрузку: 1 rembg вместо N (например, 16).
- Показать пользователю превью в финальном виде (без цветного фона), чтобы «что видишь — то и получишь».
- Упростить конвейер на этапе «получить пак»: только нарезка + оверлей подписей + загрузка.

---

## 3. Предлагаемый флоу

1. **Генерация сетки:** Gemini по-прежнему генерит один лист N×N с magenta-фоном и сценами по ячейкам.
2. **Один rembg:** Запускаем rembg **на весь лист** целиком. Получаем изображение того же размера с удалённым фоном (прозрачность или белый фон — по текущей логике).
3. **Превью пользователю:** Отправляем пользователю именно этот очищенный лист как превью («вот что получится»). Хромакей пользователь не видит.
4. **Сохранение:** Очищенный лист сохраняем (хранилище / pack_batches), чтобы использовать на шаге «Получить пак».
5. **Получить пак:** Пользователь нажимает «Получить пак» → берём сохранённый очищенный лист, нарезаем на N ячеек по сетке, на каждую ячейку накладываем подпись, загружаем стикеры в Telegram. Rembg на этом этапе не вызываем.

---

## 4. Риски и что проверить

| Риск | Описание | Что сделать |
|------|----------|-------------|
| Качество границ между ячейками | На целом листе rembg может давать менее чёткие края на стыках ячеек или «склеивать» соседние фигуры. | Прогнать на реальных сетках 4×4; сравнить с текущим поячейковым rembg. |
| Точность нарезки | Линии между ячейками после rembg могут быть неровными; фиксированная сетка (N×N) может дать полоску фона или обрез. | Чётко определить правило нарезки (пиксели, отступы), при необходимости небольшой padding/центрирование нарезки. |
| Меньше гибкости по ячейке | Нельзя отдельно подправить кроп/центр одной ячейки; всё завязано на раскладку от Gemini. | Мониторить случаи «прижатых» к краю персонажей; при массовых проблемах — донастройка промпта или fallback. |
| Хранение очищенного листа | Нужен один и тот же файл от превью до сборки пака. | Явно сохранять результат rembg (URL/file_id или объект в хранилище) в pack_batches и использовать его при «Получить пак». |
| Сбой одного rembg = весь пак | Если один общий rembg испортит лист, перегенерация дорогая. | Retry при ошибке; при необходимости — fallback на текущий поячейковый rembg для проблемных батчей. |

---

## 5. Критерии приёмки (после реализации)

1. Превью пака показывается пользователю без хромакея (фон уже удалён).
2. Rembg вызывается один раз на полный лист сетки; при сборке пака rembg по ячейкам не вызывается.
3. Очищенный лист сохраняется и используется при нажатии «Получить пак» для нарезки и загрузки стикеров.
4. Качество границ и нарезки проверено на тестовых паках; при необходимости описан fallback на поячейковый rembg.

---

## 6. Реализация (17.02.2026)

- **Миграция:** `sql/079_pack_sheet_cleaned.sql` — в `sessions` добавлено поле `pack_sheet_cleaned` (boolean, default false).
- **Превью (worker runPackPreviewJob):** после получения сетки от Gemini вызывается `callRembg` на весь лист. При успехе пользователю отправляется очищенное изображение, в сессию пишется `pack_sheet_file_id` (file_id отправленного фото) и `pack_sheet_cleaned: true`. При ошибке rembg отправляется сырая сетка, `pack_sheet_cleaned: false` — при сборке пака выполняется прежний поячейковый rembg.
- **Сборка (worker runPackAssembleJob):** если `session.pack_sheet_cleaned === true`, лист скачивается по `pack_sheet_file_id`, нарезается на ячейки, rembg по ячейкам не вызывается. Иначе — прежняя логика (rembg/Pixian по каждой ячейке).
- **Регенерация превью (index pack_regenerate):** при сбросе `pack_sheet_file_id` также выставляется `pack_sheet_cleaned: false`.
