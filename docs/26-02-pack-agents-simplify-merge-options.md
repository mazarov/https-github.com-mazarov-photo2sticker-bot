# Упрощение пайплайна: меньше агентов без потери качества

**Дата:** 26.02.2026  
**Контекст:** Pack pipeline — 5 агентов (Concept, Boss, Captions, Scenes, Critic). Цель: сократить число вызовов и/или сложность без ухудшения результата.

---

## 1. Текущая схема и зависимости

```
request + subjectType
        │
        ▼
   [Concept]  →  brief (setting, persona, tone, situation_types, visual_anchors, …)
        │
        ▼
   [Boss]     →  plan (id, name_ru/en, moments[9], carousel_*, mood, …)
        │
        ├──────────────────┬──────────────────┐
        ▼                  ▼                  │
 [Captions]           [Scenes]                │
        │                  │                  │
        ▼                  ▼                  │
 labels[9],           scene_descriptions[9]   │
 labels_en[9]                                 │
        │                  │                  │
        └────────┬─────────┘                  │
                 ▼                            │
          assembleSpec(plan, captions, scenes) │
                 │                            │
                 ▼                            │
           [Critic]  →  pass / reasons / suggestions
                 │
                 └── (if fail) rework Captions and/or Scenes, then Critic again
```

- **Concept** и **Boss** — строго последовательны; Boss без brief не имеет смысла.
- **Captions** и **Scenes** — параллельны, оба зависят только от plan.
- **Critic** — всегда последний, нужен полный spec; при fail перезапускаем только Captions/Scenes (и то точечно по индексам).

Объединять можно только те шаги, между которыми нет «чужих» зависимостей. Critic объединять с генерацией нельзя — это отдельная роль (оценка, не генерация).

---

## 2. Варианты объединения

### 2.1. Concept + Boss → один агент «Brief & Plan»

**Идея:** один вызов: на входе `request` + `subjectType`, на выходе один JSON с полями и брифa (setting, persona, tone, situation_types, shareability_hook, title_hint, visual_anchors), и плана (id, name_ru/en, moments[9], carousel_*, mood, …).

**Плюсы:**
- Меньше на один round-trip и один системный промпт.
- Бриф и план логически связаны: план — это «развёртка» брифa в 9 моментов. Одна модель может держать консистентность (тема → моменты) лучше, чем две по очереди.
- Rework от Critic не трогает эту ступень — перезапускаем только Captions/Scenes, как сейчас.

**Риски по качеству:**
- Один модель делает два объёма работы; возможна «размазанность» по одному из блоков (например, моменты станут слабее). Снизить риск можно чёткой структурой вывода (секции «brief» и «plan») и явными лимитами (9 моментов, 8–10 слов, anti-postcard).
- Размер вывода растёт (brief + plan), значит один вызов дольше и с большим `max_tokens` (например, 512 + 1024 ≈ 1536). Латентность одного вызова может быть сравнима с суммой двух текущих, но round-trip один — часто это быстрее суммарно.

**Итог:** сильный кандидат. Упрощает пайплайн (4 агента вместо 5), даёт выигрыш по числу вызовов и может не ухудшить, а даже улучшить согласованность бриф ↔ план.

---

### 2.2. Captions + Scenes → один агент «Captions & Scenes»

**Идея:** один вызов: на входе `plan`, на выходе один JSON: `labels`, `labels_en`, `scene_descriptions`.

**Плюсы:**
- Вместо двух параллельных вызовов — один. Экономия на одном системном промпте и одном round-trip (при том что сейчас мы ждём max(Captions, Scenes)).
- Один модель «видит» и подписи, и сцены — теоретически может лучше согласовать тон (например, awkward moment → и подпись, и сцена в одном духе).

**Риски по качеству:**
- Разные форматы: подписи — короткие, «внутренний голос», 15–20 символов; сцены — визуальные, с `{subject}`, 18–22 слова, chest-up. В одном промпте легко смешать стили или ослабить один из форматов.
- Rework: сейчас при fail Critic мы перезапускаем только Captions или только Scenes (или точечно по индексам). Если объединить — при любом замечании по подписям или сценам придётся перезапускать один общий вызов (все 9 подписей и все 9 сцен). Теряется точечный rework и растёт цена одной итерации.

**Итог:** возможный эксперимент, но с риском по качеству и с потерей гибкости rework. Имеет смысл пробовать только после стабилизации варианта Concept+Boss и с A/B проверкой качества.

---

### 2.3. Concept + Boss + Captions + Scenes → один «мега-агент»

**Идея:** один вызов: request + subjectType → brief + plan + labels + labels_en + scene_descriptions.

**Минусы:**
- Огромный вывод и очень длинный системный промпт (все правила в одном). Высокий риск размытия фокуса и падения качества по одному из блоков.
- Rework: при любом fail Critic — полный перезапуск всего; нет частичных правок по индексам.
- Отладка и доработка промптов усложняются.

**Итог:** не рекомендуется. Упрощение по числу вызовов не компенсирует риски по качеству и по rework.

---

### 2.4. Critic

**Не объединять** с генерацией. Critic — отдельная роль (проверка формата, правил, вкуса); должен получать уже собранный spec. Объединение с кем-либо из генераторов размывает контракт и усложняет rework.

---

## 3. Сравнение по качеству и сложности

| Вариант | Агентов | Round-trips (первый проход) | Риск по качеству | Rework | Сложность реализации |
|--------|---------|-----------------------------|------------------|--------|----------------------|
| Сейчас | 5 | 4 (Concept → Boss → max(Captions,Scenes) → Critic) | — | Точечный по Captions/Scenes | — |
| Concept+Boss | 4 | 3 | Низкий | Без изменений | Средняя (один промпт, один контракт JSON) |
| Captions+Scenes | 4 | 3 | Средний | Только полный перезапуск пары | Средняя + потеря partial rework |
| Concept+Boss + Captions+Scenes | 3 | 2 | Высокий | Только полный перезапуск | Высокая |
| Мега-агент (всё в один) | 2 | 1 | Высокий | Полный перезапуск | Высокая |

---

## 4. Рекомендация

**Сделать в первую очередь:** объединить **Concept + Boss** в один агент «Brief & Plan».

- Уменьшаем число агентов с 5 до 4 и число последовательных round-trip’ов с 4 до 3 без потери текущей логики rework.
- Качество бриф ↔ план может даже вырасти за счёт единого контекста.
- Реализация: один системный промпт (роль Concept + роль Boss + один общий OUTPUT с двумя блоками), один тип вывода (например, `ConceptAndPlan` с полями brief + plan), один вызов вместо `runConcept` + `runBoss`; пайплайн вызывает новый `runConceptAndPlan`, дальше как сейчас — Captions ∥ Scenes → Assembly → Critic.

**Пока не объединять:** Captions и Scenes — оставить двумя агентами. Причины: разный «голос» (подписи vs сцены), важность точечного rework по индексам, возможность отдельно править промпты под подписи и под сцены. Вариант Captions+Scenes можно вернуть после стабилизации Concept+Boss и при наличии цели ещё сильнее сократить число вызовов (с пониманием потери partial rework).

---

## 5. План внедрения (Concept + Boss)

1. **Контракт:** определить тип `ConceptAndPlan` = объединение полей `ConceptBrief` и `BossPlan` (или вложенные объекты `brief` и `plan`).
2. **Промпт:** объединить CONCEPT_SYSTEM и BOSS_SYSTEM в один блок: общая роль, правила Concept (тема, outfit, human tension), правила Boss (9 моментов, anti-postcard), один строгий OUTPUT с перечислением всех полей JSON (brief + plan).
3. **Код:** ввести `runConceptAndPlan(request, subjectType)` → возвращает `{ brief, plan }` или плоский объект; в пайплайне заменить вызовы `runConcept` + `runBoss` на один `runConceptAndPlan`, дальше передавать `plan` в Captions/Scenes как сейчас. Assembly и Critic без изменений.
4. **Лимиты:** выставить `max_tokens` для объединённого вызова с запасом (например, 512 + 1024 = 1536 или 2048).
5. **Тесты:** сравнить 5–10 паков «до» и «после» по прохождению Critic и субъективному качеству моментов/подписей.

После этого при необходимости можно отдельно рассмотреть эксперимент Captions+Scenes с явными критериями качества и решением по стратегии rework.
