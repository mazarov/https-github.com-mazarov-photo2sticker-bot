# –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏–∫–µ—Ä–∞ –∏–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏ Telegram

**–î–∞—Ç–∞:** 2026-02-12
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

---

## –°—É—Ç—å

–î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ø–ª–∞—Ç–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (–Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç) ‚Äî –ø—Ä–∏ `/start` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä—ë–º –∞–≤–∞—Ç–∞—Ä–∫—É –∏–∑ Telegram –∏ –≥–µ–Ω–µ—Ä–∏–º –¥–µ–º–æ-—Å—Ç–∏–∫–µ—Ä –≤ —Å—Ç–∏–ª–µ –∞–Ω–∏–º–µ. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –¥–∏–∞–ª–æ–≥–∞ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º, –±–µ–∑ —Ç—Ä–∞—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤.

–¶–µ–ª—å: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç ‚Üí –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è —Å –¥–æ—Ä–æ–≥–æ–≥–æ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞.

---

## –£—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

–ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–ï —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**

1. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Äî `isNewUser === true` (—Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω –≤ –ë–î)
2. **–ü–ª–∞—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫** ‚Äî `utm_source === "yandex"` –ò `utm_medium === "cpc"` (–∏–∑ start payload)
3. **–ï—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∫–∞** ‚Äî `getUserProfilePhotos` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ö–æ—Ç—è –±—ã 1 —Ñ–æ—Ç–æ

–ï—Å–ª–∏ –ª—é–±–æ–µ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π flow (`startAssistantDialog`).

---

## Flow (–í–∞—Ä–∏–∞–Ω—Ç C: –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è)

### –®–∞–≥ 1: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –ø—Ä–æ–≥—Ä–µ—Å—Å (~0 —Å–µ–∫)

```
RU: "–ü—Ä–∏–≤–µ—Ç! –£–∂–µ –¥–µ–ª–∞—é —Å—Ç–∏–∫–µ—Ä –∏–∑ —Ç–≤–æ–µ–π –∞–≤–∞—Ç–∞—Ä–∫–∏ ‚ú®"
EN: "Hi! Already making a sticker from your profile photo ‚ú®"
```

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ ‚Äî progress message (–∫–∞–∫ –≤ —Ç–µ–∫—É—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏):
```
‚è≥ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ...
üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ç–∏–∫–µ—Ä...
üî≤ –£–±–∏—Ä–∞—é —Ñ–æ–Ω...
```

### –®–∞–≥ 2: –†–µ–∑—É–ª—å—Ç–∞—Ç (~30 —Å–µ–∫)

–°—Ç–∏–∫–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ post-generation –∫–Ω–æ–ø–∫–∞–º–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–∫
- –°–º–µ–Ω–∏—Ç—å —ç–º–æ—Ü–∏—é / –î–æ–±–∞–≤–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ
- –û–±–≤–æ–¥–∫–∞ / –¢–µ–∫—Å—Ç
- –ò–¥–µ–∏ –¥–ª—è –ø–∞–∫–∞

### –®–∞–≥ 3: –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é

–ü–æ—Å–ª–µ —Å—Ç–∏–∫–µ—Ä–∞ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
RU: "üéâ –í–æ—Ç —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å!\n\nüì∏ –ü—Ä–∏—à–ª–∏ —Å–≤–æ—ë —Ñ–æ—Ç–æ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –µ—â—ë –ª—É—á—à–µ!\nüí° –õ—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç —Ñ–æ—Ç–æ –ª–∏—Ü–∞ –∫—Ä—É–ø–Ω—ã–º –ø–ª–∞–Ω–æ–º"
EN: "üéâ Here's what I got!\n\nüì∏ Send your own photo ‚Äî the result will be even better!\nüí° A close-up face photo works best"
```

---

## –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### –ù–µ —Ç—Ä–∞—Ç–∏—Ç –∫—Ä–µ–¥–∏—Ç
–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–µ–º–æ-—Å—Ç–∏–∫–µ—Ä. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã. –í session —Å—Ç–∞–≤–∏–º `credits_spent: 0`.

### –ù–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ generation
`total_generations` **–ù–ï –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è "–Ω–æ–≤—ã–º" –¥–ª—è:
- –û–Ω–±–æ—Ä–¥–∏–Ω–≥-–ª–æ–≥–∏–∫–∏ (`onboarding_step` –æ—Å—Ç–∞—ë—Ç—Å—è 0)
- Trial credit —Ä–µ—à–µ–Ω–∏—è LLM (`total_generations === 0`)
- –ê–ª–µ—Ä—Ç–∞ `onboarding_completed`

### –ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é ‚Äî –±–µ–∑ `assistant_sessions`, –±–µ–∑ AI –¥–∏–∞–ª–æ–≥–∞. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç.

### –°—Ç–∏–ª—å –ø–æ –¥–µ—Ñ–æ–ª—Ç—É: –∞–Ω–∏–º–µ
–ò—Å–ø–æ–ª—å–∑—É–µ–º style preset `anime` (–∏–ª–∏ —Ç–µ–∫—É—â–∏–π ID –∞–Ω–∏–º–µ-—Å—Ç–∏–ª—è –∏–∑ `style_presets_v2`).

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/index.ts` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `bot.start`

```
bot.start ‚Üí {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ —é–∑–µ—Ä–∞, UTM –ø–∞—Ä—Å–∏–Ω–≥ ...

  if (isNewUser && utm.source === "yandex" && utm.medium === "cpc") {
    // –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏
    try {
      const photos = await ctx.telegram.getUserProfilePhotos(telegramId, 0, 1);
      if (photos.total_count > 0) {
        await handleAvatarAutoGeneration(ctx, user, lang);
        return; // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º startAssistantDialog
      }
    } catch (err) {
      console.error("[AvatarAuto] Failed to get profile photos:", err);
    }
  }

  // Fallback: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π flow
  await startAssistantDialog(ctx, user, lang);
}
```

### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `handleAvatarAutoGeneration`

1. –ü–æ–ª—É—á–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É: `getUserProfilePhotos` ‚Üí `getFile` ‚Üí download
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + progress message
3. –°–æ–∑–¥–∞—Ç—å session —Å:
   - `state: "processing_style"`
   - `selected_style_id: "anime"` (–∏–ª–∏ ID –∞–Ω–∏–º–µ –∏–∑ –ë–î)
   - `credits_spent: 0` ‚Üê –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ–º
   - `generation_type: "avatar_demo"`
   - `current_photo_file_id: avatarFileId`
4. –°–æ–∑–¥–∞—Ç—å job –¥–ª—è worker
5. Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/worker.ts`

1. –ï—Å–ª–∏ `generation_type === "avatar_demo"`:
   - **–ù–ï** –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `total_generations`
   - **–ù–ï** –æ–±–Ω–æ–≤–ª—è—Ç—å `onboarding_step`
   - **–ù–ï** –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `onboarding_completed` –∞–ª–µ—Ä—Ç
   - –ü–æ—Å–ª–µ —Å—Ç–∏–∫–µ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å CTA: "–ü—Ä–∏—à–ª–∏ —Å–≤–æ—ë —Ñ–æ—Ç–æ ‚Äî –±—É–¥–µ—Ç –µ—â—ë –ª—É—á—à–µ!"
2. –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (rembg, trim, –∫–Ω–æ–ø–∫–∏) ‚Äî –∫–∞–∫ –æ–±—ã—á–Ω–æ

---

## –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–±–µ–∑ —É—á–∞—Å—Ç–∏—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞):

```
Transform this photo into an anime-style sticker character.
Keep the person's face features, hairstyle, and distinctive traits recognizable.
Style: anime/manga art style, expressive eyes, clean lines.
The character should have a friendly, welcoming expression.
Full body or upper body pose, facing the viewer.
Bright, vibrant colors. White or transparent background.
```

---

## Fallback-—Å—Ü–µ–Ω–∞—Ä–∏–∏

| –°–∏—Ç—É–∞—Ü–∏—è | –î–µ–π—Å—Ç–≤–∏–µ |
|----------|----------|
| –ù–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏ | `startAssistantDialog` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π flow) |
| `getUserProfilePhotos` –æ—à–∏–±–∫–∞ | `startAssistantDialog` |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø–∞–ª–∞ | –°–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ —Å–∞–º" + `startAssistantDialog` |
| –ê–≤–∞—Ç–∞—Ä–∫–∞ ‚Äî –Ω–µ –ª–∏—Ü–æ | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å—ë —Ä–∞–≤–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–∞–≤–Ω—ã–º |
| –ù–µ –ø–ª–∞—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ | `startAssistantDialog` |

---

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

- –ö–æ–Ω–≤–µ—Ä—Å–∏—è `/start` ‚Üí –ø–µ—Ä–≤—ã–π "–Ω–∞—Å—Ç–æ—è—â–∏–π" —Å—Ç–∏–∫–µ—Ä (–¥–ª—è –ø–ª–∞—Ç–Ω–æ–≥–æ vs –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞)
- % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π —Å—Ä–µ–¥–∏ –ø–ª–∞—Ç–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
- Retention –ø–æ—Å–ª–µ –¥–µ–º–æ-—Å—Ç–∏–∫–µ—Ä–∞ vs —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏

---

## –ß–µ–∫–ª–∏—Å—Ç

- [ ] –î–æ–±–∞–≤–∏—Ç—å `handleAvatarAutoGeneration` –≤ `index.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –≤ `bot.start`: `utm_source=yandex` + `utm_medium=cpc` + –∞–≤–∞—Ç–∞—Ä–∫–∞
- [ ] –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∏–º–µ-—Å—Ç–∏–ª—è –∏–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏
- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å-—Å–æ–æ–±—â–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] CTA –ø–æ—Å–ª–µ —Å—Ç–∏–∫–µ—Ä–∞: "–ü—Ä–∏—à–ª–∏ —Å–≤–æ—ë —Ñ–æ—Ç–æ"
- [ ] Worker: –Ω–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `total_generations` –¥–ª—è `avatar_demo`
- [ ] Worker: –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å `onboarding_step` –¥–ª—è `avatar_demo`
- [ ] Worker: –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `onboarding_completed` –∞–ª–µ—Ä—Ç –¥–ª—è `avatar_demo`
- [ ] `credits_spent: 0` –¥–ª—è –¥–µ–º–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ test
- [ ] –¢–µ—Å—Ç: `/start` —Å UTM yandex/cpc + –∞–≤–∞—Ç–∞—Ä–∫–∞ ‚Üí –¥–µ–º–æ-—Å—Ç–∏–∫–µ—Ä
- [ ] –¢–µ—Å—Ç: `/start` –±–µ–∑ UTM ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π flow
- [ ] –¢–µ—Å—Ç: `/start` —Å UTM, –±–µ–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏ ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π flow
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ prod
