# AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∏–∫–µ—Ä–æ–≤

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

AI-–ø–æ–º–æ—â–Ω–∏–∫ ‚Äî —ç—Ç–æ —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∏–∫–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å LLM.
–ü–æ–º–æ—â–Ω–∏–∫ –±–µ—Ä—ë—Ç –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å–æ–±–∏—Ä–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è,
–∑–µ—Ä–∫–∞–ª–∏—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ, —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ä–µ—à–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.

**–ö–ª—é—á–µ–≤–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç –Ω–µ –∑–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É, –∞ –∑–∞ **—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ**.

- –û–ø–ª–∞—Ç–∞ ‚â† —Ñ–∏–Ω–∞–ª
- –û—à–∏–±–∫–∞ = –∏—Å–ø—Ä–∞–≤–∏–º–∞
- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å = –Ω–∞ —Å–∏—Å—Ç–µ–º–µ

**–í–∞–∂–Ω–æ:** –ø–æ–º–æ—â–Ω–∏–∫ –ù–ï –∂–¥—ë—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–Ω —Å–∞–º –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥
—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `/start`, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏ –ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ. –í—Å–µ–≥–¥–∞, –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

---

## 2. –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã

| | AI-–ø–æ–º–æ—â–Ω–∏–∫ | –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º |
|---|---|---|
| –í—Ö–æ–¥ | `/start` ‚Üí –ø–æ–º–æ—â–Ω–∏–∫ —Å–∞–º –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ | –ö–Ω–æ–ø–∫–∞ "üé® –°—Ç–∏–ª–∏" –≤ –Ω–∏–∂–Ω–µ–º –º–µ–Ω—é |
| –ü–µ—Ä–≤—ã–π —à–∞–≥ | –ü–æ–º–æ—â–Ω–∏–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏ –ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä—É–ø–ø—ã —Å—Ç–∏–ª–µ–π |
| –í—ã–±–æ—Ä —Å—Ç–∏–ª—è | –ß–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ | –ß–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ (–≥—Ä—É–ø–ø—ã ‚Üí –ø–æ–¥—Å—Ç–∏–ª–∏) |
| –≠–º–æ—Ü–∏—è/–ø–æ–∑–∞ | –ß–µ—Ä–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ª–æ–≥ | –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| –ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–≤—Å–µ–≥–¥–∞) | –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ |
| Paywall | –¢–µ –∂–µ `CREDIT_PACKS`, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π | –ö–∞–∫ —Å–µ–π—á–∞—Å |

**–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º = —Ç–µ–∫—É—â–∏–π –∫–æ–¥, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.**

–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ ‚Äî —á–µ—Ä–µ–∑ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é, –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.

---

## 3. –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (persistent keyboard)

–ë—ã–ª–æ:
```
[‚ú® –ï—â—ë —Å—Ç–∏–∫–µ—Ä—ã]  [‚ùì –ü–æ–º–æ—â—å]
```

–°—Ç–∞–ª–æ:
```
[ü§ñ –ü–æ–º–æ—â–Ω–∏–∫]  [üé® –°—Ç–∏–ª–∏]
[üí∞ –ë–∞–ª–∞–Ω—Å]    [‚ùì –ü–æ–º–æ—â—å]
```

- **ü§ñ –ü–æ–º–æ—â–Ω–∏–∫** ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å AI-–ø–æ–º–æ—â–Ω–∏–∫–æ–º (–µ—Å–ª–∏ —É–∂–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)
- **üé® –°—Ç–∏–ª–∏** ‚Üí —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º (—Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ `sendStyleGroupsKeyboard`)
- **üí∞ –ë–∞–ª–∞–Ω—Å** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å + –ø–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤
- **‚ùì –ü–æ–º–æ—â—å** ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## 4. –§–ª–æ—É AI-–ø–æ–º–æ—â–Ω–∏–∫–∞

```
/start (–∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "ü§ñ –ü–æ–º–æ—â–Ω–∏–∫")
   ‚Üì
–®–∞–≥ 0: –ü–æ–º–æ—â–Ω–∏–∫ —Å–∞–º –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥:
   "–ü—Ä–∏–≤–µ—Ç, {first_name}! üëã
    –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Å—Ç–∏–∫–µ—Ä–æ–≤.
    –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–±–µ —Ç–æ—á–Ω–æ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è.
    
    –ü—Ä–∏—à–ª–∏ –º–Ω–µ —Ñ–æ—Ç–æ, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∏–∫–µ—Ä."
   ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Ñ–æ—Ç–æ
   (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ sessions.photo_file_id, –∫–∞–∫ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ)
   ‚Üì
–®–∞–≥ 1: "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –æ–ø–∏—à–∏ —Å—Ç–∏–ª—å —Å—Ç–∏–∫–µ—Ä–∞ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏"
   ‚Üì
–®–∞–≥ 2: "–ö–∞–∫—É—é —ç–º–æ—Ü–∏—é –ø–µ—Ä–µ–¥–∞—Ç—å?"
   ‚Üì
–®–∞–≥ 3: "–ö–∞–∫–∞—è –ø–æ–∑–∞ –∏–ª–∏ –∂–µ—Å—Ç?"
   ‚Üì
–®–∞–≥ 4: –ó–µ—Ä–∫–∞–ª–∏—Ç:
   "–ü—Ä–æ–≤–µ—Ä—å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —è —Ç–µ–±—è –ø–æ–Ω—è–ª:
    ‚Äì –°—Ç–∏–ª—å: {style}
    ‚Äì –≠–º–æ—Ü–∏—è: {emotion}
    ‚Äì –ü–æ–∑–∞: {pose}
    
    –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî —Å–∫–∞–∂–∏, —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å."
   
   [‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å]  (inline-–∫–Ω–æ–ø–∫–∞)
   ‚Üì
–®–∞–≥ 5 (–µ—Å–ª–∏ –Ω–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤):
   "–°—Ç–∏–∫–µ—Ä –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å—Ç—Ä–æ–≥–æ –ø–æ —ç—Ç–∏–º —Ä–µ—à–µ–Ω–∏—è–º."
   
   [–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ]
   ‚Üí –ü–∞–∫–µ—Ç—ã –æ–ø–ª–∞—Ç—ã (—Ç–µ –∂–µ CREDIT_PACKS) ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
   ‚Üì
–®–∞–≥ 5 (–µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç—ã):
   "–û—Ç–ª–∏—á–Ω–æ! –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ç–∏–∫–µ—Ä –ø–æ —ç—Ç–∏–º —Ä–µ—à–µ–Ω–∏—è–º."
   ‚Üí –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   ‚Üì
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
   ‚Üí –¢–µ–∫—É—â–∏–π —Ñ–ª–æ—É: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∏–∫–µ—Ä + –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (—ç–º–æ—Ü–∏—è/–ø–æ–∑–∞/–¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–∫)
```

### –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞

```
–ü–æ–º–æ—â–Ω–∏–∫ –≤–µ–¥—ë—Ç –¥–∏–∞–ª–æ–≥ ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
   ‚Üì
"–í–∏–∂—É –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ! –° –∫–∞–∫–∏–º –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å?"
   [‚úÖ –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ]  [‚ùå –û—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–µ–µ]
```

### –û–ø—ã—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (total_generations > 10)

–ü–æ–º–æ—â–Ω–∏–∫ –º–æ–∂–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —à–∞–≥–∏ 1-3 –≤ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å:

```
"–ü—Ä–∏–≤–µ—Ç! –í–∏–∂—É, —Ç—ã —É–∂–µ –æ–ø—ã—Ç–Ω—ã–π üí™
 –û–ø–∏—à–∏ —Å—Ä–∞–∑—É: —Å—Ç–∏–ª—å, —ç–º–æ—Ü–∏—é –∏ –ø–æ–∑—É ‚Äî –∏ —è —Å—Ä–∞–∑—É –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é."
```

---

## 5. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞

### –ú–æ–¥–µ–ª—å: `gemini-2.0-flash`

–ó–∞–¥–∞—á–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è (—Å–∫—Ä–∏–ø—Ç –∏–∑ 5 —à–∞–≥–æ–≤), Flash –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
~6-8 –≤—ã–∑–æ–≤–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, ~$0.0006 –∑–∞ –ø–æ–ª–Ω—ã–π –¥–∏–∞–ª–æ–≥.

### –ü—Ä–æ–º–ø—Ç

```
# Role

You are a sticker creation assistant.
Your task is to **greet the user**, **collect a photo**, **understand their vision**,
**lock in decisions**, and **prepare the generation**.

You **take responsibility for the result**.

---

## User Context (injected per session)

- Name: {{first_name}}
- Language: {{language_code}} ‚Üí respond in this language
- Is Premium: {{is_premium}}
- Total generations: {{total_generations}}
- Has credits: {{credits > 0}}
- Has photo: {{has_photo}}

## Language Rules

- Your FIRST message MUST be in the user's language (based on language_code)
- If language_code starts with "ru" ‚Üí speak Russian
- Otherwise ‚Üí speak English
- Always match the user's language in responses
- Address user by their first name

---

## Behavior Principles

1. ‚ùå Do NOT generate any image until all decisions are fixed and confirmed.
2. ‚ùå Do NOT suggest options on your own if the user has already expressed a preference.
3. ‚úÖ YOU initiate the conversation. Do not wait for the user to act first.
4. ‚úÖ Always mirror the user's decisions before moving forward.
5. Speak simply and clearly. No marketing language. Do not mention AI, models, or neural networks.
6. If the user is unsure, help them clarify ‚Äî do not choose for them.

---

## Conversation Structure (must follow strictly)

### Step 0. Greeting & Photo Request

YOU start the conversation. Greet the user and ask for a photo:

> Hi, {first_name}! üëã
> I'm your sticker creation assistant.
> My job is to make sure you love the result.
>
> Send me a photo you'd like to turn into a sticker.

If the user writes text instead of sending a photo, gently remind them:

> I need a photo first ‚Äî send me the one you want to use for the sticker.

Do NOT proceed to Step 1 until a photo is received.

---

### Step 1. Base Style

After the photo is received, ask:

> Great photo! Now let's decide on the **style**.
> Describe it in your own words (for example: simple line art, cartoonish, minimal, detailed, etc.).

If the answer is vague, ask **one clarifying question only**.

**For experienced users (total_generations > 10):**
You may combine Steps 1-3 into one question:
> Great photo! You already know the drill üí™
> Describe the style, emotion, and pose ‚Äî and I'll prepare everything.

---

### Step 2. Emotion

Ask:

> What **emotion** should this sticker convey?
> One word or a short description is enough.

---

### Step 3. Pose / Gesture

Ask:

> What **pose or gesture** best expresses this emotion?
> Describe it as best as you can ‚Äî it doesn't have to be precise.

---

### Step 4. Mirror Understanding (critical)

After receiving all three answers, respond in **one single message**:

> Please check if I understood you correctly:
> ‚Äì **Style:** {style}
> ‚Äì **Emotion:** {emotion}
> ‚Äì **Pose / gesture:** {pose}
>
> If anything is off, tell me what to change.

‚ùó Do not ask new questions after this message.
‚ùó Do not generate any image.
‚ùó After this message, the system will show an inline [‚úÖ Confirm] button.

At the end of this message, append a hidden metadata block:
<!-- PARAMS:{"style":"...","emotion":"...","pose":"...","confirmed":false,"step":4} -->

---

### Step 5. Lock-in & Proceed

After the user confirms (via inline button or text like "ok", "–¥–∞", "confirm"):

**If user has credits:**
> Great. Generating your sticker now based on these decisions.

**If user has no credits:**

*Premium user (is_premium == true):*
> Everything is set. Choose a credit pack and I'll generate your sticker.

*Regular user (is_premium == false):*
> The sticker will be generated strictly based on what we agreed.
> Choose a pack to proceed.

Append metadata:
<!-- PARAMS:{"style":"...","emotion":"...","pose":"...","confirmed":true,"step":5} -->

---

## Metadata Rules

After EVERY response starting from Step 1, append a hidden metadata block at the very end:
<!-- PARAMS:{"style":"...or null","emotion":"...or null","pose":"...or null","confirmed":false,"step":N} -->

This allows the system to track progress without extra API calls.

---

## Payment Behavior

- If is_premium == true:
  Be direct and confident about payment. No explanations needed.
  Premium users know how bots work ‚Äî don't over-explain.

- If is_premium == false:
  Reassure the user about quality. Emphasize that the sticker will match
  their decisions exactly. More warmth, more confidence in result.

---

## Handling Edge Cases

- User sends text before photo ‚Üí remind them to send a photo first
- User sends a new photo mid-conversation ‚Üí "New photo! Which one should we use?" and wait
- User says something off-topic ‚Üí gently redirect to the current step
- User confirms partially ‚Üí ask about the remaining parameter

---

## Forbidden

- ‚ùå Generating an image before confirmation
- ‚ùå Mentioning "AI", "model", or "neural network"
- ‚ùå Blaming the user for unclear input
- ‚ùå Saying "let's try and see what happens"
- ‚ùå Waiting passively ‚Äî YOU always drive the conversation forward

---

## Tone

Calm, confident, and collaborative.
You are not selling ‚Äî you are **taking responsibility for implementing the agreed decisions**.
```

---

## 6. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ Telegram

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| `first_name` | `ctx.from` | "–ú–∞–∫—Å" |
| `last_name` | `ctx.from` | "–ê–∑–∞—Ä–æ–≤" |
| `username` | `ctx.from` | "mazarov" |
| `language_code` | `ctx.from` | "ru", "pt-br", "en" |
| `is_premium` | `ctx.from` | true/false |
| `lang` | DB users | "ru" / "en" |
| `credits` | DB users | 0, 5, 30 |
| `has_purchased` | DB users | true/false |
| `total_generations` | DB users | 0, 15, 100 |

### –ö–∞–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

| –î–∞–Ω–Ω—ã–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–º–æ—â–Ω–∏–∫–∞ |
|--------|---------------------|
| `first_name` | –û–±—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏ |
| `language_code` | –ì–æ–≤–æ—Ä–∏—Ç –Ω–∞ —Ä–æ–¥–Ω–æ–º —è–∑—ã–∫–µ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ –ø—Ä–æ–º–ø—Ç–µ) |
| `is_premium` | Premium ‚Üí —É–≤–µ—Ä–µ–Ω–Ω—ã–π —Ç–æ–Ω –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ, –±–µ–∑ —É–≥–æ–≤–æ—Ä–æ–≤ |
| `total_generations = 0` | –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Üí –±–æ–ª—å—à–µ –∑–∞–±–æ—Ç—ã, –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–±—ä—è—Å–Ω—è–µ—Ç |
| `total_generations > 10` | –û–ø—ã—Ç–Ω—ã–π ‚Üí –º–æ–∂–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —à–∞–≥–∏ 1-3 –≤ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å |
| `credits > 0` | –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç paywall, —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç |
| `credits = 0` | –í–∫–ª—é—á–∞–µ—Ç —à–∞–≥ —Å –æ–ø–ª–∞—Ç–æ–π |

### –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ (—à–∞–≥ 0) –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
–≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (`assistant_messages[0].content`). –î–∞–ª—å—à–µ –±–µ—Ä—ë—Ç—Å—è –æ—Ç—Ç—É–¥–∞ ‚Äî
–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –Ω–µ –Ω—É–∂–Ω–æ.

### –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Telegram –Ω–µ –¥–∞—ë—Ç)

- –í–æ–∑—Ä–∞—Å—Ç
- –ü–æ–ª
- –°—Ç—Ä–∞–Ω–∞/–≥–æ—Ä–æ–¥ (—Ç–æ–ª—å–∫–æ `language_code` –∫–∞–∫ –∫–æ—Å–≤–µ–Ω–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫)

---

## 7. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 7.1 –ù–æ–≤—ã–µ states

```
assistant_wait_photo   ‚Üí –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–ø—Ä–æ—Å–∏–ª —Ñ–æ—Ç–æ, –∂–¥—ë–º —Ñ–æ—Ç–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
assistant_chat         ‚Üí –¥–∏–∞–ª–æ–≥ —Å –ø–æ–º–æ—â–Ω–∏–∫–æ–º (–≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí Gemini)
wait_assistant_confirm ‚Üí –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –∂–¥—ë–º inline-–∫–Ω–æ–ø–∫—É [‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å]
```

### 7.2 –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

–ù–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ `sessions`:

```sql
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS assistant_messages jsonb DEFAULT '[]';
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS assistant_params jsonb DEFAULT null;
-- assistant_params = { "style": "...", "emotion": "...", "pose": "..." }
```

–§–æ—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º `sessions.photo_file_id` ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

`assistant_messages` —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é:
```json
[
  {"role": "system", "content": "...—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º..."},
  {"role": "assistant", "content": "–ü—Ä–∏–≤–µ—Ç, –ú–∞–∫—Å! üëã –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫..."},
  {"role": "user", "content": "—Ö–æ—á—É –≤ —Å—Ç–∏–ª–µ –∞–Ω–∏–º–µ"},
  {"role": "assistant", "content": "–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫—É—é —ç–º–æ—Ü–∏—é...<!-- PARAMS:{...} -->"}
]
```

### 7.3 –ó–∞–ø—É—Å–∫ –ø–æ–º–æ—â–Ω–∏–∫–∞

```
/start –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "ü§ñ –ü–æ–º–æ—â–Ω–∏–∫" (–µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞)
   ‚Üì
1. –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é —Å state = "assistant_wait_photo"
2. –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–¥–∏–Ω SELECT –∏–∑ users)
3. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
4. –í—ã–∑—ã–≤–∞–µ–º Gemini ‚Äî –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –ø—Ä–æ—Å—å–±—É –ø—Ä–∏—Å–ª–∞—Ç—å —Ñ–æ—Ç–æ
5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ assistant_messages
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
7. –ñ–¥—ë–º —Ñ–æ—Ç–æ

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –¥–∏–∞–ª–æ–≥–µ –ø–æ–º–æ—â–Ω–∏–∫–∞
–∏ –Ω–∞–∂–∏–º–∞–µ—Ç "ü§ñ –ü–æ–º–æ—â–Ω–∏–∫" ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (–æ–Ω —É–∂–µ —Ç–∞–º).
```

### 7.4 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

```
–í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
1. –ö–æ–º–∞–Ω–¥—ã (/start, /balance) ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–æ
2. –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é ("ü§ñ –ü–æ–º–æ—â–Ω–∏–∫", "üé® –°—Ç–∏–ª–∏", "üí∞ –ë–∞–ª–∞–Ω—Å", "‚ùì –ü–æ–º–æ—â—å") ‚Üí —Å–≤–æ–∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã
3. session.state == "assistant_wait_photo" + –ø–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ
   ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º photo_file_id, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ assistant_chat
4. session.state == "assistant_wait_photo" + —Ç–µ–∫—Å—Ç
   ‚Üí "–ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞" (–Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ)
5. session.state == "assistant_chat" ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Gemini
6. session.state == "wait_assistant_confirm" ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
7. –û—Å—Ç–∞–ª—å–Ω—ã–µ states ‚Üí —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞
```

### 7.5 –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∂–∏–º–µ –ø–æ–º–æ—â–Ω–∏–∫–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Ç–µ–∫—Å—Ç, state == "assistant_chat"
   ‚Üì
1. –ë–µ—Ä—ë–º session.assistant_messages
2. –î–æ–±–∞–≤–ª—è–µ–º {role: "user", content: —Ç–µ–∫—Å—Ç}
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Gemini 2.0 Flash (chat mode)
4. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
5. –ü–∞—Ä—Å–∏–º <!-- PARAMS:{...} --> –∏–∑ –æ—Ç–≤–µ—Ç–∞
6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç (—Å metadata) –≤ assistant_messages
7. –£–±–∏—Ä–∞–µ–º <!-- PARAMS:... --> –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
8. –ï—Å–ª–∏ params.step == 4 && params.confirmed == false:
   ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º inline-–∫–Ω–æ–ø–∫—É [‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å]
   ‚Üí state = "wait_assistant_confirm"
9. –ï—Å–ª–∏ params.confirmed == true:
   ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º assistant_params
   ‚Üí –µ—Å–ª–∏ credits > 0 ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
   ‚Üí –µ—Å–ª–∏ credits = 0 ‚Üí paywall (—Ç–µ –∂–µ CREDIT_PACKS)
```

### 7.6 –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ –ø—Ä–æ–º–ø—Ç)

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ metadata-–±–ª–æ–∫–∞ `<!-- PARAMS:{...} -->`,
–∫–æ—Ç–æ—Ä—ã–π –º–æ–¥–µ–ª—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç –≤ –∫–æ–Ω–µ—Ü –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å —à–∞–≥–∞ 1).

**–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è** –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ Gemini –¥–ª—è extraction.

Fallback (–µ—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ metadata –Ω–µ —É–¥–∞–ª—Å—è) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ Gemini:

```
Extract from this conversation the agreed decisions.
Return ONLY valid JSON:
{
  "style": "–æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∏–ª—è or null",
  "emotion": "—ç–º–æ—Ü–∏—è or null",
  "pose": "–ø–æ–∑–∞/–∂–µ—Å—Ç or null",
  "confirmed": true/false,
  "step": 0-5
}
```

### 7.7 Inline-–∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–ü–æ—Å–ª–µ —à–∞–≥–∞ 4 (–∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:

```
[‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å]

callback_data: "assistant_confirm"
```

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏:
- –°–æ—Ö—Ä–∞–Ω—è–µ–º `assistant_params` –≤ —Å–µ—Å—Å–∏—é
- –ï—Å–ª–∏ `credits > 0` ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- –ï—Å–ª–∏ `credits = 0` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã –æ–ø–ª–∞—Ç—ã (paywall)

### 7.8 –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```typescript
// –í startGeneration() ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
async function startGeneration(ctx, user, session) {
  let promptFinal: string;
  let styleLabel: string;

  if (session.assistant_params) {
    // === –†–µ–∂–∏–º –ø–æ–º–æ—â–Ω–∏–∫–∞ ===
    const { style, emotion, pose } = session.assistant_params;
    styleLabel = `assistant: ${style}`;
    promptFinal = buildAssistantPrompt(style, emotion, pose);
  } else {
    // === –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (–∫–∞–∫ —Å–µ–π—á–∞—Å) ===
    const styleConfig = STYLES[session.selected_style_id];
    styleLabel = session.selected_style_id;
    promptFinal = styleConfig.prompt;
  }

  // –î–∞–ª—å—à–µ –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞: —Å–æ–∑–¥–∞–Ω–∏–µ job, –≤—ã–∑–æ–≤ Gemini image generation...
}

function buildAssistantPrompt(style: string, emotion: string, pose: string): string {
  return `Create a telegram sticker of the person from the photo.

Style: ${style}
Emotion: ${emotion}
Pose/gesture: ${pose}

Requirements:
- White/transparent background
- Sticker-like proportions (head slightly larger)
- Clear outlines
- Expressive and recognizable`;
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- `session.assistant_params !== null` ‚Äî –º–∞—Ä–∫–µ—Ä —á—Ç–æ —ç—Ç–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞
- `styleLabel` –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤/–ª–æ–≥–æ–≤ = `"assistant: anime cute"`
- `buildAssistantPrompt()` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å —à–∞–±–ª–æ–Ω
- –í—Å—è –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (job creation, deduct credits, worker) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Äî —Ç–µ–∫—É—â–∏–π —Ñ–ª–æ—É: —Å—Ç–∏–∫–µ—Ä + –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π

### 7.9 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Gemini –≤ –¥–∏–∞–ª–æ–≥–µ

–¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:

```
–£—Ä–æ–≤–µ–Ω—å 1: Transparent retry (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç)
   Gemini ‚Üí –æ—à–∏–±–∫–∞/timeout
   ‚Üì
   Retry 1 —á–µ—Ä–µ–∑ 2 —Å–µ–∫ (—Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å)
   ‚Üì
   Retry 2 —á–µ—Ä–µ–∑ 4 —Å–µ–∫

–£—Ä–æ–≤–µ–Ω—å 2: –ú—è–≥–∫–∏–π fallback (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç)
   –ï—Å–ª–∏ 2 retry –Ω–µ –ø–æ–º–æ–≥–ª–∏:
   ‚Üì
   "–ò–∑–≤–∏–Ω–∏, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å –µ—â—ë —Ä–∞–∑."
   (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ assistant_messages)

–£—Ä–æ–≤–µ–Ω—å 3: Escape –≤ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º
   –ï—Å–ª–∏ 3-–π —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ –æ—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏:
   ‚Üì
   "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–º–æ—â–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω üòî
    –ù–∞–∂–º–∏ üé® –°—Ç–∏–ª–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å –≤—Ä—É—á–Ω—É—é."
   (—Å–µ—Å—Å–∏—è –ø–æ–º–æ—â–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ)
```

–ê–ª–µ—Ä—Ç –≤ –∫–∞–Ω–∞–ª: `assistant_gemini_error` —Å user_id –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º retry.

---

## 8. –¢–∏—à–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
30 –º–∏–Ω –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –≤ assistant_chat –∏–ª–∏ assistant_wait_photo:
   ‚Üí –°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (state ‚Üí "expired").
   ‚Üí –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.
```

–ë–µ–∑ reminder. –¢–∏—Ö–æ–µ –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ.

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏: —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–∫–∞–∫ abandoned cart) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏–∏ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

---

## 9. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ)         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [ü§ñ –ü–æ–º–æ—â–Ω–∏–∫]  [üé® –°—Ç–∏–ª–∏]                 ‚îÇ
‚îÇ  [üí∞ –ë–∞–ª–∞–Ω—Å]    [‚ùì –ü–æ–º–æ—â—å]                 ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ü§ñ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç AI-–¥–∏–∞–ª–æ–≥ (–Ω–æ–≤—ã–π)           ‚îÇ
‚îÇ       –µ—Å–ª–∏ —É–∂–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è     ‚îÇ
‚îÇ  üé® ‚Üí —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º (—Ç–µ–∫—É—â–∏–µ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∏–ª–µ–π)  ‚îÇ
‚îÇ  üí∞ ‚Üí –±–∞–ª–∞–Ω—Å + –ø–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤              ‚îÇ
‚îÇ  ‚ùì ‚Üí –ø–æ–º–æ—â—å                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ

| –î–µ–π—Å—Ç–≤–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|-----------|
| `/start` | –ü–æ–º–æ—â–Ω–∏–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ (–≤—Å–µ–≥–¥–∞) |
| –ö–Ω–æ–ø–∫–∞ "ü§ñ –ü–æ–º–æ—â–Ω–∏–∫" | –ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥. –ï—Å–ª–∏ —É–∂–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è. |
| –í –ø–æ–º–æ—â–Ω–∏–∫–µ ‚Üí –Ω–∞–∂–∞–ª "üé® –°—Ç–∏–ª–∏" | –ü–æ–º–æ—â–Ω–∏–∫ –ø–∞—É–∑–∏—Ç—Å—è. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å—Ç–∏–ª–∏. |
| –í —Å—Ç–∏–ª—è—Ö ‚Üí –Ω–∞–∂–∞–ª "ü§ñ –ü–æ–º–æ—â–Ω–∏–∫" | –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –ø–æ–º–æ—â–Ω–∏–∫–æ–º. |
| –û—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ (–≤–Ω–µ –¥–∏–∞–ª–æ–≥–∞) | –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ–º–æ—â–Ω–∏–∫ —Å —à–∞–≥–∞ 1 (—Å—Ç–∏–ª—å). |
| –û—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞ | "–ù–æ–≤–æ–µ —Ñ–æ—Ç–æ! –° –∫–∞–∫–∏–º —Ä–∞–±–æ—Ç–∞–µ–º?" [–ù–æ–≤–æ–µ] [–ü—Ä–µ–∂–Ω–µ–µ] |

---

## 10. –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –û—Ü–µ–Ω–∫–∞: ~21-27 —á–∞—Å–æ–≤

| –ë–ª–æ–∫ | –ß–∞—Å—ã | –î–æ–ª—è |
|------|------|------|
| 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | ~2—á | 8% |
| 2. Gemini Chat API | ~6-8—á | 30% |
| 3. States + –æ–±—Ä–∞–±–æ—Ç–∫–∞ | ~5-6—á | 24% |
| 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π | ~3-4—á | 16% |
| 5. Edge cases | ~3-4—á | 14% |
| 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ~2-3—á | 8% |

### –ü–æ—Ä—è–¥–æ–∫ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
–®–∞–≥ 1 (SQL)
   ‚Üì
–®–∞–≥ 2 (gemini-chat.ts)  ‚Üê‚Üí  –®–∞–≥ 3 (–º–µ–Ω—é + –∫–Ω–æ–ø–∫–∏)   [–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ]
   ‚Üì                              ‚Üì
–®–∞–≥ 4 (/start + wait_photo)
   ‚Üì
–®–∞–≥ 5 (assistant_chat ‚Äî —è–¥—Ä–æ)
   ‚Üì
–®–∞–≥ 6 (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è + –æ–ø–ª–∞—Ç–∞)
   ‚Üì
–®–∞–≥ 7 (edge cases)
   ‚Üì
–®–∞–≥ 8 (—Ç–µ–∫—Å—Ç—ã + —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
```

### Milestone'—ã (–∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å)

| Milestone | –ü–æ—Å–ª–µ —à–∞–≥–∞ | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º |
|-----------|------------|---------------|
| **M1: –ú–µ–Ω—é** | 3 | 4 –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, —Å—Ç–∞—Ä—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ —Å–ª–æ–º–∞–Ω |
| **M2: –î–∏–∞–ª–æ–≥** | 5 | –ü–æ–ª–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø–æ–º–æ—â–Ω–∏–∫–∞ –¥–æ –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è |
| **M3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è** | 6 | –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≤–∫–ª. –æ–ø–ª–∞—Ç—É –∏ —Å—Ç–∏–∫–µ—Ä |
| **M4: Production** | 8 | –í—Å–µ edge cases, –¥–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥ |

---

### –®–∞–≥ 1. SQL –º–∏–≥—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `sql/043_assistant_columns.sql` (–Ω–æ–≤—ã–π)
**–í—Ä–µ–º—è:** 15 –º–∏–Ω | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –Ω–µ—Ç

```sql
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS assistant_messages jsonb DEFAULT '[]';
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS assistant_params jsonb DEFAULT null;
```

–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ Supabase SQL Editor.
–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–æ–ª–±—Ü—ã —Å DEFAULT, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `SELECT column_name FROM information_schema.columns WHERE table_name = 'sessions' AND column_name LIKE 'assistant%'` ‚Üí 2 —Å—Ç—Ä–æ–∫–∏.

---

### –®–∞–≥ 2. Gemini Chat —Ñ—É–Ω–∫—Ü–∏—è + —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
**–§–∞–π–ª:** `src/lib/gemini-chat.ts` (–Ω–æ–≤—ã–π)
**–í—Ä–µ–º—è:** 3-4—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –®–∞–≥ 1

–°–æ–∑–¥–∞—ë–º **–æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å** (–Ω–µ –≤ `index.ts`!) —Å —Ç—Ä–µ–º—è —Ñ—É–Ω–∫—Ü–∏—è–º–∏:

| –§—É–Ω–∫—Ü–∏—è | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|---------|------------|
| `buildSystemPrompt(context)` | –°–æ–±–∏—Ä–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (~100 —Å—Ç—Ä–æ–∫) —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `callGeminiChat(messages, systemPrompt)` | –í—ã–∑–æ–≤ `gemini-2.0-flash:generateContent` —Å retry (2—Å, 4—Å) |
| `parseAssistantMetadata(text)` | –ü–∞—Ä—Å–∏—Ç `<!-- PARAMS:{...} -->` –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ |

–î–µ—Ç–∞–ª–∏ `callGeminiChat`:
- –≠–Ω–¥–ø–æ–∏–Ω—Ç: `generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`
- –§–æ—Ä–º–∞—Ç: `systemInstruction` + `contents[]` (–ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –µ—Å—Ç—å –≤ `index.ts:383-397`)
- Retry: 2 –ø–æ–ø—ã—Ç–∫–∏ —Å backoff ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–æ–∑–≤—Ä–∞—Ç: `{ text: string, params: AssistantParams | null, rawText: string }`

–î–µ—Ç–∞–ª–∏ `parseAssistantMetadata`:
- Regex: `/<!-- PARAMS:(.*?) -->/s`
- `JSON.parse` + –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π `{style, emotion, pose, confirmed, step}`
- –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è ‚Üí `params = null`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—ã–∑–æ–≤ `callGeminiChat` —Å —Ç–µ—Å—Ç–æ–≤—ã–º –ø—Ä–æ–º–ø—Ç–æ–º ‚Üí –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏ –ø–∞—Ä—Å–∏—Ç—Å—è.

---

### –®–∞–≥ 3. –ú–µ–Ω—é + –Ω–æ–≤—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∫–Ω–æ–ø–æ–∫
**–§–∞–π–ª:** `src/index.ts`
**–í—Ä–µ–º—è:** 1.5—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –Ω–µ—Ç (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —à–∞–≥–æ–º 2)

**3a. –û–±–Ω–æ–≤–∏—Ç—å `getMainMenuKeyboard()`** (—Å—Ç—Ä–æ–∫–∞ 579-585)

–ë—ã–ª–æ: 2 –∫–Ω–æ–ø–∫–∏ –≤ 1 —Å—Ç—Ä–æ–∫—É `["‚ú® –ï—â—ë —Å—Ç–∏–∫–µ—Ä—ã", "‚ùì –ü–æ–º–æ—â—å"]`
–°—Ç–∞–ª–æ: 4 –∫–Ω–æ–ø–∫–∏ –≤ 2 —Å—Ç—Ä–æ–∫–∏:
```typescript
const row1 = lang === "ru" ? ["ü§ñ –ü–æ–º–æ—â–Ω–∏–∫", "üé® –°—Ç–∏–ª–∏"] : ["ü§ñ Assistant", "üé® Styles"];
const row2 = lang === "ru" ? ["üí∞ –ë–∞–ª–∞–Ω—Å", "‚ùì –ü–æ–º–æ—â—å"] : ["üí∞ Balance", "‚ùì Help"];
return Markup.keyboard([row1, row2]).resize().persistent();
```

**3b. –û–±–Ω–æ–≤–∏—Ç—å `bot.hears`** (—Å—Ç—Ä–æ–∫–∏ 828-850)

- `bot.hears(["‚ú® –ï—â—ë —Å—Ç–∏–∫–µ—Ä—ã", ...])` ‚Üí –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –Ω–∞ `["üí∞ –ë–∞–ª–∞–Ω—Å", "üí∞ Balance"]`
- –î–æ–±–∞–≤–∏—Ç—å `bot.hears(["üé® –°—Ç–∏–ª–∏", "üé® Styles"])` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `sendStyleKeyboardFlat(ctx, lang)`
- –î–æ–±–∞–≤–∏—Ç—å `bot.hears(["ü§ñ –ü–æ–º–æ—â–Ω–∏–∫", "ü§ñ Assistant"])` ‚Üí –∑–∞–≥–ª—É—à–∫–∞ (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —à–∞–≥–µ 4)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `/start` ‚Üí 4 –∫–Ω–æ–ø–∫–∏ ‚Üí –∫–∞–∂–¥–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç ‚Üí —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º –Ω–µ —Å–ª–æ–º–∞–Ω.

---

### –®–∞–≥ 4. `/start` ‚Üí AI-–ø–æ–º–æ—â–Ω–∏–∫ + state `assistant_wait_photo`
**–§–∞–π–ª:** `src/index.ts`
**–í—Ä–µ–º—è:** 2-3—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –®–∞–≥ 2, –®–∞–≥ 3

**4a. –ò–∑–º–µ–Ω–∏—Ç—å `bot.start()`** (—Å—Ç—Ä–æ–∫–∏ 658-746)

–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞: `/start` ‚Üí —Å–µ—Å—Å–∏—è `wait_photo` ‚Üí `reply(greeting)`
–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
```
/start ‚Üí —Å–µ—Å—Å–∏—è state="assistant_wait_photo"
       ‚Üí —Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (user.credits, total_generations, ctx.from)
       ‚Üí buildSystemPrompt(context)
       ‚Üí callGeminiChat([], systemPrompt)   // –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
       ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å assistant_messages –≤ —Å–µ—Å—Å–∏—é
       ‚Üí reply(–æ—Ç–≤–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞)  // "–ü—Ä–∏–≤–µ—Ç, –ú–∞–∫—Å! üëã –ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ..."
```

**4b. –•–µ–Ω–¥–ª–µ—Ä "ü§ñ –ü–æ–º–æ—â–Ω–∏–∫"**

```
bot.hears(["ü§ñ –ü–æ–º–æ—â–Ω–∏–∫", "ü§ñ Assistant"]) ‚Üí
  –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è —Å state assistant_* ‚Üí –∏–≥–Ω–æ—Ä
  –∏–Ω–∞—á–µ ‚Üí —Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞ —á—Ç–æ /start (—Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é + –≤—ã–∑–≤–∞—Ç—å Gemini)
```

**4c. –û–±–Ω–æ–≤–∏—Ç—å photo handler** (—Å—Ç—Ä–æ–∫–∏ 790-826)

–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ç–∫—É **–ø–µ—Ä–µ–¥** —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–æ–π:
```
if (session.state === "assistant_wait_photo") {
  ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å photo_file_id
  ‚Üí state = "assistant_chat"
  ‚Üí –¥–æ–±–∞–≤–∏—Ç—å {role:"user", content:"[photo received]"} –≤ messages
  ‚Üí callGeminiChat ‚Üí "–û—Ç–ª–∏—á–Ω–æ! –û–ø–∏—à–∏ —Å—Ç–∏–ª—å..."
  ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ assistant_messages
  ‚Üí reply –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  return;
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `/start` ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí —Ñ–æ—Ç–æ ‚Üí –±–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Ç–∏–ª—å.

---

### –®–∞–≥ 5. State `assistant_chat` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–ª–æ–≥
**–§–∞–π–ª:** `src/index.ts`
**–í—Ä–µ–º—è:** 3-4—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –®–∞–≥ 4

**5a. –í–µ—Ç–∫–∞ –≤ `bot.on("text")`** (—Å—Ç—Ä–æ–∫–∞ 853)

–í—Å—Ç–∞–≤–∏—Ç—å **–ø–µ—Ä–≤–æ–π** –ø—Ä–æ–≤–µ—Ä–∫–æ–π (–¥–æ `wait_custom_emotion` –Ω–∞ —Å—Ç—Ä–æ–∫–µ 869):
```
if (session.state === "assistant_chat") {
  1. –í–∑—è—Ç—å session.assistant_messages
  2. –î–æ–±–∞–≤–∏—Ç—å {role: "user", content: text}
  3. callGeminiChat(messages, systemPrompt)
  4. parseAssistantMetadata(response)
  5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ assistant_messages
  6. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –≤ –ë–î
  7. –£–±—Ä–∞—Ç—å <!-- PARAMS:... --> –∏–∑ —Ç–µ–∫—Å—Ç–∞
  8. Reply –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  9. –ï—Å–ª–∏ params.step === 4 && !params.confirmed:
     ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å inline [‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å]
     ‚Üí state = "wait_assistant_confirm"
  return;
}
```

**5b. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Gemini** (–≤–Ω—É—Ç—Ä–∏ –≤–µ—Ç–∫–∏)

```
–£—Ä–æ–≤–µ–Ω—å 1: Retry 2—Å, 4—Å (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ, –≤–Ω—É—Ç—Ä–∏ callGeminiChat)
–£—Ä–æ–≤–µ–Ω—å 2: –ï—Å–ª–∏ retry –Ω–µ –ø–æ–º–æ–≥–ª–∏ ‚Üí "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å –µ—â—ë —Ä–∞–∑"
–£—Ä–æ–≤–µ–Ω—å 3: –ï—Å–ª–∏ 3-–π —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Üí "–ü–æ–º–æ—â–Ω–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞–∂–º–∏ üé® –°—Ç–∏–ª–∏"
+ –∞–ª–µ—Ä—Ç assistant_gemini_error
```

**5c. Fallback extraction** (–µ—Å–ª–∏ metadata –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª—Å—è)

```
if (!params && messages.length >= 8) {
  params = await extractParamsFromConversation(messages); // –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ Gemini
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ–ª–Ω—ã–π –¥–∏–∞–ª–æ–≥: —Ñ–æ—Ç–æ ‚Üí —Å—Ç–∏–ª—å ‚Üí —ç–º–æ—Ü–∏—è ‚Üí –ø–æ–∑–∞ ‚Üí –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π.

---

### –®–∞–≥ 6. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è + –æ–ø–ª–∞—Ç–∞
**–§–∞–π–ª:** `src/index.ts`
**–í—Ä–µ–º—è:** 3-4—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –®–∞–≥ 5

**6a. `bot.action("assistant_confirm")`** (–Ω–æ–≤—ã–π)

```
1. –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å state === "wait_assistant_confirm"
2. –í–∑—è—Ç—å assistant_params –∏–∑ —Å–µ—Å—Å–∏–∏
3. –ï—Å–ª–∏ credits > 0 ‚Üí startGeneration() —Å assistant_params
4. –ï—Å–ª–∏ credits = 0 ‚Üí paywall (sendBuyCreditsMenu)
```

**6b. –ù–æ–≤—ã–π `generationType: "assistant"`**

–í `startGeneration()` (—Å—Ç—Ä–æ–∫–∞ 440): –¥–æ–±–∞–≤–∏—Ç—å `"assistant"` –≤ union type.

**6c. `buildAssistantPrompt()`** (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è)

```typescript
function buildAssistantPrompt(params: {style: string; emotion: string; pose: string}): string {
  return `Create a telegram sticker of the person from the photo.
Style: ${params.style}
Emotion: ${params.emotion}
Pose/gesture: ${params.pose}
Requirements: white background, sticker proportions, clear outlines, expressive`;
}
```

**6d. –û–±–Ω–æ–≤–∏—Ç—å `successful_payment`** (—Å—Ç—Ä–æ–∫–∏ 2706-2738)

–î–æ–±–∞–≤–∏—Ç—å: –µ—Å–ª–∏ `session.assistant_params` –∏ `!session.prompt_final`:
```typescript
const promptFinal = buildAssistantPrompt(session.assistant_params);
await supabase.from("sessions").update({ prompt_final: promptFinal }).eq("id", session.id);
```

–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Üí —Ç–µ–∫—É—â–∏–π —Ñ–ª–æ—É (—Å—Ç–∏–∫–µ—Ä + –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π).

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –¥–∏–∞–ª–æ–≥ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí paywall ‚Üí –æ–ø–ª–∞—Ç–∞ ‚Üí —Å—Ç–∏–∫–µ—Ä.

---

### –®–∞–≥ 7. Edge cases
**–§–∞–π–ª:** `src/index.ts`
**–í—Ä–µ–º—è:** 2-3—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –®–∞–≥ 6

**7a. –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞** (–≤ photo handler)

```
if (session.state === "assistant_chat" || session.state === "wait_assistant_confirm") {
  ‚Üí "–í–∏–∂—É –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ! –° –∫–∞–∫–∏–º —Ä–∞–±–æ—Ç–∞–µ–º?"
  ‚Üí [‚úÖ –ù–æ–≤–æ–µ —Ñ–æ—Ç–æ] [‚ùå –û—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–µ–µ]
}
```
+ `bot.action(/^assistant_new_photo:(.+)$/)` ‚Äî –∑–∞–º–µ–Ω–∞ photo_file_id
+ `bot.action("assistant_keep_photo")` ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º

**7b. –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–π —á–µ—Ä–µ–∑ 30 –º–∏–Ω**

–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `processExpiredAssistantSessions()`:
```sql
UPDATE sessions SET state='expired', is_active=false
WHERE state IN ('assistant_wait_photo','assistant_chat','wait_assistant_confirm')
  AND is_active=true AND updated_at < now() - interval '30 minutes'
```
–í—ã–∑—ã–≤–∞—Ç—å –≤ `setInterval` —Ä—è–¥–æ–º —Å `processAbandonedCarts()` (—Å—Ç—Ä–æ–∫–∞ 2948).

**7c. –¢–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ –≤ `assistant_wait_photo`** (–≤ text handler)

```
if (session.state === "assistant_wait_photo") {
  ‚Üí "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ üì∏"
  return;
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—Å–µ edge cases –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –±–æ—Ç–µ.

---

### –®–∞–≥ 8. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è + alert + —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–§–∞–π–ª—ã:** `src/lib/texts.ts`, `src/lib/alerts.ts`
**–í—Ä–µ–º—è:** 2—á | **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –®–∞–≥ 7

**8a.** `alerts.ts`: –¥–æ–±–∞–≤–∏—Ç—å `"assistant_gemini_error"` –≤ `AlertType` + emoji.

**8b.** `texts.ts`: –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–∏:
- `assistant.wait_photo` ‚Äî "–ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ üì∏"
- `assistant.error_retry` ‚Äî "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑"
- `assistant.error_fallback` ‚Äî "–ü–æ–º–æ—â–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω..."
- `assistant.new_photo` ‚Äî "–í–∏–∂—É –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ! –° –∫–∞–∫–∏–º —Ä–∞–±–æ—Ç–∞–µ–º?"

**8c.** E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ `@photo2sticker_test_bot`:

1. `/start` ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí —Ñ–æ—Ç–æ ‚Üí —Å—Ç–∏–ª—å ‚Üí —ç–º–æ—Ü–∏—è ‚Üí –ø–æ–∑–∞ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí paywall ‚Üí –æ–ø–ª–∞—Ç–∞ ‚Üí —Å—Ç–∏–∫–µ—Ä
2. `/start` ‚Üí —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
3. –î–∏–∞–ª–æ–≥ ‚Üí –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ ‚Üí –≤—ã–±–æ—Ä
4. –î–∏–∞–ª–æ–≥ ‚Üí 30 –º–∏–Ω —Ç–∏—à–∏–Ω—ã ‚Üí —Å–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞
5. –û—à–∏–±–∫–∞ Gemini ‚Üí retry ‚Üí fallback
6. –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é: –ü–æ–º–æ—â–Ω–∏–∫, –°—Ç–∏–ª–∏, –ë–∞–ª–∞–Ω—Å, –ü–æ–º–æ—â—å
7. –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ "üé® –°—Ç–∏–ª–∏" –Ω–µ —Å–ª–æ–º–∞–Ω

---

### –†–∏—Å–∫–∏

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-----------|
| Gemini Flash –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ —Å–ª–µ–¥—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É `<!-- PARAMS:{} -->` | –°—Ä–µ–¥–Ω—è—è | Fallback extraction + –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ |
| –ú–æ–Ω–æ–ª–∏—Ç `index.ts` (3007 —Å—Ç—Ä–æ–∫) ‚Äî —Å–ª—É—á–∞–π–Ω–æ —Å–ª–æ–º–∞—Ç—å handler | –°—Ä–µ–¥–Ω—è—è | –¢–µ—Å—Ç –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –±–æ—Ç–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º |
| `successful_payment` –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç `assistant_params` | –ù–∏–∑–∫–∞—è | –Ø–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `session.assistant_params` |
| –ü–æ—Ä—è–¥–æ–∫ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ `bot.on("text")` ‚Äî –Ω–æ–≤—ã–µ states –ø–µ—Ä–µ–±—å—é—Ç —Å—Ç–∞—Ä—ã–µ | –ù–∏–∑–∫–∞—è | –í—Å—Ç–∞–≤–ª—è—Ç—å `assistant_*` –≤–µ—Ç–∫–∏ –ø–µ—Ä–≤—ã–º–∏, –¥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö |

---

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–µ–ø–ª–æ—è

- –í—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `@photo2sticker_test_bot` (env=test)
- –ü—Ä–æ–¥ –±–æ—Ç `@photo2sticker_bot` –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç –¥–æ —è–≤–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
- SQL –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞: `ADD COLUMN IF NOT EXISTS` —Å DEFAULT
- –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö 7 —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤
