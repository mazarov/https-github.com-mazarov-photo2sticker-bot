# UTM-—Ç—Ä–µ–∫–∏–Ω–≥: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

## –§–ª–æ—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
–†–µ–∫–ª–∞–º–∞ (–Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç) ‚Üí –õ–µ–Ω–¥–∏–Ω–≥ (—Å UTM –≤ URL) ‚Üí –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞" ‚Üí Telegram –±–æ—Ç
```

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç
2. –ü–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥ —Å UTM-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ URL:
   ```
   https://photo2sticker.ru/?utm_source=ya&utm_medium=cpc&utm_campaign=706852522&utm_content=17579526984&utm_term=—Å–¥–µ–ª–∞—Ç—å+—Å—Ç–∏–∫–µ—Ä
   ```
3. –ù–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞"
4. –ö–Ω–æ–ø–∫–∞ –≤–µ–¥—ë—Ç –Ω–∞ Telegram deep link —Å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ UTM:
   ```
   https://t.me/Photo_2_StickerBot?start=ya_cpc_706852522_17579526984
   ```
5. –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç `startPayload`, –ø–∞—Ä—Å–∏—Ç UTM, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î

---

## –ß–∞—Å—Ç—å 1: –õ–µ–Ω–¥–∏–Ω–≥ (JS)

### –ó–∞–¥–∞—á–∞
–ù–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å Telegram-—Å—Å—ã–ª–∫—É, –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—è UTM –∏–∑ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ `start=` –ø–∞—Ä–∞–º–µ—Ç—Ä –±–æ—Ç–∞.

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
Deep link `https://t.me/Bot?start=PAYLOAD` –ø–µ—Ä–µ–¥–∞—ë—Ç –±–æ—Ç—É **—Ç–æ–ª—å–∫–æ** –∑–Ω–∞—á–µ–Ω–∏–µ `start=` (–¥–æ 64 —Å–∏–º–≤–æ–ª–æ–≤, –¥–æ–ø—É—Å—Ç–∏–º—ã `A-Za-z0-9_-`). –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ URL Telegram –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç.

### –§–æ—Ä–º–∞—Ç start-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞
```
{source}_{medium}_{campaign_id}_{content_id}
```

–ü—Ä–∏–º–µ—Ä—ã:
| URL-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã | start payload |
|---|---|
| `utm_source=ya&utm_medium=cpc&utm_campaign=706852522&utm_content=17579526984` | `ya_cpc_706852522_17579526984` |
| `utm_source=gads&utm_medium=cpc&utm_campaign=123` | `gads_cpc_123` |
| –±–µ–∑ UTM | `web` |

### JS-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞

```javascript
(function() {
  const params = new URLSearchParams(window.location.search);
  const source   = params.get('utm_source')   || '';
  const medium   = params.get('utm_medium')    || '';
  const campaign = params.get('utm_campaign')  || '';
  const content  = params.get('utm_content')   || '';

  let startPayload = 'web'; // –¥–µ—Ñ–æ–ª—Ç ‚Äî –ø—Ä–∏—à—ë–ª —Å —Å–∞–π—Ç–∞ –±–µ–∑ UTM
  if (source) {
    const parts = [source, medium, campaign, content].filter(Boolean);
    // –û—á–∏—â–∞–µ–º –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 64 —Å–∏–º–≤–æ–ª–∞–º–∏
    startPayload = parts.join('_').replace(/[^A-Za-z0-9_\-]/g, '').slice(0, 64);
  }

  const botLink = `https://t.me/Photo_2_StickerBot?start=${startPayload}`;

  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º .open-bot-btn
  document.querySelectorAll('.open-bot-btn').forEach(btn => {
    btn.href = botLink;
  });
})();
```

### –ì–¥–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å
- –í –∫–æ–Ω—Ü–µ `<body>` –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ, –∏–ª–∏
- –í GTM / Tilda custom code –±–ª–æ–∫–µ

---

## –ß–∞—Å—Ç—å 2: –ë–æ—Ç (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

### –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î ‚Äî `sql/048_utm_tracking.sql`
```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS start_payload text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS utm_source text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS utm_medium text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS utm_campaign text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS utm_content text;

CREATE INDEX IF NOT EXISTS idx_users_utm_source ON users(utm_source);
CREATE INDEX IF NOT EXISTS idx_users_utm_campaign ON users(utm_campaign);
```

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
```sql
NOTIFY pgrst, 'reload schema';
```

### –ü–∞—Ä—Å–∏–Ω–≥ –≤ –±–æ—Ç–µ ‚Äî `src/index.ts`
–§—É–Ω–∫—Ü–∏—è `parseStartPayload()` —Ä–∞–∑–±–∏—Ä–∞–µ—Ç payload:
- `ya_cpc_706852522_17579526984` ‚Üí `{ source: "ya", medium: "cpc", campaign: "706852522", content: "17579526984" }`
- `web` ‚Üí `{ source: "web", medium: null, campaign: null, content: null }`
- –ø—É—Å—Ç–æ–π ‚Üí `{ source: null, medium: null, campaign: null, content: null }`

–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: `ya`, `yandex`, `gads`, `google`, `fb`, `ig`, `vk`, `tg`, `web`
–ò–∑–≤–µ—Å—Ç–Ω—ã–µ medium: `cpc`, `cpm`, `organic`, `social`, `referral`

### –ú–æ–¥–µ–ª—å –∞—Ç—Ä–∏–±—É—Ü–∏–∏: First Click

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è **First Click Attribution** ‚Äî 100% –∑–∞—Å–ª—É–≥–∏ –∑–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏—é –ø—Ä–∏–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è **–ø–µ—Ä–≤–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞**, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∫–∞—Å–∞–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.

**–ü–æ—á–µ–º—É First Click:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ ‚Äî –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ UTM –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–µ—Ç —Ü–µ–ø–æ—á–µ–∫
- –î–ª—è Telegram-–±–æ—Ç–æ–≤ —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑, –¥–∞–ª—å—à–µ –æ–±—â–∞–µ—Ç—Å—è —Å –±–æ—Ç–æ–º –Ω–∞–ø—Ä—è–º—É—é
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π –∫–∞–Ω–∞–ª **–ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞ –Ω–µ –∫–∞–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç)

**–ü—Ä–∏–º–µ—Ä:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª —Ä–µ–∫–ª–∞–º—É –Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç ‚Üí –∑–∞—à—ë–ª –≤ –±–æ—Ç–∞ ‚Üí —É—à—ë–ª
2. –ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é —É–≤–∏–¥–µ–ª –ø–æ—Å—Ç –≤ VK ‚Üí –∫–ª–∏–∫–Ω—É–ª —Å—Å—ã–ª–∫—É ‚Üí –∫—É–ø–∏–ª –∫—Ä–µ–¥–∏—Ç—ã
3. –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø—Ä–∏–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è **–Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç** (–ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç), –∞ –Ω–µ VK

**–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ:**

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü–æ–≤–µ–¥–µ–Ω–∏–µ | First Click? |
|----------|-----------|:---:|
| –ù–æ–≤—ã–π —é–∑–µ—Ä —Å UTM | UTM –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ `INSERT` | ‚úÖ |
| –ù–æ–≤—ã–π —é–∑–µ—Ä –±–µ–∑ UTM ‚Üí –ø–æ—Ç–æ–º –∫–ª–∏–∫–∞–µ—Ç —Ä–µ–∫–ª–∞–º—É | UTM –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–ø–µ—Ä–≤—ã–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç) | ‚úÖ |
| –Æ–∑–µ—Ä —Å UTM –∫–ª–∏–∫–∞–µ—Ç –¥—Ä—É–≥—É—é —Ä–µ–∫–ª–∞–º–Ω—É—é —Å—Å—ã–ª–∫—É | –°—Ç–∞—Ä—ã–π UTM **–Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è** (`!user.utm_source`) | ‚úÖ |
| –Æ–∑–µ—Ä –±–µ–∑ UTM –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–ª–∏–∫–∞–µ—Ç —Ä–µ–∫–ª–∞–º—É | UTM –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç—ã–º (–æ—Ä–≥–∞–Ω–∏–∫/direct) | ‚úÖ |

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `/start` —Ö–µ–Ω–¥–ª–µ—Ä–µ UTM-–ø–æ–ª—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `users`.

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UTM –¥–ª—è returning users
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à—ë–ª –ø–æ —Ä–µ–∫–ª–∞–º–Ω–æ–π —Å—Å—ã–ª–∫–µ, –Ω–æ —É –Ω–µ–≥–æ –µ—â—ë –Ω–µ—Ç UTM (`utm_source IS NULL`), –ø–æ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è. –ï—Å–ª–∏ UTM —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω ‚Äî –Ω–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –µ–≥–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç (First Click).

### –ê–ª–µ—Ä—Ç –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
–í–∫–ª—é—á–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞: `üì¢ –ò—Å—Ç–æ—á–Ω–∏–∫: ya/cpc –∫–∞–º–ø–∞–Ω–∏—è:706852522`

---

## –ß–∞—Å—Ç—å 3: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (SQL-–∑–∞–ø—Ä–æ—Å—ã)

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
```sql
SELECT
  COALESCE(utm_source, 'direct') as source,
  utm_medium,
  COUNT(*) as users
FROM users
WHERE created_at > now() - interval '30 days'
GROUP BY utm_source, utm_medium
ORDER BY users DESC;
```

### –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
```sql
SELECT
  COALESCE(utm_source, 'direct') as source,
  COUNT(*) as total_users,
  COUNT(*) FILTER (WHERE has_purchased) as paid_users,
  ROUND(100.0 * COUNT(*) FILTER (WHERE has_purchased) / NULLIF(COUNT(*), 0), 1) as conversion_pct
FROM users
GROUP BY utm_source
ORDER BY total_users DESC;
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º –Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç
```sql
SELECT
  utm_campaign,
  COUNT(*) as users,
  COUNT(*) FILTER (WHERE has_purchased) as paid_users
FROM users
WHERE utm_source = 'ya'
GROUP BY utm_campaign
ORDER BY users DESC;
```

---

## –ß–µ–∫–ª–∏—Å—Ç

- [x] –ú–∏–≥—Ä–∞—Ü–∏—è: –∫–æ–ª–æ–Ω–∫–∏ utm_* –≤ users ‚Äî `sql/048_utm_tracking.sql`
- [x] –§—É–Ω–∫—Ü–∏—è `parseStartPayload()` –≤ `src/index.ts`
- [x] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ UTM –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] UTM –≤ –∞–ª–µ—Ä—Ç–µ –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- [x] –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ –∏ –∑–∞–ø—É—à–µ–Ω–æ –≤ main
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase + `NOTIFY pgrst, 'reload schema'`
- [ ] –î–æ–±–∞–≤–∏—Ç—å JS-—Å–∫—Ä–∏–ø—Ç –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥ (–∫–Ω–æ–ø–∫–∞ `.open-bot-btn`)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –≤ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏—è—Ö (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–æ—Ç–∞)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∑–∞–π—Ç–∏ —Å UTM ‚Üí —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ utm_source —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ users
