# –°–≤–æ—è –∏–¥–µ—è ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏–∫–µ—Ä–∞ –ø–æ —Å–ª–æ–≤—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–î–∞—Ç–∞:** 2026-02-12
**–°—Ç–∞—Ç—É—Å:** –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:** Pack Ideas (docs/11-02-pack-ideas.md)

---

## –ü—Ä–æ–±–ª–µ–º–∞

–°–µ–π—á–∞—Å "–ò–¥–µ–∏ –¥–ª—è –ø–∞–∫–∞" –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 8 —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–¥–µ–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–∏—Å—Ç–∞–µ—Ç –∏—Ö –∏ –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é. –û–Ω –∑–Ω–∞–µ—Ç —á–µ–≥–æ —Ö–æ—á–µ—Ç ("—É—Å—Ç–∞–ª", "–∑–ª–æ–π", "—Å –ø–∏–≤–æ–º"), –Ω–æ –Ω–µ –º–æ–∂–µ—Ç —ç—Ç–æ –≤—ã—Ä–∞–∑–∏—Ç—å –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

## –†–µ—à–µ–Ω–∏–µ

–ö–Ω–æ–ø–∫–∞ **"‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è"** –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–¥–µ–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫—É—é —Ñ—Ä–∞–∑—É ‚Üí GPT –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç–∏–∫–µ—Ä + —Å–ª–æ–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω—É –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–¥–µ—é —Å –ø–æ–ª–Ω—ã–º promptModification.

## –ë–∏–∑–Ω–µ—Å-—ç—Ñ—Ñ–µ–∫—Ç

- **–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∏–º–µ–Ω–Ω–æ —Ç–æ —á—Ç–æ —Ö–æ—á–µ—Ç ‚Üí –±–æ–ª—å—à–µ –Ω–∞–∂–∞—Ç–∏–π "–°–≥–µ–Ω–µ—Ä–∏—Ç—å"
- **–í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å** ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–∫–∞ –≤–º–µ—Å—Ç–æ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞–Ω–∏—è
- **–†–∞—Å—Ö–æ–¥ –∫—Ä–µ–¥–∏—Ç–æ–≤** ‚Äî –∫–∞–∂–¥–∞—è —Å–≤–æ—è –∏–¥–µ—è = +1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- **Retention** ‚Äî –æ—â—É—â–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

---

## –§–ª–æ—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–∏—Å—Ç–∞–µ—Ç –∏–¥–µ–∏ –¥–ª—è –ø–∞–∫–∞ (–æ–±—ã—á–Ω—ã–π Pack Ideas —Ñ–ª–æ—É)

2. –í –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–¥–µ–π –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞:
   [üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)]  [‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è]
   [‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è]
   [‚úÖ –•–≤–∞—Ç–∏—Ç]

3. –ù–∞–∂–∏–º–∞–µ—Ç "‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è"

4. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
   "‚úèÔ∏è –ù–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É ‚Äî —è –ø—Ä–∏–¥—É–º–∞—é –∏–¥–µ—é!
    –ù–∞–ø—Ä–∏–º–µ—Ä: —É—Å—Ç–∞–ª, –∑–ª–æ–π, —Å –∫–æ—Ñ–µ, —Ç–∞–Ω—Ü—É–µ—Ç, –æ—Ä—É, —Å–ø–∞—Å–∏–±–æ"

5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç: "—É—Å—Ç–∞–ª"

6. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "üí° –î—É–º–∞—é..." (1-2 —Å–µ–∫)

7. GPT-4o-mini –ø–æ–ª—É—á–∞–µ—Ç:
   - –ö–∞—Ä—Ç–∏–Ω–∫—É —Å—Ç–∏–∫–µ—Ä–∞ (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–µ–∂–¥—ã/—Å—Ç–∏–ª—è)
   - –°–ª–æ–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°—Ç–∏–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1 –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–¥–µ—é

8. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–¥–µ—é:
   "‚úèÔ∏è –¢–≤–æ—è –∏–¥–µ—è:

   üò¥ –£—Å—Ç–∞–ª
   –ü–µ—Ä—Å–æ–Ω–∞–∂ –∑–µ–≤–∞–µ—Ç, –≥–ª–∞–∑–∞ –ø–æ–ª—É–∑–∞–∫—Ä—ã—Ç—ã, –¥–µ—Ä–∂–∏—Ç –ø–æ–¥—É—à–∫—É

   [üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)]  [‚úèÔ∏è –ï—â—ë —Å–ª–æ–≤–æ]
   [‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –∏–¥–µ—è–º]"

9. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–≥–µ–Ω–µ—Ä–∏—Ç—å" ‚Üí –æ–±—ã—á–Ω—ã–π —Ñ–ª–æ—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

10. –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞ + "üí° –ò–¥–µ–∏ –¥–ª—è –ø–∞–∫–∞"
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Å–µ—Å—Å–∏–∏

```sql
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS waiting_custom_idea boolean DEFAULT false;
```

–ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ boolean-–ø–æ–ª–µ –≤–º–µ—Å—Ç–æ —Å–º–µ–Ω—ã `state` (state ‚Äî ENUM, –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏).

### 2. Callback: `custom_idea`

```
bot.action("custom_idea", async (ctx) => {
  // 1. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback
  // 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å session.waiting_custom_idea = true
  // 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
})
```

### 3. –ü–µ—Ä–µ—Ö–≤–∞—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

–í –≥–ª–∞–≤–Ω–æ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ö–µ–Ω–¥–ª–µ—Ä–µ (bot.on("text")) –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É **–¥–æ** –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤:

```typescript
if (session.waiting_custom_idea) {
  // 1. –°–±—Ä–æ—Å–∏—Ç—å waiting_custom_idea = false
  // 2. –ü–æ–∫–∞–∑–∞—Ç—å "üí° –î—É–º–∞—é..."
  // 3. –í—ã–∑–≤–∞—Ç—å generateCustomIdea(sticker, userText, style)
  // 4. –ü–æ–∫–∞–∑–∞—Ç—å –∏–¥–µ—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
  return;
}
```

### 4. –§—É–Ω–∫—Ü–∏—è `generateCustomIdea`

```typescript
async function generateCustomIdea(opts: {
  stickerFileId: string;
  stylePresetId: string | null;
  lang: string;
  userConcept: string;
}): Promise<StickerIdea> {
  // –°–∫–∞—á–∞—Ç—å —Å—Ç–∏–∫–µ—Ä, –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∏–ª—å
  // –í—ã–∑–≤–∞—Ç—å GPT-4o-mini —Å –ø—Ä–æ–º–ø—Ç–æ–º:
  //   "Generate exactly 1 sticker idea based on the user's concept: '{userConcept}'.
  //    Preserve the character's outfit, style and appearance from the image.
  //    Return a single JSON object."
  // –ü–∞—Ä—Å–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –æ–¥–Ω—É –∏–¥–µ—é
}
```

### 5. GPT-–ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–≤–æ–µ–π –∏–¥–µ–∏

```
You are a professional sticker pack designer.
Analyze the sticker image and generate exactly 1 detailed sticker idea
based on the user's concept: "${userConcept}".

Style: ${styleName} (${styleHint})

CRITICAL ‚Äî Preserving character appearance:
- EVERY promptModification MUST describe the character wearing the SAME outfit as in the image
- Do NOT change clothes, hat, glasses, hairstyle or other defining features

The idea should be creative and expand on the user's concept:
- If user says "—É—Å—Ç–∞–ª" ‚Üí think about HOW the character shows tiredness
- If user says "—Å –∫–æ—Ñ–µ" ‚Üí think about the scene, pose, expression
- If user says "–∑–ª–æ–π" ‚Üí think about the specific angry expression and body language

Return a single JSON object:
{
  "emoji": "üò¥",
  "titleRu": "...",
  "titleEn": "...",
  "descriptionRu": "...",
  "descriptionEn": "...",
  "promptModification": "...",
  "hasText": false,
  "textSuggestion": null,
  "textPlacement": null,
  "category": "emotion"
}
```

### 6. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –∏–¥–µ–∏

```typescript
{
  inline_keyboard: [
    [
      { text: "üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)", callback_data: "idea_generate:custom" },
      { text: "‚úèÔ∏è –ï—â—ë —Å–ª–æ–≤–æ", callback_data: "custom_idea" },
    ],
    [
      { text: "‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –∏–¥–µ—è–º", callback_data: "idea_back" },
    ],
  ]
}
```

### 7. Callback `idea_generate:custom`

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∏–¥–µ–∏. –ò–¥–µ—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `session.custom_idea` (jsonb –ø–æ–ª–µ):

```sql
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS custom_idea jsonb DEFAULT NULL;
```

–ü—Ä–∏ callback `idea_generate:custom`:
1. –ë–µ—Ä—ë–º `session.custom_idea`
2. –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–∞–∫ –æ–±—ã—á–Ω—É—é –∏–¥–µ—é
3. –°–æ—Ö—Ä–∞–Ω—è–µ–º `idea_source: "custom:userConcept"` –≤ —Å—Ç–∏–∫–µ—Ä

### 8. Callback `idea_back`

–í–æ–∑–≤—Ä–∞—Ç –∫ –ª–∏—Å—Ç–∞–Ω–∏—é –∏–¥–µ–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–¥–µ—é –∏–∑ `pack_ideas[current_idea_index]`.

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–Ω–æ–ø–∫–∞—Ö –∏–¥–µ–π

### –¢–µ–∫—É—â–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (getIdeaKeyboard):
```
[üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)]  [‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è]
[‚úÖ –•–≤–∞—Ç–∏—Ç]
```

### –ù–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:
```
[üé® –°–≥–µ–Ω–µ—Ä–∏—Ç—å (1üíé)]  [‚û°Ô∏è –°–ª–µ–¥—É—é—â–∞—è]
[‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è]
[‚úÖ –•–≤–∞—Ç–∏—Ç]
```

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
-- 058_custom_idea.sql
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS waiting_custom_idea boolean DEFAULT false;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS custom_idea jsonb DEFAULT NULL;
```

---

## –°—Ç–æ–∏–º–æ—Å—Ç—å

- GPT-4o-mini —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π: ~$0.001-0.002 –∑–∞ –∑–∞–ø—Ä–æ—Å (–æ–¥–Ω–∞ –∏–¥–µ—è)
- –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –±–µ—Å–ø–ª–∞—Ç–Ω–æ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ–∏), 1üíé –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ç–∏–∫–µ—Ä–∞

---

## –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è: `waiting_custom_idea`, `custom_idea` –ø–æ–ª—è
- [ ] –ö–Ω–æ–ø–∫–∞ "‚úèÔ∏è –°–≤–æ—è –∏–¥–µ—è" –≤ `getIdeaKeyboard`
- [ ] Callback `custom_idea` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- [ ] –ü–µ—Ä–µ—Ö–≤–∞—Ç —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ `waiting_custom_idea` ‚Äî –≤—ã–∑–æ–≤ GPT
- [ ] –§—É–Ω–∫—Ü–∏—è `generateCustomIdea` ‚Äî GPT-4o-mini —Å –æ–¥–Ω–æ–π –∏–¥–µ–µ–π
- [ ] –ü–æ–∫–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∏–¥–µ–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏
- [ ] Callback `idea_generate:custom` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ custom_idea
- [ ] Callback `idea_back` ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∫ –ª–∏—Å—Ç–∞–Ω–∏—é
- [ ] Callback "‚úèÔ∏è –ï—â—ë —Å–ª–æ–≤–æ" ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–≤–æ–¥
- [ ] –¢–µ—Å—Ç –Ω–∞ test-–æ–∫—Ä—É–∂–µ–Ω–∏–∏
- [ ] –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
