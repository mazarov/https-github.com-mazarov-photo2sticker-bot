# –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç–∏–∫–µ—Ä

## –ü—Ä–æ–±–ª–µ–º–∞

AI-–º–æ–¥–µ–ª–∏ –ø–ª–æ—Ö–æ —Ä–µ–Ω–¥–µ—Ä—è—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö ‚Äî –±—É–∫–≤—ã –∏—Å–∫–∞–∂–∞—é—Ç—Å—è, —à—Ä–∏—Ñ—Ç –Ω–µ—á–∏—Ç–∞–µ–º—ã–π. –ù—É–∂–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

## –¢–µ–∫—É—â–∏–π —Ñ–ª–æ—É

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üí¨ –¢–µ–∫—Å—Ç" –ø–æ–¥ —Å—Ç–∏–∫–µ—Ä–æ–º
2. –ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç (`wait_text`)
3. –¢–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ AI-–º–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Üí **–ø–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞**
4. –¢—Ä–∞—Ç–∏—Ç—Å—è –∫—Ä–µ–¥–∏—Ç

## –¶–µ–ª–µ–≤–æ–π —Ñ–ª–æ—É

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üí¨ –¢–µ–∫—Å—Ç" –ø–æ–¥ —Å—Ç–∏–∫–µ—Ä–æ–º
2. –ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç
3. –¢–µ–∫—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è **–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ** (Sharp + SVG) –ø–æ–≤–µ—Ä—Ö —Å—Ç–∏–∫–µ—Ä–∞ ‚Üí **—á—ë—Ç–∫–∏–π —Ç–µ–∫—Å—Ç**
4. **–ö—Ä–µ–¥–∏—Ç –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è** (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±–≤–æ–¥–∫–µ)

---

## –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: Sharp + SVG (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SVG —Å —Ç–µ–∫—Å—Ç–æ–º, Sharp –∫–æ–º–ø–æ–∑–∏—Ç–∏—Ç –µ–≥–æ –ø–æ–≤–µ—Ä—Ö —Å—Ç–∏–∫–µ—Ä–∞.

```typescript
function createTextOverlay(text: string, width = 512, height = 512) {
  return Buffer.from(`
    <svg width="${width}" height="${height}">
      <text x="50%" y="90%" text-anchor="middle"
        font-family="Arial Black" font-size="48" font-weight="bold"
        fill="white" stroke="black" stroke-width="4">
        ${escapeXml(text)}
      </text>
    </svg>
  `);
}

const result = await sharp(stickerBuffer)
  .composite([{ input: createTextOverlay("–ü—Ä–∏–≤–µ—Ç!") }])
  .toBuffer();
```

**–ü–ª—é—Å—ã:**
- –ù—É–ª–µ–≤—ã–µ –¥–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Sharp —É–∂–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ)
- –ë—ã—Å—Ç—Ä–æ (~50ms)
- –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ API-–≤—ã–∑–æ–≤–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–≤–æ–¥–∫—É, —Ç–µ–Ω–∏, –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ SVG

**–ú–∏–Ω—É—Å—ã:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —à—Ä–∏—Ñ—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
- –°–ª–æ–∂–Ω–µ–µ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ù–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –û–°

### –í–∞—Ä–∏–∞–Ω—Ç B: Sharp + Canvas (@napi-rs/canvas)

–†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–∫—Å—Ç –≤ PNG —á–µ—Ä–µ–∑ Canvas API, –∫–æ–º–ø–æ–∑–∏—Ç–∏–º —á–µ—Ä–µ–∑ Sharp.

**–ü–ª—é—Å—ã:**
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å: —à—Ä–∏—Ñ—Ç, —Ä–∞–∑–º–µ—Ä, —Ü–≤–µ—Ç, –æ–±–≤–æ–¥–∫–∞, —Ç–µ–Ω—å, –ø–æ–∑–∏—Ü–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
- –ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫, –∞–≤—Ç–æ-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ú–∏–Ω—É—Å—ã:**
- –ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `@napi-rs/canvas` (~30MB)
- –ù–∞—Ç–∏–≤–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π –≤ Docker)

### –í–∞—Ä–∏–∞–Ω—Ç C: Jimp (pure JS)

**–ü–ª—é—Å—ã:** –ù–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
**–ú–∏–Ω—É—Å—ã:** –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, —Å–ª–∞–±–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞, –Ω–µ—É–¥–æ–±–Ω—ã–π API

### –í–∞—Ä–∏–∞–Ω—Ç D: –ì–∏–±—Ä–∏–¥ (AI –ø–æ–∑–∏—Ü–∏—è + –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä)

AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —É–≥–æ–ª —Ä–∞–∑–º–µ—â–µ–Ω–∏—è, —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π.

**–ü–ª—é—Å—ã:** –¢–µ–∫—Å—Ç —á—ë—Ç–∫–∏–π + "—É–º–Ω–∞—è" –ø–æ–∑–∏—Ü–∏—è
**–ú–∏–Ω—É—Å—ã:** API-–≤—ã–∑–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –í–∞—Ä–∏–∞–Ω—Ç A (Sharp + SVG)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `addWhiteBorder` –≤ `src/lib/image-utils.ts` ‚Äî –º–∏–Ω–∏–º—É–º –∫–æ–¥–∞, –Ω—É–ª–µ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–∫—Å—Ç–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------------------|----------|
| position | bottom | –ü–æ–∑–∏—Ü–∏—è: top / center / bottom |
| fontSize | auto (48-72px) | –ê–≤—Ç–æ-–º–∞—Å—à—Ç–∞–± –ø–æ –¥–ª–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞ |
| color | white | –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ |
| stroke | black | –¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏ |
| strokeWidth | 4px | –¢–æ–ª—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏ |
| fontFamily | Arial Black | –®—Ä–∏—Ñ—Ç (—Å–∏—Å—Ç–µ–º–Ω—ã–π) |

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ú–∞–∫—Å–∏–º—É–º ~30 —Å–∏–º–≤–æ–ª–æ–≤ (–∏–Ω–∞—á–µ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –ø—Ä–∏ 512x512)
- –¢–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ –ø–æ–≤–æ—Ä–æ—Ç–∞)
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ –∑–∞ —Ä–∞–∑

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –§—É–Ω–∫—Ü–∏—è `addTextToSticker()` –≤ `src/lib/image-utils.ts`

**–ß—Ç–æ:** –ù–æ–≤–∞—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä—è–¥–æ–º —Å `addWhiteBorder()`.

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```typescript
export async function addTextToSticker(
  inputBuffer: Buffer,
  text: string,
  position: "top" | "bottom" = "bottom"
): Promise<Buffer>
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏–∫–µ—Ä —á–µ—Ä–µ–∑ `sharp(inputBuffer)`, –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã
2. –í—ã—á–∏—Å–ª–∏—Ç—å fontSize:
   - ‚â§10 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí 64px
   - 11-20 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí 48px
   - 21-30 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí 36px
   - >30 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí –æ–±—Ä–µ–∑–∞—Ç—å –¥–æ 30 + "..."
3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SVG-–æ–≤–µ—Ä–ª–µ–π —Å —Ç–µ–∫—Å—Ç–æ–º:
   - `position = "bottom"` ‚Üí `y="92%"`
   - `position = "top"` ‚Üí `y="12%"`
   - –ó–∞–ª–∏–≤–∫–∞: white, –æ–±–≤–æ–¥–∫–∞: black (4px), font-weight: bold
   - `text-anchor: middle`, `x="50%"`
4. `sharp(inputBuffer).composite([{ input: svgBuffer }])`
5. Resize 512x512, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ WebP
6. –í–µ—Ä–Ω—É—Ç—å Buffer

**–í–∞–∂–Ω–æ:** –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å XML-—Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã (`<`, `>`, `&`, `"`) –≤ —Ç–µ–∫—Å—Ç–µ.

### –®–∞–≥ 2: –ù–æ–≤—ã–π —Å—Ç–µ–π—Ç `wait_text_overlay` –≤ `src/index.ts`

**–ß—Ç–æ:** –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–π—Ç–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Ç–µ–∫—Å—Ç–∞.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `add_text:ID` —Ö–µ–Ω–¥–ª–µ—Ä–µ** (—Å—Ç—Ä–æ–∫–∏ 3073-3132):
- –í–º–µ—Å—Ç–æ `state: "wait_text"` ‚Üí `state: "wait_text_overlay"`
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å `stickerId` –≤ —Å–µ—Å—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä —á–µ—Ä–µ–∑ `pending_sticker_id` –∏–ª–∏ –≤ `last_sticker_file_id` –∫–∞–∫ —Å–µ–π—á–∞—Å)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (–∑–∞–º–µ–Ω—è–µ–º):**
```typescript
// –°–µ–π—á–∞—Å: –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ wait_text ‚Üí —Ç–µ–∫—Å—Ç —É—Ö–æ–¥–∏—Ç –≤ AI ‚Üí —Ç—Ä–∞—Ç–∏—Ç –∫—Ä–µ–¥–∏—Ç
await supabase.from("sessions").update({
  state: "wait_text",
  last_sticker_file_id: sticker.telegram_file_id,
  ...
}).eq("id", session.id);
await ctx.reply(await getText(lang, "text.prompt"));
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```typescript
// –¢–µ–ø–µ—Ä—å: –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ wait_text_overlay ‚Üí —Ç–µ–∫—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ ‚Üí –±–µ—Å–ø–ª–∞—Ç–Ω–æ
await supabase.from("sessions").update({
  state: "wait_text_overlay",
  is_active: true,
  last_sticker_file_id: sticker.telegram_file_id,
}).eq("id", session.id);
await ctx.reply(lang === "ru"
  ? "‚úèÔ∏è –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ (–¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤):"
  : "‚úèÔ∏è Type the text for the sticker (up to 30 characters):");
```

### –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞ –≤ `wait_text_overlay`

**–ì–¥–µ:** –í —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ö–µ–Ω–¥–ª–µ—Ä–µ `src/index.ts`, —Ä—è–¥–æ–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º `if (session.state === "wait_text")`.

**–õ–æ–≥–∏–∫–∞** (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `toggle_border`):
```
1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ctx.message.text)
2. –í–∞–ª–∏–¥–∞—Ü–∏—è: –æ–±—Ä–µ–∑–∞—Ç—å –¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å "‚úèÔ∏è –î–æ–±–∞–≤–ª—è—é —Ç–µ–∫—Å—Ç..." (processing indicator)
4. –°–∫–∞—á–∞—Ç—å —Å—Ç–∏–∫–µ—Ä –ø–æ last_sticker_file_id (getFilePath ‚Üí downloadFile)
5. –í—ã–∑–≤–∞—Ç—å addTextToSticker(stickerBuffer, text, "bottom")
6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä —á–µ—Ä–µ–∑ sendSticker() —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –∫–Ω–æ–ø–æ–∫
7. –û–±–Ω–æ–≤–∏—Ç—å telegram_file_id –≤ —Ç–∞–±–ª–∏—Ü–µ stickers
8. –£–¥–∞–ª–∏—Ç—å processing message
9. –ù–ï —Å–ø–∏—Å—ã–≤–∞—Ç—å –∫—Ä–µ–¥–∏—Ç
```

**–ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏** ‚Äî —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –≤ `toggle_border`:
```
[–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–∫]
[–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç] [–≠–º–æ—Ü–∏—è]
[–î–≤–∏–∂–µ–Ω–∏–µ] [–û–±–≤–æ–¥–∫–∞]
[–¢–µ–∫—Å—Ç]
```

### –®–∞–≥ 4: –£–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–π AI-—Ñ–ª–æ—É –¥–ª—è —Ç–µ–∫—Å—Ç–∞

**–ß—Ç–æ:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å –±–ª–æ–∫ `if (session.state === "wait_text")` (—Å—Ç—Ä–æ–∫–∏ 2010-2025), –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç `startGeneration` —Å `generationType: "text"`.

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **A (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π):** –û—Å—Ç–∞–≤–∏—Ç—å `wait_text` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (—Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏), –Ω–æ –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–µ–¥—É—Ç –≤ `wait_text_overlay`
- **B (—á–∏—Å—Ç—ã–π):** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç—å `wait_text` –Ω–∞ `wait_text_overlay`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç A ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å `wait_text` –∫–∞–∫ fallback –Ω–∞ –ø–µ—Ä–≤–æ–µ –≤—Ä–µ–º—è.

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—ã

**–§–∞–π–ª:** `src/lib/texts.ts`

–î–æ–±–∞–≤–∏—Ç—å:
- `text.overlay_prompt` ‚Üí "‚úèÔ∏è –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ (–¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤):" / "‚úèÔ∏è Type the text for the sticker (up to 30 chars):"
- `text.overlay_processing` ‚Üí "‚úèÔ∏è –î–æ–±–∞–≤–ª—è—é —Ç–µ–∫—Å—Ç..." / "‚úèÔ∏è Adding text..."

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å Docker-–æ–±—Ä–∞–∑ (—à—Ä–∏—Ñ—Ç—ã)

**–§–∞–π–ª:** `Dockerfile.api` –∏ `Dockerfile.worker`

–î–æ–±–∞–≤–∏—Ç—å —à—Ä–∏—Ñ—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã:
```dockerfile
RUN apk add --no-cache fontconfig font-noto font-noto-cjk
```
–∏–ª–∏ –¥–ª—è Debian-based:
```dockerfile
RUN apt-get update && apt-get install -y fonts-noto fonts-noto-cjk --no-install-recommends && rm -rf /var/lib/apt/lists/*
```

**–í–∞–∂–Ω–æ:** –ë–µ–∑ —ç—Ç–æ–≥–æ SVG –≤ Sharp –Ω–µ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É ‚Äî –±—É–¥—É—Ç –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏.

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| # | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|---|--------|------|-----------|
| 1 | `addTextToSticker()` | `src/lib/image-utils.ts` | –°—Ä–µ–¥–Ω—è—è |
| 2 | –•–µ–Ω–¥–ª–µ—Ä `add_text:ID` ‚Üí `wait_text_overlay` | `src/index.ts` | –ü—Ä–æ—Å—Ç–∞—è |
| 3 | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `wait_text_overlay` | `src/index.ts` | –°—Ä–µ–¥–Ω—è—è |
| 4 | –¢–µ–∫—Å—Ç—ã | `src/lib/texts.ts` | –ü—Ä–æ—Å—Ç–∞—è |
| 5 | –®—Ä–∏—Ñ—Ç—ã –≤ Docker | `Dockerfile.*` | –ü—Ä–æ—Å—Ç–∞—è |
| 6 | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚Äî | ‚Äî |

**–û—Ü–µ–Ω–∫–∞:** ~2-3 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã. –û—Å–Ω–æ–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SVG-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π –∏ –∞–≤—Ç–æ-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞.

## –†–∏—Å–∫–∏

1. **–ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ SVG** ‚Äî Sharp –∏—Å–ø–æ–ª—å–∑—É–µ—Ç librsvg, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤. –ë–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤ –≤ Docker ‚Äî –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏.
2. **–î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç** ‚Äî –Ω—É–∂–Ω–∞ –æ–±—Ä–µ–∑–∫–∞ –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ (SVG –Ω–µ —É–º–µ–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –Ω—É–∂–Ω–æ —Ä–∞–∑–±–∏–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –Ω–∞ `<tspan>`).
3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** ‚Äî —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö —Å—Ç–∏–∫–µ—Ä–∞, –Ω–æ –Ω–µ –ø–æ–≤–µ—Ä—Ö –ø—Ä–æ–∑—Ä–∞—á–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π (–∏–Ω–∞—á–µ —Ç–µ–∫—Å—Ç "–≤–∏—Å–∏—Ç –≤ –≤–æ–∑–¥—É—Ö–µ"). –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –ø–æ–¥–ª–æ–∂–∫—É.

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è v2: –ü–ª–∞—à–∫–∞-–±–µ–π–¥–∂ —Å —Ç–µ–∫—Å—Ç–æ–º

### –ü—Ä–æ–±–ª–µ–º–∞ v1

SVG-—Ç–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö —Å—Ç–∏–∫–µ—Ä–∞ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ Alpine-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ: Sharp –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π librsvg, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –≤–∏–¥–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã —á–µ—Ä–µ–∑ fontconfig. –¢–µ–∫—Å—Ç –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º.

### –†–µ—à–µ–Ω–∏–µ v2: –±–µ–ª–∞—è –ø–ª–∞—à–∫–∞ + —Ç–µ–∫—Å—Ç

–í–º–µ—Å—Ç–æ "–≥–æ–ª–æ–≥–æ" —Ç–µ–∫—Å—Ç–∞ –ø–æ–≤–µ—Ä—Ö —Å—Ç–∏–∫–µ—Ä–∞ ‚Äî **–±–µ–ª–∞—è –ø–ª–∞—à–∫–∞ (–±–µ–π–¥–∂)** —Å–æ —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–º–∏ —É–≥–ª–∞–º–∏, —à–∏—Ä–∏–Ω–∞ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞.

### –í–∏–∑—É–∞–ª

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  ‚îÇ         ‚îÇ                  ‚îÇ
‚îÇ    –°–¢–ò–ö–ï–†        ‚îÇ         ‚îÇ    –°–¢–ò–ö–ï–†        ‚îÇ
‚îÇ                  ‚îÇ         ‚îÇ                  ‚îÇ
‚îÇ                  ‚îÇ         ‚îÇ                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ         ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ  –ü–†–ò–í–ï–¢!  ‚îÇ   ‚îÇ         ‚îÇ   ‚îÇ  –û–ö  ‚îÇ       ‚îÇ
‚îî‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç              –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –í—ã—Å–æ—Ç–∞ –ø–ª–∞—à–∫–∏ | 52px (~10% –æ—Ç 512) |
| –®–∏—Ä–∏–Ω–∞ –ø–ª–∞—à–∫–∏ | `text_length √ó fontSize √ó 0.6 + padding √ó 2`, max 512 |
| Padding | 24px —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ |
| –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ | `rx="12"` |
| –¶–≤–µ—Ç –ø–ª–∞—à–∫–∏ | white, opacity 0.9 |
| –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ | black, bold |
| –ü–æ–∑–∏—Ü–∏—è | bottom (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏–ª–∏ top |
| –ü–ª–∞—à–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ | –î–∞, `x = (512 - rectWidth) / 2` |

### –ê–ª–≥–æ—Ä–∏—Ç–º

1. –°—Ç–∏–∫–µ—Ä 512x512 ‚Äî **–Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º**
2. –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞: `charWidth = fontSize √ó 0.6`, `textWidth = length √ó charWidth`
3. –®–∏—Ä–∏–Ω–∞ –ø–ª–∞—à–∫–∏: `rectWidth = min(512, textWidth + padding √ó 2)`
4. –ü–æ–∑–∏—Ü–∏—è X: `rectX = (512 - rectWidth) / 2` (—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º)
5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SVG 512x512 —Å `<rect>` + `<text>`
6. `sharp(sticker).composite([{ input: svgBuffer }])` ‚Äî –æ–¥–∏–Ω –≤—ã–∑–æ–≤

### –ö–æ–¥

```typescript
export async function addTextToSticker(
  inputBuffer: Buffer,
  text: string,
  position: "top" | "bottom" = "bottom"
): Promise<Buffer> {
  let displayText = text.trim();
  if (displayText.length > 30) displayText = displayText.substring(0, 27) + "...";

  // Auto-scale font size
  let fontSize: number;
  if (displayText.length <= 8) fontSize = 36;
  else if (displayText.length <= 15) fontSize = 30;
  else if (displayText.length <= 22) fontSize = 26;
  else fontSize = 22;

  // Calculate badge dimensions
  const STRIP_H = 52;
  const PADDING = 24;
  const charWidth = fontSize * 0.6;
  const textWidth = displayText.length * charWidth;
  const rectWidth = Math.min(500, textWidth + PADDING * 2);
  const rectX = (512 - rectWidth) / 2;

  // Position
  const yRect = position === "bottom" ? 512 - STRIP_H - 6 : 6;
  const yText = position === "bottom" ? 512 - STRIP_H / 3 - 6 : STRIP_H * 0.7 + 6;

  const svg = `<svg width="512" height="512" xmlns="http://www.w3.org/2000/svg">
    <rect x="${rectX}" y="${yRect}" width="${rectWidth}" height="${STRIP_H}"
          fill="white" opacity="0.9" rx="12"/>
    <text x="256" y="${yText}" text-anchor="middle"
          font-family="DejaVu Sans, sans-serif" font-size="${fontSize}"
          font-weight="bold" fill="black">${escapeXml(displayText)}</text>
  </svg>`;

  return await sharp(inputBuffer)
    .ensureAlpha()
    .resize(512, 512, { fit: "contain", background: { r: 0, g: 0, b: 0, alpha: 0 } })
    .composite([{ input: Buffer.from(svg), blend: "over" }])
    .webp()
    .toBuffer();
}
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ v2

- **Graceful degradation**: –¥–∞–∂–µ –µ—Å–ª–∏ —à—Ä–∏—Ñ—Ç –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è, –±–µ–ª–∞—è –ø–ª–∞—à–∫–∞ –≤–∏–¥–Ω–∞ (–Ω–µ –ø—É—Å—Ç–æ–π —Å—Ç–∏–∫–µ—Ä)
- **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ ‚Äî –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ–º, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ü–≤–µ—Ç–æ–≤ —Å—Ç–∏–∫–µ—Ä–∞
- **–°—Ç–∏–ª—å**: —Å–∫—Ä—É–≥–ª—ë–Ω–Ω–∞—è –ø–ª–∞—à–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–∫–µ—Ä-–±–µ–π–¥–∂
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å**: —à–∏—Ä–∏–Ω–∞ –ø–ª–∞—à–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ç–µ–∫—Å—Ç ‚Äî –Ω–µ –∑–∞–Ω–∏–º–∞–µ—Ç –ª–∏—à–Ω–µ–µ –º–µ—Å—Ç–æ
