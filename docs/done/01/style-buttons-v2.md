# Inline Style Buttons ‚Äî –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è v2

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å inline-–∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª–µ–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ 8 –ø—Ä–µ—Å–µ—Ç–æ–≤ –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–æ–º.

---

## –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
```
–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –æ–ø–∏—à–∏ —Å—Ç–∏–ª—å —Å—Ç–∏–∫–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –º—É–ª—å—Ç, 3D, –∞–∫–≤–∞—Ä–µ–ª—å, –∞–Ω–∏–º–µ).
```

---

## –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:

**–¢–µ–∫—Å—Ç (–∫–ª—é—á `photo.ask_style`):**
```
–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å —Å—Ç–∏–∫–µ—Ä–∞ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∏–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π —Ç–µ–∫—Å—Ç–æ–º.
```

**Inline-–∫–Ω–æ–ø–∫–∏ (2 –≤ —Ä—è–¥):**
```
[üéå –ê–Ω–∏–º–µ]      [üé® –ú—É–ª—å—Ç—Ñ–∏–ª—å–º]
[üßä 3D]         [üëæ –ü–∏–∫—Å–µ–ª—å –∞—Ä—Ç]
[üì∫ –°–∏–º–ø—Å–æ–Ω—ã]   [üç° –ß–∏–±–∏]
[üíß –ê–∫–≤–∞—Ä–µ–ª—å]   [üí• –ö–æ–º–∏–∫—Å]
```

---

## –õ–æ–≥–∏–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "üéå –ê–Ω–∏–º–µ")
2. –ë–µ—Ä—ë—Ç—Å—è `prompt_hint` –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–∏–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `style_presets`
3. `prompt_hint` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `generatePrompt()` –∫–∞–∫ `userInput`
4. –î–∞–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–ª–æ—É: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ job ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

---

## –õ–æ–≥–∏–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å–∏–º–ø—Å–æ–Ω—ã –≥—Ä—É—Å—Ç–Ω—ã–π")
2. –¢–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `generatePrompt()` –∫–∞–∫ `userInput`
3. –î–∞–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–ª–æ—É

---

## –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏

```
wait_photo ‚Üí wait_style ‚Üí processing
                ‚Üì
           (–∫–Ω–æ–ø–∫–∞) ‚Üí prompt_hint ‚Üí generatePrompt() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ ‚Üí job
                ‚Üì
           (—Ç–µ–∫—Å—Ç)  ‚Üí userInput   ‚Üí generatePrompt() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ ‚Üí job
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** `wait_description` ‚Üí `wait_style`

---

## –¢–∞–±–ª–∏—Ü–∞ `style_presets`

```sql
create table style_presets (
  id text primary key,
  name_ru text not null,
  name_en text not null,
  prompt_hint text not null,
  emoji text not null,
  sort_order int default 0,
  is_active boolean default true,
  created_at timestamptz default now()
);

create index style_presets_active_idx on style_presets (is_active, sort_order);

INSERT INTO style_presets (id, emoji, name_ru, name_en, prompt_hint, sort_order) VALUES
  ('anime', 'üéå', '–ê–Ω–∏–º–µ', 'Anime', 'anime style, clean lines, expressive eyes, detailed hair', 1),
  ('cartoon', 'üé®', '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º', 'Cartoon', 'cartoon style, bold outlines, vibrant colors, exaggerated features', 2),
  ('3d', 'üßä', '3D', '3D', '3D rendered style, volumetric lighting, smooth surfaces', 3),
  ('pixel', 'üëæ', '–ü–∏–∫—Å–µ–ª—å –∞—Ä—Ç', 'Pixel Art', 'pixel art style, retro game aesthetic, 8-bit', 4),
  ('simpsons', 'üì∫', '–°–∏–º–ø—Å–æ–Ω—ã', 'Simpsons', 'The Simpsons cartoon style, yellow skin, flat 2D, overbite', 5),
  ('chibi', 'üç°', '–ß–∏–±–∏', 'Chibi', 'chibi style, big head, small body, cute, kawaii', 6),
  ('watercolor', 'üíß', '–ê–∫–≤–∞—Ä–µ–ª—å', 'Watercolor', 'watercolor painting style, soft edges, artistic', 7),
  ('comic', 'üí•', '–ö–æ–º–∏–∫—Å', 'Comic', 'comic book style, halftone dots, dynamic poses, speech bubbles', 8);
```

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `bot_texts_new`

```sql
UPDATE bot_texts_new 
SET text = '–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å —Å—Ç–∏–∫–µ—Ä–∞ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∏–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π —Ç–µ–∫—Å—Ç–æ–º.',
    updated_at = now()
WHERE lang = 'ru' AND key = 'photo.ask_style';

UPDATE bot_texts_new 
SET text = 'Great! Now choose a sticker style from the options below or describe your own.',
    updated_at = now()
WHERE lang = 'en' AND key = 'photo.ask_style';
```

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. Photo handler (`index.ts`)

```typescript
// –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ wait_style + –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏
await supabase
  .from("sessions")
  .update({ photos, state: "wait_style" })
  .eq("id", session.id);

await sendStyleKeyboard(ctx, lang);
```

### 2. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `sendStyleKeyboard`

```typescript
async function sendStyleKeyboard(ctx: any, lang: string) {
  const presets = await getStylePresets();
  
  const buttons: any[][] = [];
  for (let i = 0; i < presets.length; i += 2) {
    const row = [];
    row.push(Markup.button.callback(
      `${presets[i].emoji} ${lang === "ru" ? presets[i].name_ru : presets[i].name_en}`,
      `style_${presets[i].id}`
    ));
    if (presets[i + 1]) {
      row.push(Markup.button.callback(
        `${presets[i + 1].emoji} ${lang === "ru" ? presets[i + 1].name_ru : presets[i + 1].name_en}`,
        `style_${presets[i + 1].id}`
      ));
    }
    buttons.push(row);
  }
  
  await ctx.reply(
    await getText(lang, "photo.ask_style"),
    Markup.inlineKeyboard(buttons)
  );
}
```

### 3. Callback handler –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å—Ç–∏–ª—è

```typescript
bot.action(/^style_(.+)$/, async (ctx) => {
  await ctx.answerCbQuery();
  const styleId = ctx.match[1];
  
  // –ü–æ–ª—É—á–∏—Ç—å preset
  const presets = await getStylePresets();
  const preset = presets.find(p => p.id === styleId);
  if (!preset) return;
  
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å prompt_hint –∫–∞–∫ userInput
  const userInput = preset.prompt_hint;
  
  // –î–∞–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...
});
```

### 4. Text handler ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è

```typescript
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ wait_style
if (session.state !== "wait_style") {
  if (session.state === "wait_photo") {
    await ctx.reply(await getText(lang, "photo.need_photo"));
  }
  return;
}
```

---

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∏–ª–µ–π

```typescript
let stylePresetsCache: { data: any[]; timestamp: number } | null = null;
const STYLE_PRESETS_CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

async function getStylePresets() {
  const now = Date.now();
  if (stylePresetsCache && now - stylePresetsCache.timestamp < STYLE_PRESETS_CACHE_TTL) {
    return stylePresetsCache.data;
  }

  const { data } = await supabase
    .from("style_presets")
    .select("*")
    .eq("is_active", true)
    .order("sort_order");

  if (data) {
    stylePresetsCache = { data, timestamp: now };
  }
  return data || [];
}
```

---

## –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `style_presets` –≤ Supabase
- [ ] –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (8 —Å—Ç–∏–ª–µ–π)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `photo.ask_style` –≤ `bot_texts_new`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `getStylePresets()` —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `sendStyleKeyboard()`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å Photo handler ‚Äî state = `wait_style`, –≤—ã–∑–æ–≤ `sendStyleKeyboard`
- [ ] –î–æ–±–∞–≤–∏—Ç—å callback handler `style_*`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å Text handler ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ `wait_style`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
