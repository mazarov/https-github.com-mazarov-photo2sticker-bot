# Style Examples ‚Äî –ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª–µ–π

## –¶–µ–ª—å
–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∏–ª—è –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º.

## Scope
- ‚úÖ –¢–æ–ª—å–∫–æ —Å—Ç–∏–ª–∏ (style_presets)
- ‚ùå –≠–º–æ—Ü–∏–∏ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
- ‚ùå –î–≤–∏–∂–µ–Ω–∏—è ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
- ‚ùå –¢–µ–∫—Å—Ç ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü–æ–¥—Ö–æ–¥
- –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–º–µ—á–∞—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç–∏–∫–µ—Ä–∞ (`is_example = true`)
- –ê–¥–º–∏–Ω –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª –∞–ª–µ—Ä—Ç–æ–≤
- –ö–∞–∂–¥—ã–π —Å—Ç–∏–∫–µ—Ä –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–≤–æ–µ–º—É —Å—Ç–∏–ª—é
- –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å ‚Äî —Ä—É—á–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è (–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∞–¥–º–∏–Ω–∞)

### –§–ª–æ—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç–∏–∫–µ—Ä
2. –í –∫–∞–Ω–∞–ª –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏—Ö–æ–¥–∏—Ç:
   
   üé® –ù–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä
   üë§ @username
   üì¶ –°—Ç–∏–ª—å: –ê–Ω–∏–º–µ
   [–°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º]

3. –ê–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
4. –°—Ç–∏–∫–µ—Ä –ø–æ–º–µ—á–∞–µ—Ç—Å—è is_example = true
5. –ü–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –¥–ª—è —Å—Ç–∏–ª—è "–ê–Ω–∏–º–µ"
```

## UI –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –í—ã–±–æ—Ä —Å—Ç–∏–ª—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø—Ä–∏–º–µ—Ä–æ–≤)

```
–ë–æ—Ç: "–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å:"
     [üéå –ê–Ω–∏–º–µ] [–ü—Ä–∏–º–µ—Ä]
     [üëæ –ü–∏–∫—Å–µ–ª—å] [–ü—Ä–∏–º–µ—Ä]
     [üéÆ 3D] [–ü—Ä–∏–º–µ—Ä]
     [üé¨ –ú—É–ª—å—Ç–∏–∫] [–ü—Ä–∏–º–µ—Ä]
```

### –ü–æ–∫–∞–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É, –º–∞–∫—Å 3)

```
–ö–ª–∏–∫ "–ü—Ä–∏–º–µ—Ä" ‚Üí
  [–°—Ç–∏–∫–µ—Ä 1]
  "–ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è –ê–Ω–∏–º–µ"
  [–ï—â—ë] [‚Üê –ù–∞–∑–∞–¥]

–ö–ª–∏–∫ "–ï—â—ë" ‚Üí
  [–°—Ç–∏–∫–µ—Ä 2]
  [–ï—â—ë] [‚Üê –ù–∞–∑–∞–¥]

–ö–ª–∏–∫ "–ï—â—ë" ‚Üí
  [–°—Ç–∏–∫–µ—Ä 3]
  [‚Üê –ù–∞–∑–∞–¥]           ‚Üê "–ï—â—ë" –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ 3-–≥–æ

–ï—Å–ª–∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –º–µ–Ω—å—à–µ 3:
  "–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ—Ç"
  [‚Üê –ù–∞–∑–∞–¥]
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏—è

```sql
-- 034_style_examples.sql

-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ stickers
ALTER TABLE stickers ADD COLUMN IF NOT EXISTS is_example boolean DEFAULT false;
ALTER TABLE stickers ADD COLUMN IF NOT EXISTS style_preset_id text;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤
CREATE INDEX IF NOT EXISTS idx_stickers_examples 
ON stickers (style_preset_id, is_example, created_at DESC) 
WHERE is_example = true;

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å style_preset_id –∏–∑ sessions –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤
UPDATE stickers s
SET style_preset_id = ses.selected_style_id
FROM sessions ses
WHERE s.session_id = ses.id
  AND s.style_preset_id IS NULL
  AND ses.selected_style_id IS NOT NULL;

COMMENT ON COLUMN stickers.is_example IS '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è';
COMMENT ON COLUMN stickers.style_preset_id IS 'ID —Å—Ç–∏–ª—è (–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ sessions)';
```

### –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–º–µ—Ä–æ–≤

```sql
SELECT telegram_file_id
FROM stickers
WHERE style_preset_id = :styleId
  AND is_example = true
  AND telegram_file_id IS NOT NULL
ORDER BY created_at DESC
LIMIT 3
OFFSET :offset;
```

## –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

| –ö–ª—é—á | RU | EN |
|------|----|----|
| btn.example | –ü—Ä–∏–º–µ—Ä | Example |
| btn.more_example | –ï—â—ë | More |
| btn.back_to_styles | ‚Üê –ù–∞–∑–∞–¥ | ‚Üê Back |
| example.caption | –ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è {style} | {style} style example |
| example.no_more | –ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ—Ç | No more examples |
| example.not_available | –ü—Ä–∏–º–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç | No examples yet |
| btn.make_example | –°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º | Make example |
| alert.made_example | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–∏–º–µ—Ä—ã | ‚úÖ Added to examples |

## Callback Data

| Callback | –î–µ–π—Å—Ç–≤–∏–µ |
|----------|----------|
| `style_example:{styleId}` | –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–∏–º–µ—Ä |
| `style_example_more:{styleId}:{offset}` | –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–º–µ—Ä |
| `back_to_styles` | –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Å—Ç–∏–ª—è |
| `make_example:{stickerId}` | –ü–æ–º–µ—Ç–∏—Ç—å —Å—Ç–∏–∫–µ—Ä –∫–∞–∫ –ø—Ä–∏–º–µ—Ä |

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

–°–æ–∑–¥–∞—Ç—å `sql/034_style_examples.sql` –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å.

### 2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—Ç—å style_preset_id

–í `worker.ts` –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞:

```typescript
await supabase.from("stickers").insert({
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  style_preset_id: session.selected_style_id,  // NEW
});
```

### 3. –ê–ª–µ—Ä—Ç "–ù–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä" —Å –∫–Ω–æ–ø–∫–æ–π

–í `worker.ts` –∏–ª–∏ `alerts.ts`:

```typescript
await sendNotification({
  type: "new_sticker",
  message: `üë§ @${user.username}\nüì¶ –°—Ç–∏–ª—å: ${styleName}`,
  // ... images
  buttons: [[{
    text: "–°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º",
    callback_data: `make_example:${stickerId}`
  }]]
});
```

### 4. Handler –¥–ª—è "–°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º"

–í `index.ts`:

```typescript
bot.action(/^make_example:(.+)$/, async (ctx) => {
  const stickerId = ctx.match[1];
  
  await supabase
    .from("stickers")
    .update({ is_example: true })
    .eq("id", stickerId);
  
  await ctx.answerCbQuery("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–∏–º–µ—Ä—ã");
  
  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —É–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫—É
  await ctx.editMessageReplyMarkup({ inline_keyboard: [] });
});
```

### 5. UI –∫–Ω–æ–ø–æ–∫ —Å—Ç–∏–ª–µ–π

```typescript
// –ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–Ω–æ–ø–æ–∫ —Å—Ç–∏–ª–µ–π
for (const preset of stylePresets) {
  const name = lang === "ru" ? preset.name_ru : preset.name_en;
  const exampleText = lang === "ru" ? "–ü—Ä–∏–º–µ—Ä" : "Example";
  
  buttons.push([
    Markup.button.callback(`${preset.emoji} ${name}`, `style:${preset.id}`),
    Markup.button.callback(exampleText, `style_example:${preset.id}`)
  ]);
}
```

### 6. –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤

```typescript
const MAX_EXAMPLES = 3;

async function getStyleExample(styleId: string, offset: number) {
  if (offset >= MAX_EXAMPLES) return null;
  
  const { data } = await supabase
    .from("stickers")
    .select("telegram_file_id")
    .eq("style_preset_id", styleId)
    .eq("is_example", true)
    .not("telegram_file_id", "is", null)
    .order("created_at", { ascending: false })
    .range(offset, offset)
    .maybeSingle();
  
  return data?.telegram_file_id || null;
}

async function countStyleExamples(styleId: string) {
  const { count } = await supabase
    .from("stickers")
    .select("id", { count: "exact", head: true })
    .eq("style_preset_id", styleId)
    .eq("is_example", true)
    .not("telegram_file_id", "is", null);
  
  return Math.min(count || 0, MAX_EXAMPLES);
}
```

### 7. Handler –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–º–µ—Ä–∞

```typescript
bot.action(/^style_example:(.+)$/, async (ctx) => {
  safeAnswerCbQuery(ctx);
  const styleId = ctx.match[1];
  const lang = /* –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ */;
  
  const fileId = await getStyleExample(styleId, 0);
  
  if (!fileId) {
    const text = lang === "ru" ? "–ü—Ä–∏–º–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç" : "No examples yet";
    await ctx.reply(text);
    return;
  }
  
  const styleName = /* –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è */;
  const caption = lang === "ru" 
    ? `–ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è ${styleName}` 
    : `${styleName} style example`;
  
  await ctx.replyWithSticker(fileId);
  
  const totalExamples = await countStyleExamples(styleId);
  const buttons = [];
  
  if (totalExamples > 1) {
    buttons.push([Markup.button.callback(
      lang === "ru" ? "–ï—â—ë" : "More",
      `style_example_more:${styleId}:1`
    )]);
  }
  buttons.push([Markup.button.callback(
    lang === "ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back",
    "back_to_styles"
  )]);
  
  await ctx.reply(caption, Markup.inlineKeyboard(buttons));
});
```

### 8. Handler –¥–ª—è "–ï—â—ë"

```typescript
bot.action(/^style_example_more:(.+):(\d+)$/, async (ctx) => {
  safeAnswerCbQuery(ctx);
  const styleId = ctx.match[1];
  const offset = parseInt(ctx.match[2], 10);
  const lang = /* –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ */;
  
  const fileId = await getStyleExample(styleId, offset);
  
  if (!fileId) {
    const text = lang === "ru" ? "–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ—Ç" : "No more examples";
    await ctx.reply(text, Markup.inlineKeyboard([
      [Markup.button.callback(lang === "ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back", "back_to_styles")]
    ]));
    return;
  }
  
  await ctx.replyWithSticker(fileId);
  
  const buttons = [];
  const totalExamples = await countStyleExamples(styleId);
  
  if (offset + 1 < totalExamples) {
    buttons.push([Markup.button.callback(
      lang === "ru" ? "–ï—â—ë" : "More",
      `style_example_more:${styleId}:${offset + 1}`
    )]);
  }
  buttons.push([Markup.button.callback(
    lang === "ru" ? "‚Üê –ù–∞–∑–∞–¥" : "‚Üê Back",
    "back_to_styles"
  )]);
  
  await ctx.reply("", Markup.inlineKeyboard(buttons));
});
```

### 9. Handler –¥–ª—è "–ù–∞–∑–∞–¥"

```typescript
bot.action("back_to_styles", async (ctx) => {
  safeAnswerCbQuery(ctx);
  // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª–µ–π
  // –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é –∏ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫–∞–∑–∞ —Å—Ç–∏–ª–µ–π
});
```

## –ß–µ–∫–ª–∏—Å—Ç

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è `034_style_examples.sql`
- [ ] –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞ ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å `style_preset_id`
- [ ] –ö–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º" –≤ –∞–ª–µ—Ä—Ç–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∏–∫–µ—Ä–∞
- [ ] Handler `make_example:{stickerId}`
- [ ] –¢–µ–∫—Å—Ç—ã –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ `texts.ts`
- [ ] –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ—Ä" –≤ UI –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª–µ–π
- [ ] Handler `style_example:{styleId}`
- [ ] Handler `style_example_more:{styleId}:{offset}`
- [ ] Handler `back_to_styles`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–†—É—á–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è:** –ê–¥–º–∏–Ω –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –≤—ã–±–æ—Ä –ø—Ä–∏–º–µ—Ä–æ–≤. –ü—Ä–∏ –∂–∞–ª–æ–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —É–±—Ä–∞—Ç—å `is_example = false`.

```sql
-- –£–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤
UPDATE stickers SET is_example = false WHERE id = 'xxx';
```
