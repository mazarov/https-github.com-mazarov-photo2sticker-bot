# Abandoned Cart Discount ‚Äî –°–∫–∏–¥–∫–∞ –¥–ª—è –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω

## –¶–µ–ª—å
–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–±—Ä–∞–ª–∏ —Ç–∞—Ä–∏—Ñ, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –æ–ø–ª–∞—Ç—É.

## –¢—Ä–∏–≥–≥–µ—Ä

- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ —Å—Ç–∞—Ç—É—Å–µ `created` –±–æ–ª–µ–µ **30 –º–∏–Ω—É—Ç**
- –ü–æ —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (`reminder_sent = false`)

## –ú–µ—Ö–∞–Ω–∏–∫–∞

### –°–∫—Ä—ã—Ç—ã–µ —Ç–∞—Ä–∏—Ñ—ã —Å–æ —Å–∫–∏–¥–∫–æ–π 10%

–î–æ–±–∞–≤–∏—Ç—å –≤ `CREDIT_PACKS` —Å–∫—Ä—ã—Ç—ã–µ —Ç–∞—Ä–∏—Ñ—ã (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º UI):

| –¢–∞—Ä–∏—Ñ | –ö—Ä–µ–¥–∏—Ç–æ–≤ | –û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞ | –¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π | –°–∫–∏–¥–∫–∞ |
|-------|----------|--------------|-----------------|--------|
| –õ–∞–π—Ç-10 | 10 | 150‚≠ê | 135‚≠ê | -10% |
| –ë—Ä–æ-10 | 30 | 300‚≠ê | 270‚≠ê | -10% |

```typescript
const CREDIT_PACKS = [
  { credits: 1, price: 1, price_rub: 1, label_ru: "üîß –¢–µ—Å—Ç", label_en: "üîß Test", adminOnly: true },
  { credits: 10, price: 150, price_rub: 150, label_ru: "üß™ –õ–∞–π—Ç", label_en: "üß™ Light" },
  { credits: 30, price: 300, price_rub: 300, label_ru: "‚≠ê –ë—Ä–æ", label_en: "‚≠ê Bro" },
  // –°–∫—Ä—ã—Ç—ã–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ UI)
  { credits: 10, price: 135, price_rub: 135, label_ru: "üß™ –õ–∞–π—Ç -10%", label_en: "üß™ Light -10%", hidden: true },
  { credits: 30, price: 270, price_rub: 270, label_ru: "‚≠ê –ë—Ä–æ -10%", label_en: "‚≠ê Bro -10%", hidden: true },
];
```

### –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–†—É—Å—Å–∫–∏–π:**
```
üõí –¢—ã –≤—ã–±—Ä–∞–ª –ø–∞–∫–µ—Ç "–õ–∞–π—Ç", –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –æ–ø–ª–∞—Ç—É.

–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è ‚Äî —Å–∫–∏–¥–∫–∞ 10%:
10 —Å—Ç–∏–∫–µ—Ä–æ–≤ –∑–∞ 135‚≠ê –≤–º–µ—Å—Ç–æ 150‚≠ê

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç 24 —á–∞—Å–∞ ‚è∞
```

**–ê–Ω–≥–ª–∏–π—Å–∫–∏–π:**
```
üõí You selected the "Light" pack but didn't complete the payment.

Special offer for you ‚Äî 10% off:
10 stickers for 135‚≠ê instead of 150‚≠ê

Offer valid for 24 hours ‚è∞
```

### –ö–Ω–æ–ø–∫–∞

```typescript
Markup.button.callback(
  "–û–ø–ª–∞—Ç–∏—Ç—å —Å–æ —Å–∫–∏–¥–∫–æ–π 135‚≠ê",
  `pack_10_135`  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∫—Ä—ã—Ç—ã–π —Ç–∞—Ä–∏—Ñ
)
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ transactions

```sql
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS reminder_sent boolean DEFAULT false;
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS reminder_sent_at timestamptz;
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: Cron Job (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:

```typescript
async function processAbandonedCarts() {
  // –ù–∞–π—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 30 –º–∏–Ω—É—Ç –±–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
  const { data: abandoned } = await supabase
    .from("transactions")
    .select("*, users(*)")
    .eq("state", "created")
    .eq("reminder_sent", false)
    .gt("price", 0)
    .lt("created_at", new Date(Date.now() - 30 * 60 * 1000).toISOString());

  for (const tx of abandoned || []) {
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–∫–∏–¥–∫–æ–π
    await sendDiscountOffer(tx.users.telegram_id, tx);
    
    // –û—Ç–º–µ—Ç–∏—Ç—å —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    await supabase
      .from("transactions")
      .update({ reminder_sent: true, reminder_sent_at: new Date().toISOString() })
      .eq("id", tx.id);
  }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Supabase Edge Function

–°–æ–∑–¥–∞—Ç—å Edge Function —Å cron —Ç—Ä–∏–≥–≥–µ—Ä–æ–º.

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- ‚úÖ –û–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- ‚úÖ –î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö)
- ‚úÖ –°–∫—Ä—ã—Ç—ã–µ —Ç–∞—Ä–∏—Ñ—ã –Ω–µ –≤–∏–¥–Ω—ã –≤ –æ–±—ã—á–Ω–æ–º –º–µ–Ω—é –ø–æ–∫—É–ø–∫–∏

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω (% –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è)
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ —Å–æ —Å–∫–∏–¥–∫–æ–π vs –±–µ–∑

## –ß–µ–∫–ª–∏—Å—Ç

- [x] –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ç–∞—Ä–∏—Ñ—ã –≤ CREDIT_PACKS
- [x] –ú–∏–≥—Ä–∞—Ü–∏—è: –ø–æ–ª–µ `reminder_sent` –≤ transactions
- [x] –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ —Å–∫–∏–¥–∫–æ–π
- [x] Cron job –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- [x] –¢–µ–∫—Å—Ç—ã –Ω–∞ ru/en
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
