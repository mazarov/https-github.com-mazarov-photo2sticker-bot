# Generation Progress ‚Äî –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

## –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞ —á–µ—Ä–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è.

---

## –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∏–ª—å
2. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: "‚ú® –ü—Ä–∏–Ω—è–ª! –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ç–∏–∫–µ—Ä..."
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥—ë—Ç ~50 —Å–µ–∫ –±–µ–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
4. –ü—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ç–∏–∫–µ—Ä

---

## –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

7 —à–∞–≥–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (~50 —Å–µ–∫):

```
üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ç–æ... (1/7)
‚Üì ~3 —Å–µ–∫
üé® –ü–æ–¥–±–∏—Ä–∞—é —Å—Ç–∏–ª—å... (2/7)
‚Üì ~5 —Å–µ–∫
‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... (3/7)
‚Üì ~20 —Å–µ–∫ (Gemini)
üñº –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç... (4/7)
‚Üì ~3 —Å–µ–∫
‚úÇÔ∏è –£–¥–∞–ª—è—é —Ñ–æ–Ω... (5/7)
‚Üì ~10 —Å–µ–∫ (Pixian)
üìê –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é —Ä–∞–∑–º–µ—Ä... (6/7)
‚Üì ~3 —Å–µ–∫
üì¶ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Å—Ç–∏–∫–µ—Ä... (7/7)
‚Üì ~3 —Å–µ–∫
[–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è]
‚Üì
[–°—Ç–∏–∫–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏]
```

---

## –≠—Ç–∞–ø—ã –∏ —Ç–µ–∫—Å—Ç—ã

| –®–∞–≥ | –ö–ª—é—á | RU | EN | –ö–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å |
|-----|------|----|----|------------------|
| 1 | `progress.step1` | üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ç–æ... (1/7) | üîç Analyzing photo... (1/7) | –°—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ |
| 2 | `progress.step2` | üé® –ü–æ–¥–±–∏—Ä–∞—é —Å—Ç–∏–ª—å... (2/7) | üé® Selecting style... (2/7) | –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–æ—Ç–æ |
| 3 | `progress.step3` | ‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... (3/7) | ‚ú® Generating image... (3/7) | –ü–µ—Ä–µ–¥ Gemini API |
| 4 | `progress.step4` | üñº –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç... (4/7) | üñº Processing result... (4/7) | –ü–æ—Å–ª–µ Gemini API |
| 5 | `progress.step5` | ‚úÇÔ∏è –£–¥–∞–ª—è—é —Ñ–æ–Ω... (5/7) | ‚úÇÔ∏è Removing background... (5/7) | –ü–µ—Ä–µ–¥ Pixian API |
| 6 | `progress.step6` | üìê –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é —Ä–∞–∑–º–µ—Ä... (6/7) | üìê Optimizing size... (6/7) | –ü–æ—Å–ª–µ Pixian API |
| 7 | `progress.step7` | üì¶ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Å—Ç–∏–∫–µ—Ä... (7/7) | üì¶ Preparing sticker... (7/7) | –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π |

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ü–æ–ª—è –≤ `sessions` (—É–∂–µ –µ—Å—Ç—å)

```sql
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS progress_message_id bigint;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS progress_chat_id bigint;
```

### 2. API (index.ts) ‚Äî –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```typescript
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—à–∞–≥ 1)
const progressMsg = await ctx.reply(await getText(lang, "progress.step1"));

// –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –∏ chat_id –≤ —Å–µ—Å—Å–∏—é
await supabase
  .from("sessions")
  .update({ 
    progress_message_id: progressMsg.message_id,
    progress_chat_id: ctx.chat.id 
  })
  .eq("id", session.id);
```

### 3. Worker (worker.ts) ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

```typescript
async function updateProgress(session: any, lang: string, step: 1 | 2 | 3 | 4 | 5 | 6 | 7) {
  if (!session.progress_message_id || !session.progress_chat_id) return;
  
  try {
    await editMessageText(
      session.progress_chat_id, 
      session.progress_message_id, 
      await getText(lang, `progress.step${step}`)
    );
  } catch (err) {
    // ignore edit errors
  }
}

async function clearProgress(session: any) {
  if (!session.progress_message_id || !session.progress_chat_id) return;
  
  try {
    await deleteMessage(session.progress_chat_id, session.progress_message_id);
  } catch (err) {
    // ignore delete errors
  }
}
```

### 4. Worker ‚Äî –≤—ã–∑–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

```typescript
async function runJob(job: any) {
  // ... –ø–æ–ª—É—á–µ–Ω–∏–µ session, user, lang ...

  // –®–∞–≥ 2: –ü–æ–¥–±–∏—Ä–∞—é —Å—Ç–∏–ª—å
  await updateProgress(session, lang, 2);
  
  const filePath = await getFilePath(sourceFileId);
  const fileBuffer = await downloadFile(filePath);
  const base64 = fileBuffer.toString("base64");

  // –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  await updateProgress(session, lang, 3);
  
  const geminiRes = await axios.post(/* Gemini API */);
  
  // –®–∞–≥ 4: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  await updateProgress(session, lang, 4);
  
  const generatedBuffer = Buffer.from(imageBase64, "base64");

  // –®–∞–≥ 5: –£–¥–∞–ª—è—é —Ñ–æ–Ω
  await updateProgress(session, lang, 5);
  
  const pixianRes = await axios.post(/* Pixian API */);
  
  // –®–∞–≥ 6: –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é —Ä–∞–∑–º–µ—Ä
  await updateProgress(session, lang, 6);
  
  const stickerBuffer = await sharp(noBgBuffer)
    .trim()
    .resize(512, 512, { fit: "contain", background: transparent })
    .webp()
    .toBuffer();

  // –®–∞–≥ 7: –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Å—Ç–∏–∫–µ—Ä
  await updateProgress(session, lang, 7);
  
  // Upload to storage
  await supabase.storage.from(bucket).upload(path, stickerBuffer);
  
  // Save to history
  await supabase.from("stickers").insert({ ... });
  
  // Send sticker
  const stickerFileId = await sendSticker(telegramId, stickerBuffer, replyMarkup);
  
  // Clear progress message
  await clearProgress(session);
  
  // Update session
  await supabase.from("sessions").update({ ... }).eq("id", session.id);
}
```

---

## SQL –º–∏–≥—Ä–∞—Ü–∏—è

```sql
-- Progress texts (7 steps)
INSERT INTO bot_texts_new (lang, key, text) VALUES
  ('ru', 'progress.step1', 'üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ç–æ... (1/7)'),
  ('en', 'progress.step1', 'üîç Analyzing photo... (1/7)'),
  ('ru', 'progress.step2', 'üé® –ü–æ–¥–±–∏—Ä–∞—é —Å—Ç–∏–ª—å... (2/7)'),
  ('en', 'progress.step2', 'üé® Selecting style... (2/7)'),
  ('ru', 'progress.step3', '‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... (3/7)'),
  ('en', 'progress.step3', '‚ú® Generating image... (3/7)'),
  ('ru', 'progress.step4', 'üñº –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç... (4/7)'),
  ('en', 'progress.step4', 'üñº Processing result... (4/7)'),
  ('ru', 'progress.step5', '‚úÇÔ∏è –£–¥–∞–ª—è—é —Ñ–æ–Ω... (5/7)'),
  ('en', 'progress.step5', '‚úÇÔ∏è Removing background... (5/7)'),
  ('ru', 'progress.step6', 'üìê –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é —Ä–∞–∑–º–µ—Ä... (6/7)'),
  ('en', 'progress.step6', 'üìê Optimizing size... (6/7)'),
  ('ru', 'progress.step7', 'üì¶ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Å—Ç–∏–∫–µ—Ä... (7/7)'),
  ('en', 'progress.step7', 'üì¶ Preparing sticker... (7/7)')
ON CONFLICT (lang, key) DO UPDATE SET
  text = EXCLUDED.text,
  updated_at = now();

-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ (3 —à–∞–≥–∞)
DELETE FROM bot_texts_new WHERE key IN (
  'progress.generating_image',
  'progress.removing_bg', 
  'progress.preparing'
);
```

---

## Fallback —Ç–µ–∫—Å—Ç—ã (texts.ts)

```typescript
// RU
"progress.step1": "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ç–æ... (1/7)",
"progress.step2": "üé® –ü–æ–¥–±–∏—Ä–∞—é —Å—Ç–∏–ª—å... (2/7)",
"progress.step3": "‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... (3/7)",
"progress.step4": "üñº –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç... (4/7)",
"progress.step5": "‚úÇÔ∏è –£–¥–∞–ª—è—é —Ñ–æ–Ω... (5/7)",
"progress.step6": "üìê –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é —Ä–∞–∑–º–µ—Ä... (6/7)",
"progress.step7": "üì¶ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Å—Ç–∏–∫–µ—Ä... (7/7)",

// EN
"progress.step1": "üîç Analyzing photo... (1/7)",
"progress.step2": "üé® Selecting style... (2/7)",
"progress.step3": "‚ú® Generating image... (3/7)",
"progress.step4": "üñº Processing result... (4/7)",
"progress.step5": "‚úÇÔ∏è Removing background... (5/7)",
"progress.step6": "üìê Optimizing size... (6/7)",
"progress.step7": "üì¶ Preparing sticker... (7/7)",
```

---

## –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (~50 —Å–µ–∫)

| –®–∞–≥ | –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è |
|-----|----------|-------|
| 1‚Üí2 | –°—Ç–∞—Ä—Ç, –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ | ~3 —Å–µ–∫ |
| 2‚Üí3 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö | ~2 —Å–µ–∫ |
| 3‚Üí4 | Gemini API | ~20 —Å–µ–∫ |
| 4‚Üí5 | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ | ~2 —Å–µ–∫ |
| 5‚Üí6 | Pixian API | ~10 —Å–µ–∫ |
| 6‚Üí7 | Sharp resize | ~2 —Å–µ–∫ |
| 7‚Üídone | Upload + –æ—Ç–ø—Ä–∞–≤–∫–∞ | ~3 —Å–µ–∫ |
| **–ò—Ç–æ–≥–æ** | | **~42-50 —Å–µ–∫** |

---

## –ß–µ–∫–ª–∏—Å—Ç

- [ ] –û–±–Ω–æ–≤–∏—Ç—å fallback —Ç–µ–∫—Å—Ç—ã –≤ `texts.ts` (7 —à–∞–≥–æ–≤)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é `009_generation_progress.sql`
- [ ] API: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `progress.step1` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- [ ] Worker: –≤—ã–∑—ã–≤–∞—Ç—å `updateProgress` –Ω–∞ –∫–∞–∂–¥–æ–º –∏–∑ 7 —ç—Ç–∞–ø–æ–≤
- [ ] Worker: —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ (3 —à–∞–≥–∞)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
