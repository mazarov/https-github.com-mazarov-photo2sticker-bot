# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç–∏–∫–µ—Ä

## –¶–µ–ª—å

–ü–æ–∑–≤–æ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∏–∫–µ—Ä. Gemini –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç–∏–ª—å –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.

## UI Flow

```
[–°—Ç–∏–∫–µ—Ä]
[‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–∫] [üé® –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å]
[üòä –ò–∑–º–µ–Ω–∏—Ç—å —ç–º–æ—Ü–∏—é] [üèÉ –ò–∑–º–µ–Ω–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ]
[‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç]  ‚Üê –Ω–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
```

## –°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç **"‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç"**
2. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç: *"–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞:"*
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–ü—Ä–∏–≤–µ—Ç!`)
4. –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä —Å —Ç–µ–∫—Å—Ç–æ–º ‚Äî **1 –∫—Ä–µ–¥–∏—Ç**
5. –°—Ç–∏–∫–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Ç–µ–º–∏ –∂–µ –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π

## –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini

```
Add the following text EXACTLY as written to the sticker: "{text}"

IMPORTANT: 
- Do NOT translate the text
- Do NOT change the text in any way
- Use the EXACT characters provided by the user

The text should be integrated naturally and visually appealing - it can appear on a sign, 
banner, speech bubble, or creatively placed within the image. 
Keep the same character, style, and colors.
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:**
- –¢–µ–∫—Å—Ç –ù–ï –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è
- –¢–µ–∫—Å—Ç –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¢–û–ß–ù–û —Ç–µ —Å–∏–º–≤–æ–ª—ã, —á—Ç–æ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

**–ü—Ä–∏–º–µ—Ä:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª: `–ü—Ä–∏–≤–µ—Ç!`
- –ù–∞ —Å—Ç–∏–∫–µ—Ä–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `–ü—Ä–∏–≤–µ—Ç!` (–Ω–µ "Hello!", –Ω–µ "Privet!")

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ sessions

```sql
-- –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è session_state enum
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_text';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'processing_text';

-- –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS text_prompt text;
```

### –ü–æ–ª—è —Å–µ—Å—Å–∏–∏

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| state | session_state | `wait_text` ‚Äî –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ |
| state | session_state | `processing_text` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç–µ–∫—Å—Ç–æ–º |
| text_prompt | text | –í–≤–µ–¥—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ç–µ–∫—Å—Ç |

## –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

### –¢–µ–∫—Å—Ç—ã

| –ö–ª—é—á | RU | EN |
|------|----|----|
| `btn.add_text` | ‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç | ‚úèÔ∏è Add text |
| `text.prompt` | –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞: | Enter text for the sticker: |

### SQL –º–∏–≥—Ä–∞—Ü–∏—è

```sql
INSERT INTO bot_texts_new (lang, key, text) VALUES
  ('ru', 'btn.add_text', '‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç'),
  ('en', 'btn.add_text', '‚úèÔ∏è Add text'),
  ('ru', 'text.prompt', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞:'),
  ('en', 'text.prompt', 'Enter text for the sticker:')
ON CONFLICT (key, lang) DO UPDATE SET text = EXCLUDED.text;
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### index.ts ‚Äî –ö–Ω–æ–ø–∫–∞ –≤ replyMarkup

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ —Å—Ç–∏–∫–µ—Ä–∞
const addTextBtn = await getText(lang, "btn.add_text");
// ...
[
  { text: addTextBtn, callback_data: `add_text:${stickerId}` }
]
```

### index.ts ‚Äî Callback handler

```typescript
// Callback: add text to sticker
bot.action(/^add_text:(.+)$/, async (ctx) => {
  safeAnswerCbQuery(ctx);
  const telegramId = ctx.from?.id;
  if (!telegramId) return;

  const user = await getUser(telegramId);
  if (!user?.id) return;

  const lang = user.lang || "en";
  const stickerId = ctx.match[1];

  // Get sticker from DB
  const { data: sticker } = await supabase
    .from("stickers")
    .select("telegram_file_id, source_photo_file_id, user_id")
    .eq("id", stickerId)
    .maybeSingle();

  if (!sticker?.telegram_file_id || sticker.user_id !== user.id) {
    return;
  }

  // Get or create session
  let session = await getActiveSession(user.id);
  if (!session?.id) {
    const { data: newSession } = await supabase
      .from("sessions")
      .insert({ user_id: user.id, state: "wait_text", is_active: true })
      .select()
      .single();
    session = newSession;
  }

  if (!session?.id) return;

  // Update session
  await supabase
    .from("sessions")
    .update({
      state: "wait_text",
      is_active: true,
      last_sticker_file_id: sticker.telegram_file_id,
      current_photo_file_id: sticker.source_photo_file_id,
    })
    .eq("id", session.id);

  await ctx.reply(await getText(lang, "text.prompt"));
});
```

### index.ts ‚Äî Text handler

```typescript
// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
if (session.state === "wait_text") {
  const textInput = ctx.message.text.trim();
  if (!session.last_sticker_file_id) {
    await ctx.reply(await getText(lang, "error.no_stickers_added"));
    return;
  }

  const promptFinal = buildTextPrompt(textInput);
  await startGeneration(ctx, user, session, lang, {
    generationType: "text",
    promptFinal,
    textPrompt: textInput,
  });
  return;
}
```

### index.ts ‚Äî buildTextPrompt function

```typescript
function buildTextPrompt(text: string): string {
  return `Add the following text EXACTLY as written to the sticker: "${text}"

IMPORTANT: 
- Do NOT translate the text
- Do NOT change the text in any way
- Use the EXACT characters provided by the user

The text should be integrated naturally and visually appealing - it can appear on a sign, banner, speech bubble, or creatively placed within the image. Keep the same character, style, and colors.`;
}
```

### worker.ts ‚Äî –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É generationType "text"

```typescript
const generationType =
  session.generation_type || 
  (session.state === "processing_emotion" ? "emotion" : 
   session.state === "processing_motion" ? "motion" :
   session.state === "processing_text" ? "text" : "style");

// –î–ª—è text –∏—Å–ø–æ–ª—å–∑—É–µ–º last_sticker_file_id –∫–∞–∫ source
const sourceFileId =
  generationType === "emotion" || generationType === "motion" || generationType === "text"
    ? session.last_sticker_file_id
    : session.current_photo_file_id || photos[photos.length - 1];
```

## –°—Ç–æ–∏–º–æ—Å—Ç—å

1 –∫—Ä–µ–¥–∏—Ç (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —ç–º–æ—Ü–∏–∏/–¥–≤–∏–∂–µ–Ω–∏—é)

## Checklist

- [x] SQL –º–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å `wait_text`, `processing_text` –≤ enum (`sql/019_add_text.sql`)
- [x] SQL –º–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å `text_prompt` –ø–æ–ª–µ –≤ sessions
- [x] SQL –º–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é
- [x] –î–æ–±–∞–≤–∏—Ç—å fallback —Ç–µ–∫—Å—Ç—ã –≤ `texts.ts`
- [x] –î–æ–±–∞–≤–∏—Ç—å `buildTextPrompt` —Ñ—É–Ω–∫—Ü–∏—é –≤ `index.ts`
- [x] –î–æ–±–∞–≤–∏—Ç—å callback handler `add_text:ID` –≤ `index.ts`
- [x] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `wait_text` –≤ text handler
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ replyMarkup –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞ (`worker.ts`)
- [x] –û–±–Ω–æ–≤–∏—Ç—å `startGeneration` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `generationType: "text"`
- [x] –û–±–Ω–æ–≤–∏—Ç—å `worker.ts` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ `processing_text`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä—É—Å—Å–∫–∏–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º
