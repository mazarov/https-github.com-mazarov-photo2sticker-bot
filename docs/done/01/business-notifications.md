# –ë–∏–∑–Ω–µ—Å-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Business Notifications)

## –¶–µ–ª—å

–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –≤ Telegram-–∫–∞–Ω–∞–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞.

## –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –¢–∏–ø | Emoji | –ö–æ–≥–¥–∞ |
|-----|-------|-------|
| `new_user` | üë§ | –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è |
| `new_sticker` | üé® | –°—Ç–∏–∫–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω |
| `new_payment` | üí∞ | –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ |

## –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```
üë§ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

@username (42269230)
üåê –Ø–∑—ã–∫: ru
```

### –ù–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä (media group: –∏—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ + —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
```
üé® –ù–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä

üë§ @username (42269230)
üí∞ –ö—Ä–µ–¥–∏—Ç—ã: 5
üé® –°—Ç–∏–ª—å: anime
üòä –≠–º–æ—Ü–∏—è: happy (–∏–ª–∏ -)
üèÉ –î–≤–∏–∂–µ–Ω–∏–µ: dance (–∏–ª–∏ -)
‚úçÔ∏è –¢–µ–∫—Å—Ç: "Hello" (–∏–ª–∏ -)

[–§–æ—Ç–æ 1: –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]
[–§–æ—Ç–æ 2: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏]
```

**–§–æ—Ä–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏:** Telegram Media Group –∏–∑ 2 —Ñ–æ—Ç–æ —Å caption –Ω–∞ –ø–µ—Ä–≤–æ–º.

### –ù–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞
```
üí∞ –ù–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞

üë§ @username (42269230)
üì¶ –ü–∞–∫–µ—Ç: 30 –∫—Ä–µ–¥–∏—Ç–æ–≤
‚≠ê –°—É–º–º–∞: 150 Stars
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–∞–Ω–∞–ª —á—Ç–æ –∏ –¥–ª—è –æ—à–∏–±–æ–∫:
```env
ALERT_CHANNEL_ID=-100xxx
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø: –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **–±–µ–∑ await** ‚Äî –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

```typescript
sendNotification(...).catch(err => console.error("Notification failed:", err));
```

### –ú–æ–¥—É–ª—å: `src/lib/alerts.ts`

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∏ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ media group:

```typescript
type NotificationType = "new_user" | "new_sticker" | "new_payment";

async function sendNotification(options: {
  type: NotificationType;
  message: string;
  imageBuffer?: Buffer;       // –û–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  sourceImageBuffer?: Buffer; // –ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ (–¥–ª—è new_sticker)
  resultImageBuffer?: Buffer; // –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–¥–ª—è new_sticker)
}): Promise<void>;
```

**–õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:**
- –ï—Å–ª–∏ –µ—Å—Ç—å `sourceImageBuffer` + `resultImageBuffer` ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ media group
- –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ `imageBuffer` ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ –æ–¥–Ω–æ —Ñ–æ—Ç–æ
- –ò–Ω–∞—á–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –§–∞–π–ª | –ú–µ—Å—Ç–æ | –¢–∏–ø |
|------|-------|-----|
| `index.ts` | –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ /start | `new_user` |
| `worker.ts` | –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞ | `new_sticker` |
| `index.ts` | –ü–æ—Å–ª–µ successful_payment | `new_payment` |

### index.ts ‚Äî new_user

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if (isNewUser && user) {
  sendNotification({
    type: "new_user",
    message: `@${ctx.from?.username || "no_username"} (${telegramId})\nüåê –Ø–∑—ã–∫: ${lang}`,
  }).catch(console.error);
}
```

### worker.ts ‚Äî new_sticker

```typescript
// –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
const emotionText = session.selected_emotion || "-";
const motionText = generationType === "motion" ? (session.selected_emotion || "-") : "-";
const textText = session.text_prompt ? `"${session.text_prompt}"` : "-";

sendNotification({
  type: "new_sticker",
  message: [
    `üë§ @${user.username || user.telegram_id} (${telegramId})`,
    `üí∞ –ö—Ä–µ–¥–∏—Ç—ã: ${user.credits}`,
    `üé® –°—Ç–∏–ª—å: ${session.selected_style_id || "-"}`,
    `üòä –≠–º–æ—Ü–∏—è: ${emotionText}`,
    `üèÉ –î–≤–∏–∂–µ–Ω–∏–µ: ${motionText}`,
    `‚úçÔ∏è –¢–µ–∫—Å—Ç: ${textText}`,
  ].join("\n"),
  sourceImageBuffer: fileBuffer,  // –ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ
  resultImageBuffer: stickerBuffer,  // –†–µ–∑—É–ª—å—Ç–∞—Ç
}).catch(console.error);
```

### index.ts ‚Äî new_payment

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
sendNotification({
  type: "new_payment",
  message: `üë§ @${user.username || telegramId}\nüì¶ –ü–∞–∫–µ—Ç: ${amount} –∫—Ä–µ–¥–∏—Ç–æ–≤\n‚≠ê –°—É–º–º–∞: ${price} Stars`,
}).catch(console.error);
```

## Checklist

- [x] –û–±–Ω–æ–≤–∏—Ç—å `src/lib/alerts.ts` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `sendNotification` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `index.ts` ‚Äî new_user –ø—Ä–∏ /start
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `worker.ts` ‚Äî new_sticker –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `index.ts` ‚Äî new_payment –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä—ë—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### v2 –£–ª—É—á—à–µ–Ω–∏—è (TODO)

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `src/lib/alerts.ts` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É media group (2 —Ñ–æ—Ç–æ)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `worker.ts` ‚Äî –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  - –ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ (`sourceImageBuffer`)
  - –†–µ–∑—É–ª—å—Ç–∞—Ç (`resultImageBuffer`)  
  - –ö—Ä–µ–¥–∏—Ç—ã, —Å—Ç–∏–ª—å, —ç–º–æ—Ü–∏—è, –¥–≤–∏–∂–µ–Ω–∏–µ, —Ç–µ–∫—Å—Ç
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ media group —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
