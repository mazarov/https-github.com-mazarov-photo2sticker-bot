# Ğ¤Ğ¸Ñ‡Ğ°: Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ» â€” Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº Ğ·Ğ° N ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²

**Ğ”Ğ°Ñ‚Ğ°:** 15.02.2026
**ĞŸÑ€Ğ¾ĞµĞºÑ‚:** photo2sticker-bot (@photo2sticker_bot)
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ v4 (labels-first + Ğ²Ñ‹Ğ±Ğ¾Ñ€ style preset v2 Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ€ĞµĞ²ÑŒÑ + identity-first)

---

## 1. Ğ¡ÑƒÑ‚ÑŒ

ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ»Ğ¾Ñƒ Ğ² Ğ±Ğ¾Ñ‚Ğµ: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ **Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ»** Ğ² Ğ½Ğ¸Ğ¶Ğ½ĞµĞ¼ Ğ¼ĞµĞ½Ñ,
Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ°, Ğ¿Ñ€Ğ¸ÑÑ‹Ğ»Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾, Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚
**Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Telegram-ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº** Ğ¸Ğ· N ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² (Ñ‚ĞµÑÑ‚: 4, Ñ„Ğ¸Ğ½Ğ°Ğ»: 16).

**ĞĞ¿Ğ»Ğ°Ñ‚Ğ° ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°Ğ¼Ğ¸:** 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ¿Ñ€ĞµĞ²ÑŒÑ + (N-1) ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ¿Ğ°Ğº = **N ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² Ğ¸Ñ‚Ğ¾Ğ³Ğ¾**.
Ğ®Ğ·ĞµÑ€ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¿Ñ€ĞµĞ²ÑŒÑ (Ğ»Ğ¸ÑÑ‚ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² Ğ¾Ñ‚ Gemini), Ğ¾Ğ´Ğ¾Ğ±Ñ€ÑĞµÑ‚, Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ·Ğ° Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ğº.

Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ â€” **Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Telegram sticker set** (`createNewStickerSet` + `addStickerToSet`),
ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞ±Ğµ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ñ‡Ğ°Ñ‚Ğ°Ñ….

---

## 2. User Flow

```
[ĞĞ¸Ğ¶Ğ½ĞµĞµ Ğ¼ĞµĞ½Ñ] Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ»
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ­ĞºÑ€Ğ°Ğ½-Ğ¿Ñ€ĞµĞ²ÑŒÑ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°   â”‚
â”‚  ĞšĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°-ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶ +      â”‚
â”‚  Ñ‚ĞµĞºÑÑ‚ + ĞºĞ½Ğ¾Ğ¿ĞºĞ° CTA     â”‚
â”‚  [â†]  [ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ]  [â†’]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Ğ½Ğ°Ğ¶Ğ°Ğ» CTA
        â–¼
  Â«ĞŸÑ€Ğ¸ÑˆĞ»Ğ¸ Ğ¾Ğ´Ğ½Ğ¾ Ñ„Ğ¾Ñ‚Ğ¾Â»
        â”‚ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ğ» Ñ„Ğ¾Ñ‚Ğ¾ (Ğ¸Ğ»Ğ¸ Ğ±ĞµÑ€Ñ‘Ğ¼ last_photo_file_id)
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑÑ‚Ğ¸Ğ»Ñ (style_presets_v2)     â”‚
  â”‚  [âœ… Cartoon] [Watercolor] ...       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ» ÑÑ‚Ğ¸Ğ»ÑŒ
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Â«Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ·Ğ° 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Â» â”‚
  â”‚  [ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ â€” 1 ğŸ’]       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Ğ½Ğ°Ğ¶Ğ°Ğ» â†’ ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚
        â–¼
  Gemini Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ‚ Ğ»Ğ¸ÑÑ‚ NxN (~15 ÑĞµĞº)
  (Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ: Â«Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ...Â»)
        â”‚
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸ“¸ ĞŸÑ€ĞµĞ²ÑŒÑ (Ğ»Ğ¸ÑÑ‚ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²)          â”‚
  â”‚                                     â”‚
  â”‚  Â«Ğ’Ğ¾Ñ‚ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑÑ! ĞÑ€Ğ°Ğ²Ğ¸Ñ‚ÑÑ?Â»     â”‚
  â”‚  [âœ… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº â€” {N-1} ğŸ’]        â”‚
  â”‚  [ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” 1 ğŸ’]        â”‚
  â”‚  [âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°]                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ»
        â”‚ ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²
        â–¼
  ĞĞ°Ñ€ĞµĞ·ĞºĞ° Ğ½Ğ° N ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²
  rembg Ã— N (Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾)
  Ğ¢ĞµĞºÑÑ‚-Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹ Ã— N (Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°)
        â”‚
        â–¼
  createNewStickerSet +
  addStickerToSet Ã— 3
        â”‚
        â–¼
  Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ğº
  + ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Â«ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°ĞºÂ» / Â«Ğ’ Ğ¼ĞµĞ½ÑÂ»
```

---

## 3. Ğ­ĞºÑ€Ğ°Ğ½-Ğ¿Ñ€ĞµĞ²ÑŒÑ

### Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼

- **ĞšĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°-ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶** â€” Ğ·Ğ°Ñ€Ğ°Ğ½ĞµĞµ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ (Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº file_id Ğ¸Ğ»Ğ¸ URL).
  Ğ­Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ĞºĞ°Ğº **Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµÑ„ĞµÑ€ĞµĞ½Ñ Ğ´Ğ»Ñ Gemini** (Ğ³Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´).
- **Ğ¢ĞµĞºÑÑ‚** (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ ru):

```
Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚ĞµĞ»ĞµĞ³Ñ€Ğ°Ğ¼ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ¹ Ğ¿Ğ°Ñ€Ñ‹ ğŸ’–

ĞšĞ°Ğº Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ: Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞµ Ğ½Ğ¸Ğ¶Ğµ, Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾
Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 3 Ğ¼Ğ¸Ğ½ÑƒÑ‚!

ĞšÑƒĞ»ÑŒÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹
```

### ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ (inline)

```
[  â—€ï¸  ] [ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ] [  â–¶ï¸  ]
```

- `â—€ï¸` / `â–¶ï¸` â€” Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° (Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ¾Ğ´Ğ¸Ğ½ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½, ĞºĞ½Ğ¾Ğ¿ĞºĞ¸-Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸ Ñ `noop`).
- CTA â€” `pack_order:TEMPLATE_ID` â†’ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² `wait_pack_photo`.
- ĞĞ¿Ğ»Ğ°Ñ‚Ğ° ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°Ğ¼Ğ¸: 1ğŸ’ Ğ·Ğ° Ğ¿Ñ€ĞµĞ²ÑŒÑ + (N-1)ğŸ’ Ğ·Ğ° Ğ¿Ğ°Ğº. Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ N ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² Ğ·Ğ° N ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ².

### Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑÑ‚Ğ¸Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ€ĞµĞ²ÑŒÑ (ĞĞĞ’ĞĞ•)

- ĞŸĞµÑ€ĞµĞ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ `ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ â€” 1 ğŸ’` Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ· `style_presets_v2`.
- Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² `sessions.selected_style_id` Ğ¸ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Gemini.
- Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚ (Ğ¿Ğ¾ Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ style picker: last/default/random).
- ĞĞ° ÑˆĞ°Ğ³Ğµ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ¼ĞµĞ½ÑÑ‚ÑŒ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸ Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ.

### Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ²

Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `pack_templates`:

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| `id` | text | PK, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ `couple_v1` |
| `name_ru` / `name_en` | text | Â«ĞŸĞ°Ñ€Ğ°Â» / Â«CoupleÂ» |
| `description_ru` / `description_en` | text | Ğ¢ĞµĞºÑÑ‚ Ğ¿Ñ€ĞµĞ²ÑŒÑ |
| `preview_file_id` | text | Telegram file_id ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸-ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶Ğ° |
| `preview_url` | text | Fallback URL ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸ |
| `collage_file_id` | text | Telegram file_id ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶Ğ° Ğ´Ğ»Ñ Gemini |
| `collage_url` | text | Fallback URL ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶Ğ° Ğ´Ğ»Ñ Gemini |
| `sticker_count` | int | 4 (Ñ‚ĞµÑÑ‚) â†’ 16 (Ñ„Ğ¸Ğ½Ğ°Ğ») |
| â€” | â€” | *Ğ¦ĞµĞ½Ğ° = `sticker_count` ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² (1ğŸ’ Ğ¿Ñ€ĞµĞ²ÑŒÑ + N-1ğŸ’ Ğ¿Ğ°Ğº)* |
| `labels` | jsonb | ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ², RU (1-2 ÑĞ»Ğ¾Ğ²Ğ° + ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸) |
| `labels_en` | jsonb | ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ², EN |
| `scene_descriptions` | jsonb | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑÑ†ĞµĞ½ Ğ´Ğ»Ñ Gemini (EN, Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ½Ğ° ÑÑ‚Ğ¸ĞºĞµÑ€) |
| `style_prompt_base` | text | Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ ÑÑ‚Ğ¸Ğ»Ñ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° |
| `sort_order` | int | ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ² ĞºĞ°Ñ€ÑƒÑĞµĞ»Ğ¸ |
| `is_active` | boolean | ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ»Ğ¸ |
| `created_at` | timestamptz | â€” |

---

## 4. Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸

### ĞĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ `session_state` enum

```sql
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_pack_photo';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_pack_preview_payment';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'generating_pack_preview';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_pack_approval';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'processing_pack';
```

### Ğ¤Ğ»Ğ¾Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹

```
wait_pack_photo
    â”‚ [Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾]
    â–¼
wait_pack_preview_payment
    â”‚ [Ğ½Ğ°Ğ¶Ğ°Ğ» "ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ â€” 1 ğŸ’"]
    â”‚ [ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚]
    â–¼
generating_pack_preview
    â”‚ [Gemini ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ğ» Ğ»Ğ¸ÑÑ‚]
    â”‚ [Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ»Ğ¸ Ğ¿Ñ€ĞµĞ²ÑŒÑ]
    â–¼
wait_pack_approval â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               â”‚
    â”œâ”€[âœ… "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº â€” N-1 ğŸ’"]   â”‚
    â”‚  [ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²]       â”‚
    â”‚                               â”‚
    â”œâ”€[ğŸ”„ "ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” 1 ğŸ’"] â”‚
    â”‚  [ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚]           â”‚
    â”‚  â†’ generating_pack_preview â”€â”€â”€â”˜
    â”‚
    â”œâ”€[âŒ "ĞÑ‚Ğ¼ĞµĞ½Ğ°"]
    â”‚  â†’ idle / confirm_sticker
    â”‚
    â–¼
processing_pack
    â”‚ [Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ° + rembg + Ñ‚ĞµĞºÑÑ‚ + ÑĞ±Ğ¾Ñ€ĞºĞ°]
    â–¼
confirm_sticker (Ğ¿Ğ°Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²)
```

### ĞŸĞ¾Ğ»Ñ Ğ² `sessions`

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| `pack_template_id` | text | ID ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° Ğ¿Ğ°ĞºĞ° (FK â†’ pack_templates) |
| `pack_batch_id` | uuid | ID Ğ±Ğ°Ñ‚Ñ‡Ğ° (FK â†’ pack_batches) |
| `pack_sheet_file_id` | text | Telegram file_id Ğ¿Ñ€ĞµĞ²ÑŒÑ-Ğ»Ğ¸ÑÑ‚Ğ° (Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ) |

ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ:
- `current_photo_file_id` â€” Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- `selected_style_id` â€” Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ· `style_presets_v2` Ğ´Ğ»Ñ pack preview
- `progress_message_id` / `progress_chat_id` â€” Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

### Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ²ÑŒÑ-Ğ»Ğ¸ÑÑ‚Ğ°

ĞŸĞ¾ÑĞ»Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Gemini â†’ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ»Ğ¸ÑÑ‚ ĞºĞ°Ğº Ñ„Ğ¾Ñ‚Ğ¾ Ğ² Ñ‡Ğ°Ñ‚ â†’ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ `file_id`
Ğ² `session.pack_sheet_file_id`. ĞŸÑ€Ğ¸ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğ¸ â†’ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ `file_id` â†’ Ğ½Ğ°Ñ€ĞµĞ·Ğ°ĞµĞ¼.

Ğ­Ñ‚Ğ¾ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ĞµĞ· Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°.

---

## 5. ĞĞ¿Ğ»Ğ°Ñ‚Ğ°

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿

- **ĞšÑ€ĞµĞ´Ğ¸Ñ‚Ñ‹.** ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°Ğ¼Ğ¸ (ğŸ’).
- ĞŸÑ€ĞµĞ²ÑŒÑ = **1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚** (Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¸ÑÑ‚Ğ° Gemini).
- ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ğº = **N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²** (Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ° + Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° + ÑĞ±Ğ¾Ñ€ĞºĞ°).
- **Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ·Ğ° Ğ¿Ğ°Ğº: N ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²** (Ñ‚ĞµÑÑ‚: 4, Ñ„Ğ¸Ğ½Ğ°Ğ»: 16).
- Ğ•ÑĞ»Ğ¸ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.
- `has_purchased` ĞĞ• Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ.
- ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… invoice/product_type â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ².

### Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ

| | ĞŸÑ€ĞµĞ²ÑŒÑ | ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ğº | Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ |
|---|---|---|---|
| **Ğ¢ĞµÑÑ‚ (4 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°)** | 1 ğŸ’ | 3 ğŸ’ | **4 ğŸ’** |
| **Ğ¤Ğ¸Ğ½Ğ°Ğ» (16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²)** | 1 ğŸ’ | 15 ğŸ’ | **16 ğŸ’** |

### Ğ”Ğ²ÑƒÑ…ÑÑ‚Ğ°Ğ¿Ğ½Ğ°Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°

```
Ğ­Ñ‚Ğ°Ğ¿ 1: ĞŸĞ Ğ•Ğ’Ğ¬Ğ® (1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Ğ®Ğ·ĞµÑ€ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ â€” 1 ğŸ’Â»
  â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ >= 1
  â†’ Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚
  â†’ Gemini Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ‚ Ğ»Ğ¸ÑÑ‚ (~15 ÑĞµĞº)
  â†’ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ ÑĞ·ĞµÑ€Ñƒ

Ğ­Ñ‚Ğ°Ğ¿ 2: ĞŸĞĞ›ĞĞ«Ğ™ ĞŸĞĞš (N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Ğ®Ğ·ĞµÑ€ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº â€” {N-1} ğŸ’Â»
  â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ >= N-1
  â†’ Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²
  â†’ ĞĞ°Ñ€ĞµĞ·ĞºĞ° + rembg + Ñ‚ĞµĞºÑÑ‚ + ÑĞ±Ğ¾Ñ€ĞºĞ°
  â†’ Ğ”Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº

ĞŸĞ•Ğ Ğ•Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Ğ®Ğ·ĞµÑ€ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” 1 ğŸ’Â»
  â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ >= 1
  â†’ Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚
  â†’ ĞĞ¾Ğ²Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Gemini
  â†’ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€ĞµĞ²ÑŒÑ
```

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°

```typescript
async function checkAndDeductCredits(
  userId: string,
  amount: number,
  reason: string
): Promise<boolean> {
  const user = await supabase.from("users").select("credits").eq("id", userId).single();
  if (!user.data || user.data.credits < amount) return false;

  // ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· RPC Ğ¸Ğ»Ğ¸ update Ñ where credits >= amount
  const { error } = await supabase.rpc("deduct_credits", {
    p_user_id: userId,
    p_amount: amount,
    p_reason: reason,
  });
  return !error;
}
```

### Ğ•ÑĞ»Ğ¸ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚

ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ»Ğ°Ğ¹Ğ½-ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«ğŸ’° ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÂ» â†’ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ğ±Ğ°Ğ»Ğ°Ğ½Ñ/Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ².

### ĞšĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

Ğ•ÑĞ»Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ/Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ»Ğ°ÑÑŒ:
- ĞŸÑ€ĞµĞ²ÑŒÑ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ â†’ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚
- ĞŸĞ°Ğº Ğ½Ğµ ÑĞ¾Ğ±Ñ€Ğ°Ğ»ÑÑ â†’ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²

---

## 6. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ (Ğ²Ğ¾Ñ€ĞºĞµÑ€) â€” ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ”Ğ¥ĞĞ”

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°: labels-first â†’ Ğ¿Ñ€ĞµĞ²ÑŒÑ (1ğŸ’) â†’ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ â†’ Ğ¿Ğ°Ğº (N-1ğŸ’)

**ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´:** Ğ”Ğ²ÑƒÑ…Ñ„Ğ°Ğ·Ğ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¼ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Ğ¤ĞĞ—Ğ A: ĞŸĞ Ğ•Ğ’Ğ¬Ğ® (1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚) â€” Ğ²Ğ¾Ñ€ĞºĞµÑ€: runPackPreviewJob
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 0: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° (Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾)               â”‚
â”‚                                                     â”‚
â”‚   labels = ["ĞœĞ¾Ñ ğŸ’•", "Ğ›ÑĞ±Ğ»Ñ ğŸ˜˜", "Ğ¡Ğ¿Ğ¸Ğ¼? ğŸ˜´", ...]  â”‚
â”‚   scenes = ["hugging tenderly", "blowing a kiss",..]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 1: Gemini (1 Ğ²Ñ‹Ğ·Ğ¾Ğ², ~15 ÑĞµĞº)                   â”‚
â”‚                                                     â”‚
â”‚   Gemini(ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶ + Ñ„Ğ¾Ñ‚Ğ¾ + Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ ÑĞ¾ ÑÑ†ĞµĞ½Ğ°Ğ¼Ğ¸)         â”‚
â”‚   â†’ IMAGE: Ğ»Ğ¸ÑÑ‚ Ñ ÑĞµÑ‚ĞºĞ¾Ğ¹ (2Ã—2 Ğ¸Ğ»Ğ¸ 4Ã—4)             â”‚
â”‚   responseModalities: ["IMAGE"]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 2: ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ                â”‚
â”‚                                                     â”‚
â”‚   â†’ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ»Ğ¸ÑÑ‚ ĞºĞ°Ğº Ñ„Ğ¾Ñ‚Ğ¾ Ğ² Ñ‡Ğ°Ñ‚                   â”‚
â”‚   â†’ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ file_id Ğ² session.pack_sheet_file_id  â”‚
â”‚   â†’ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸:                                â”‚
â”‚     [âœ… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº â€” N-1 ğŸ’]                       â”‚
â”‚     [ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” 1 ğŸ’]                     â”‚
â”‚     [âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°]                                      â”‚
â”‚   â†’ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â†’ wait_pack_approval                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Ğ¤ĞĞ—Ğ B: ĞŸĞĞš (N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²) â€” Ğ²Ğ¾Ñ€ĞºĞµÑ€: runPackAssembleJob
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Ğ®Ğ·ĞµÑ€ Ğ½Ğ°Ğ¶Ğ°Ğ» âœ… â†’ ÑĞ¿Ğ¸ÑĞ°Ğ»Ğ¸ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² â†’ ÑĞ¾Ğ·Ğ´Ğ°Ğ»Ğ¸ Ğ´Ğ¶Ğ¾Ğ±Ñƒ
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 3: Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ file_id                     â”‚
â”‚                                                     â”‚
â”‚   â†’ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ sheet Ğ¸Ğ· Telegram Ğ¿Ğ¾ pack_sheet_file_id â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 4: ĞĞ°Ñ€ĞµĞ·ĞºĞ° (sharp, Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾)                   â”‚
â”‚                                                     â”‚
â”‚   sharp.extract() Ğ¿Ğ¾ ÑĞµÑ‚ĞºĞµ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 5: rembg Ã— N (Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾, ~5-10 ÑĞµĞº)          â”‚
â”‚                                                     â”‚
â”‚   Promise.all(cells.map(callPixian))                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 6: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° (trim + resize + Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°)â”‚
â”‚                                                     â”‚
â”‚   labels[i] Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° â†’ sharp + SVG overlay        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 7: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Telegram sticker set (~3-5 ÑĞµĞº)      â”‚
â”‚                                                     â”‚
â”‚   createNewStickerSet + addStickerToSet             â”‚
â”‚   â†’ ÑÑÑ‹Ğ»ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ´Ğ²ÑƒÑ…Ñ„Ğ°Ğ·Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´

| | Ğ‘ĞµĞ· Ğ¿Ñ€ĞµĞ²ÑŒÑ (ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹) | Ğ¡ Ğ¿Ñ€ĞµĞ²ÑŒÑ (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹) |
|---|---|---|
| Ğ Ğ¸ÑĞº Ğ´Ğ»Ñ ÑĞ·ĞµÑ€Ğ° | Ğ—Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ» NğŸ’ â†’ Ğ½Ğµ Ğ¿Ğ¾Ğ½Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ÑÑŒ | **Ğ—Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ» 1ğŸ’** â†’ Ğ½Ğµ Ğ¿Ğ¾Ğ½Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ÑÑŒ |
| ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ | Ğ‘Ğ°Ñ€ÑŒĞµÑ€ "Ğ·Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ ÑÑ€Ğ°Ğ·Ñƒ 16ğŸ’" | **ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ğ±Ğ°Ñ€ÑŒĞµÑ€** "Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ·Ğ° 1ğŸ’" |
| ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ | ĞĞµÑ‚ (Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ñ†ĞµĞ½Ğ°) | **1ğŸ’** Ğ·Ğ° ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºÑƒ |
| Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ñ‘Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ | ĞšĞ¾Ñ‚ Ğ² Ğ¼ĞµÑˆĞºĞµ | **Ğ®Ğ·ĞµÑ€ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚** |
| Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ API | â€” | rembg/ÑĞ±Ğ¾Ñ€ĞºĞ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ |

### ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ labels-first, Ğ° Ğ½Ğµ AI-generated

| | AI-generated labels | Labels-first (ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ) |
|---|---|---|
| ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ | Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğµ | **Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ** |
| Diversity ÑÑ†ĞµĞ½ | ĞœĞ¾Ğ¶ĞµÑ‚ Ğ½Ğ°Ñ€Ğ¸ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ 4 Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ Ğ¿Ğ¾Ğ·Ñ‹ | **Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ** |
| ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞµĞ¹ | Ğ›Ğ¾Ñ‚ĞµÑ€ĞµÑ | **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğµ** Ñ„Ñ€Ğ°Ğ·Ñ‹ |
| ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° ĞºĞ¾Ğ´Ğ° | JSON-Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³, fallback | **ĞĞµÑ‚ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°** â€” Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· Ğ‘Ğ” |

### Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€

| | Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ (N Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²) | Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ (labels-first + Ğ¿Ñ€ĞµĞ²ÑŒÑ) |
|---|---|---|
| Ğ’Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² Gemini | 4-16 | **1** |
| ĞŸÑ€ĞµĞ²ÑŒÑ Ğ´Ğ»Ñ ÑĞ·ĞµÑ€Ğ° | ĞĞµÑ‚ | **Ğ”Ğ°** |
| ĞĞ¿Ğ»Ğ°Ñ‚Ğ° | Ğ’ÑÑ‘ ÑÑ€Ğ°Ğ·Ñƒ | **1ğŸ’ + N-1ğŸ’** (Ğ´Ğ²ÑƒÑ…ÑÑ‚Ğ°Ğ¿Ğ½Ğ°Ñ) |
| ĞšĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ ÑÑ‚Ğ¸Ğ»Ñ | ĞÑƒĞ¶ĞµĞ½ ÑĞºĞ¾Ñ€ÑŒ | **Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ** (1 ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°) |
| ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ñ‚ĞµĞºÑÑ‚Ğ° | Gemini Ñ€Ğ¸ÑÑƒĞµÑ‚ (ĞºÑ€Ğ¸Ğ²Ğ¾) | **ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ñ‹Ğ¹** (Ñ‡Ñ‘Ñ‚ĞºĞ¸Ğ¹) |
| Ğ¡Ñ†ĞµĞ½Ñ‹ | Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ | **Ğ—Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğµ** |

### Ğ Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

| ĞœĞ¾Ğ´ĞµĞ»ÑŒ | Ğ’Ñ‹Ñ…Ğ¾Ğ´ | Ğ¡ĞµÑ‚ĞºĞ° | Ğ¡Ñ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² | ĞĞ° ÑÑ‚Ğ¸ĞºĞµÑ€ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
|--------|-------|-------|----------|-----------|--------|
| **Gemini 2.5 Flash** | 1024Ã—1024 | 2Ã—2 | **4** | 512Ã—512 | **Ğ¢ĞµÑÑ‚** |
| Gemini 3 Pro | 4096Ã—4096 | 3Ã—3 | 9 | 1365Ã—1365 | Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ |
| **Gemini 3 Pro** | 4096Ã—4096 | **4Ã—4** | **16** | 1024Ã—1024 | **Ğ¤Ğ¸Ğ½Ğ°Ğ»** |
| Gemini 3 Pro | 4096Ã—4096 | 5Ã—5 | 25 | 819Ã—819 | ĞœĞ°ĞºÑ |

**Ğ¢ĞµÑÑ‚:** Gemini 2.5 Flash (`gemini-2.5-flash-image`), 2Ã—2, 4 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°.
**Ğ¤Ğ¸Ğ½Ğ°Ğ»:** Gemini 3 Pro (`gemini-3-pro-image-preview`), 4Ã—4, **16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²**.

16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² â€” Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€:
- Ğ§Ğ¸ÑÑ‚Ğ°Ñ ÑĞµÑ‚ĞºĞ° 4Ã—4 (Ğ±ĞµĞ· Ğ¿ÑƒÑÑ‚Ñ‹Ñ… ÑÑ‡ĞµĞµĞº)
- 1024Ã—1024 Ğ½Ğ° ÑÑ‚Ğ¸ĞºĞµÑ€ â†’ resize Ğ´Ğ¾ 512 = Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾
- Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ñ‡ĞµĞ¼ 15 Ğ¸Ğ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ğ½Ğ°
- Telegram Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ 50 â†’ 16 Ğ¾Ğº

### 2 Ğ´Ğ¶Ğ¾Ğ±Ñ‹ Ğ½Ğ° 1 Ğ¿Ğ°Ğº

| Ğ”Ğ¶Ğ¾Ğ±Ğ° | ĞšĞ¾Ğ³Ğ´Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ | Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ |
|-------|----------------|-----------|
| `pack_preview` | ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ 1ğŸ’ Ğ·Ğ° Ğ¿Ñ€ĞµĞ²ÑŒÑ | Gemini â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¸ÑÑ‚ ÑĞ·ĞµÑ€Ñƒ |
| `pack_assemble` | ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ + Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ N-1ğŸ’ | ĞĞ°Ñ€ĞµĞ·ĞºĞ° â†’ rembg â†’ Ñ‚ĞµĞºÑÑ‚ â†’ ÑĞ±Ğ¾Ñ€ĞºĞ° |

### Ğ”Ğ¶Ğ¾Ğ±Ğ° 1: runPackPreviewJob (Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµĞ²ÑŒÑ)

```typescript
async function runPackPreviewJob(job: any) {
  const batch = ...; // Ğ¸Ğ· pack_batches
  const template = ...; // Ğ¸Ğ· pack_templates
  const scenes: string[] = template.scene_descriptions;

  const userPhotoBuffer = await downloadUserPhoto(session);
  const collageBuffer = await loadCollage(template);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Gemini â€” Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¸ÑÑ‚Ğ° Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ÑÑ†ĞµĞ½Ğ°Ğ¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  await updateProgress("generating_preview");

  const sheetBuffer = await callGeminiPackSheet({
    prompt: buildSheetPrompt(template, scenes),
    images: [collageBuffer, userPhotoBuffer].filter(Boolean),
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const sentMsg = await bot.telegram.sendPhoto(
    session.telegram_id,
    { source: sheetBuffer },
    {
      caption: getText("pack.preview_caption", lang, {
        count: template.sticker_count,
        price: template.sticker_count - 1,
      }),
      reply_markup: {
        inline_keyboard: [
          [{ text: getText("btn.approve_pack", lang, { price: template.sticker_count - 1 }),
             callback_data: `pack_approve:${batch.id}` }],
          [{ text: getText("btn.regenerate_pack", lang),
             callback_data: `pack_regenerate:${batch.id}` }],
          [{ text: getText("btn.cancel_pack", lang),
             callback_data: `pack_cancel:${batch.id}` }],
        ],
      },
    }
  );

  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ file_id Ğ»Ğ¸ÑÑ‚Ğ° Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾Ñ€ĞºĞµ
  const sheetFileId = sentMsg.photo?.[sentMsg.photo.length - 1]?.file_id;
  await updateSession(session.id, {
    state: "wait_pack_approval",
    pack_sheet_file_id: sheetFileId,
  });

  // Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
  await deleteProgressMessage(session);
}
```

### Ğ”Ğ¶Ğ¾Ğ±Ğ° 2: runPackAssembleJob (ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¿Ğ°ĞºĞ°)

```typescript
async function runPackAssembleJob(job: any) {
  const batch = ...; // Ğ¸Ğ· pack_batches
  const template = ...; // Ğ¸Ğ· pack_templates
  const labels: string[] = template.labels; // ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¨ĞĞ“ 1: Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ file_id
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const sheetBuffer = await downloadFileByFileId(session.pack_sheet_file_id);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¨ĞĞ“ 2: ĞĞ°Ñ€ĞµĞ·ĞºĞ° Ğ½Ğ° ÑÑ‡ĞµĞ¹ĞºĞ¸
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const cells = await cutSheetIntoCells(sheetBuffer, template.sticker_count);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¨ĞĞ“ 3: rembg (Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  await updateProgress("removing_bg");

  const noBgCells = await Promise.all(
    cells.map(cell => callRembgWithRetry(cell))
  );

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¨ĞĞ“ 4: Trim + resize + Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  await updateProgress("finishing");

  const stickers: Buffer[] = [];
  for (let i = 0; i < noBgCells.length; i++) {
    const trimmed = await trimAndResize(noBgCells[i]);
    const withText = await overlayText(trimmed, labels[i]);
    stickers.push(withText);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ğ¨ĞĞ“ 5: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Telegram sticker set
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  await updateProgress("assembling");
  await assemblePack(batch, session, user, template, stickers);
}
```

### callGeminiPackSheet â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ IMAGE

```typescript
async function callGeminiPackSheet(params: {
  prompt: string;
  images: Buffer[];
}): Promise<Buffer> {
  const model = await getAppConfig("gemini_model_pack", "gemini-2.5-flash-image");

  // MVP: Ğ±ĞµĞ· retry. ĞÑˆĞ¸Ğ±ĞºĞ° â†’ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºÑ€ĞµĞ´Ğ¸Ñ‚, Ğ°Ğ»ĞµÑ€Ñ‚.
  const geminiRes = await callGeminiImageGeneration(model, params.prompt, params.images);

  const parts = geminiRes.data.candidates[0].content.parts;
  const imagePart = parts.find((p: any) => p.inlineData);
  if (!imagePart) throw new Error("Gemini returned no image");

  return Buffer.from(imagePart.inlineData.data, "base64");
}
```

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº (index.ts)

```typescript
// âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº
bot.action(/pack_approve:(.+)/, async (ctx) => {
  const batchId = ctx.match[1];
  const batch = ...; // Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ‘Ğ”
  const template = ...; // Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
  const price = template.sticker_count - 1; // N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²

  // Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ñ‹
  const ok = await checkAndDeductCredits(user.id, price, `pack_assemble:${batchId}`);
  if (!ok) {
    return ctx.answerCbQuery(getText("pack.not_enough_credits", lang));
    // + Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
  }

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¶Ğ¾Ğ±Ñƒ ÑĞ±Ğ¾Ñ€ĞºĞ¸
  await createJob({ type: "pack_assemble", pack_batch_id: batchId, ... });
  await updateSession(session.id, { state: "processing_pack" });

  // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
  const progressMsg = await ctx.reply(getText("pack.progress_assembling", lang));
  await updateSession(session.id, {
    progress_message_id: progressMsg.message_id,
    progress_chat_id: ctx.chat.id,
  });

  ctx.answerCbQuery();
});

// ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
bot.action(/pack_regenerate:(.+)/, async (ctx) => {
  const batchId = ctx.match[1];

  // Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚
  const ok = await checkAndDeductCredits(user.id, 1, `pack_regenerate:${batchId}`);
  if (!ok) {
    return ctx.answerCbQuery(getText("pack.not_enough_credits", lang));
  }

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ´Ğ¶Ğ¾Ğ±Ñƒ Ğ¿Ñ€ĞµĞ²ÑŒÑ
  await createJob({ type: "pack_preview", pack_batch_id: batchId, ... });
  await updateSession(session.id, { state: "generating_pack_preview" });

  // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
  const progressMsg = await ctx.reply(getText("pack.progress_generating", lang));
  await updateSession(session.id, {
    progress_message_id: progressMsg.message_id,
    progress_chat_id: ctx.chat.id,
  });

  ctx.answerCbQuery();
});

// âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°
bot.action(/pack_cancel:(.+)/, async (ctx) => {
  await updateSession(session.id, { state: "idle" });
  await updateBatch(batchId, { status: "cancelled" });
  ctx.answerCbQuery(getText("pack.cancelled", lang));
  // ĞšÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ¿Ñ€ĞµĞ²ÑŒÑ ĞĞ• Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ (Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ»Ğ°ÑÑŒ)
});
```

### ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Gemini (Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¸ÑÑ‚Ğ° Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ÑÑ†ĞµĞ½Ğ°Ğ¼)

```
[REFERENCE STYLE]
The first image is a reference sticker pack. Match the exact visual style:
rendering technique, white outline, proportions, color palette, overall vibe.

[STYLE DESCRIPTION]
{template.style_prompt_base}

[TASK]
Create a {grid} grid sticker sheet with {count} stickers of the person(s) from the photo.
Each cell = ONE sticker with a SPECIFIC scene:

{sceneList}

[FORMAT RULES]
- Grid: exactly {rows} rows Ã— {cols} columns, equal cell size
- NO text drawn on the image â€” text will be added programmatically
- Each sticker: character(s) with white outline/border
- Each cell: flat single-color background, contrasting with character
- Characters clearly recognizable from the reference photo
- Each sticker self-contained within its cell
- Clear separation between cells
- No watermarks, no text, no labels on the image
- High quality, clean lines
```

#### Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ `{sceneList}` Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°

```typescript
function buildSceneList(scenes: string[], cols: number): string {
  const positions = ["Top-left", "Top-right", "Bottom-left", "Bottom-right"];
  // Ğ”Ğ»Ñ 4Ã—4 Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼: "Row 1, Col 1:", "Row 1, Col 2:", ...
  if (scenes.length > 4) {
    return scenes.map((scene, i) => {
      const row = Math.floor(i / cols) + 1;
      const col = (i % cols) + 1;
      return `Row ${row}, Col ${col}: ${scene}`;
    }).join("\n");
  }
  return scenes.map((scene, i) => `${positions[i]}: ${scene}`).join("\n");
}
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ° (2Ã—2):**
```
Top-left: romantic, hugging tenderly
Top-right: blowing a kiss, hearts flying around
Bottom-left: sleeping together, cozy and peaceful
Bottom-right: eating pizza together, happy and playful
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ° (4Ã—4, 16 ÑÑ†ĞµĞ½):**
```
Row 1, Col 1: romantic, hugging tenderly
Row 1, Col 2: blowing a kiss, hearts flying around
Row 1, Col 3: waving hello, cheerful greeting
Row 1, Col 4: sleeping together, cozy
...
Row 4, Col 4: forever together, holding hands with infinity symbol
```

**Ğ”Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ° (Flash):** `{grid}` = "2Ã—2", `{count}` = 4, `{rows}` = 2, `{cols}` = 2
**Ğ”Ğ»Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ° (Pro):** `{grid}` = "4Ã—4", `{count}` = 16, `{rows}` = 4, `{cols}` = 4

### ĞĞ°Ñ€ĞµĞ·ĞºĞ° Ğ»Ğ¸ÑÑ‚Ğ° (cutSheetIntoCells) â€” Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

#### Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ‚ Gemini

**Ğ¢ĞµÑÑ‚ (Flash):** PNG ~1024Ã—1024 Ñ ÑĞµÑ‚ĞºĞ¾Ğ¹ 2Ã—2 (4 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ° Ğ¿Ğ¾ 512Ã—512):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 0     â”‚  Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 1     â”‚
â”‚  labels[0]    â”‚  labels[1]    â”‚
â”‚  (512Ã—512)    â”‚  (512Ã—512)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 2     â”‚  Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 3     â”‚
â”‚  labels[2]    â”‚  labels[3]    â”‚
â”‚  (512Ã—512)    â”‚  (512Ã—512)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        1024 Ã— 1024
```

**Ğ¤Ğ¸Ğ½Ğ°Ğ» (Pro):** PNG ~4096Ã—4096 Ñ ÑĞµÑ‚ĞºĞ¾Ğ¹ 4Ã—4 (16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² Ğ¿Ğ¾ 1024Ã—1024):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 0 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 1 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 2 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 3 â”‚
â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 4 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 5 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 6 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 7 â”‚
â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 8 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ 9 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€10 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€11 â”‚
â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€12 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€13 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€14 â”‚ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€15 â”‚
â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚ (1024Â²)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            4096 Ã— 4096
```

labels = Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°: template.labels[0..N-1]
scenes = Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°: template.scene_descriptions[0..N-1]

#### ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ¸ (ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ»ÑĞ±Ğ¾Ğ¹ ÑĞµÑ‚ĞºĞ¸)

1. Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ: `width`, `height`
2. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ÑĞµÑ‚ĞºÑƒ: `cols = ceil(sqrt(count))`, `rows = ceil(count / cols)`
3. Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑÑ‡ĞµĞ¹ĞºĞ¸: `cellW = floor(width / cols)`, `cellH = floor(height / rows)`
4. Ğ’Ñ‹Ñ€ĞµĞ·Ğ°ĞµĞ¼ ÑÑ‡ĞµĞ¹ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· `sharp.extract()`:

**Ğ¢ĞµÑÑ‚ (2Ã—2):**
```
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 0: extract({ left: 0,   top: 0,   width: 512, height: 512 })
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 1: extract({ left: 512, top: 0,   width: 512, height: 512 })
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 2: extract({ left: 0,   top: 512, width: 512, height: 512 })
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 3: extract({ left: 512, top: 512, width: 512, height: 512 })
```

**Ğ¤Ğ¸Ğ½Ğ°Ğ» (4Ã—4):**
```
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 0:  extract({ left: 0,    top: 0,    width: 1024, height: 1024 })
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 1:  extract({ left: 1024, top: 0,    width: 1024, height: 1024 })
...
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 15: extract({ left: 3072, top: 3072, width: 1024, height: 1024 })
```

#### ĞšĞ¾Ğ´

```typescript
async function cutSheetIntoCells(sheetBuffer: Buffer, count: number): Promise<Buffer[]> {
  const meta = await sharp(sheetBuffer).metadata();
  const w = meta.width!;
  const h = meta.height!;

  const cols = Math.ceil(Math.sqrt(count)); // 2 Ğ´Ğ»Ñ 4
  const rows = Math.ceil(count / cols);      // 2 Ğ´Ğ»Ñ 4
  const cellW = Math.floor(w / cols);        // 512
  const cellH = Math.floor(h / rows);        // 512

  const cells: Buffer[] = [];
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      if (cells.length >= count) break;
      const cell = await sharp(sheetBuffer)
        .extract({
          left: c * cellW,
          top: r * cellH,
          width: cellW,
          height: cellH,
        })
        .png()
        .toBuffer();
      cells.push(cell);
    }
  }

  console.log(`[Pack] Cut sheet ${w}Ã—${h} into ${cells.length} cells (${cols}Ã—${rows}, each ${cellW}Ã—${cellH})`);
  return cells;
}
```

#### ĞŸĞ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ Ğ¾Ñ‚ ÑÑ‡ĞµĞ¹ĞºĞ¸ Ğ´Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°

ĞšĞ°Ğ¶Ğ´Ğ°Ñ ÑÑ‡ĞµĞ¹ĞºĞ° (512Ã—512 PNG Ñ Ñ†Ğ²ĞµÑ‚Ğ½Ñ‹Ğ¼ Ñ„Ğ¾Ğ½Ğ¾Ğ¼) Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚:

```
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 512Ã—512 (Ñ†Ğ²ĞµÑ‚Ğ½Ğ¾Ğ¹ Ñ„Ğ¾Ğ½)
    â”‚
    â–¼ callRembg()
Ğ¯Ñ‡ĞµĞ¹ĞºĞ° 512Ã—512 (Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ğ½)
    â”‚
    â–¼ sharp.trim({ threshold: 2 })
ĞĞ±Ñ€ĞµĞ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ (Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°)
    â”‚
    â–¼ sharp.resize(512, 512, { fit: "contain", background: { r:0, g:0, b:0, alpha:0 } })
ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ğ²Ğ¿Ğ¸ÑĞ°Ğ½ Ğ² 512Ã—512 (Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ğ½)
    â”‚
    â–¼ overlayText(labels[i]) â€” SVG composite ĞŸĞĞ’Ğ•Ğ Ğ¥ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°
Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ 512Ã—512
    â”‚
    â–¼ .webp({ quality: 95 })
Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ¸ĞºĞµÑ€ 512Ã—512 WebP
    â”‚
    â–¼ sendSticker() â†’ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ file_id
    â–¼ createNewStickerSet / addStickerToSet
```

**ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ 512Ã—512:** Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… ÑÑ‚Ğ¸ĞºĞµÑ€Ğ° (ĞºĞ°Ğº Ğ² Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ°Ñ…).
ĞÑ‚ÑÑ‚ÑƒĞ¿Ñ‹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° Ğ¾Ñ‚ ĞºÑ€Ğ°Ñ‘Ğ² â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ° Gemini (ÑƒĞ¶Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‚Ğ°Ğº Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸).

#### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ½ĞµÑ€Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ‚ĞºĞ¸

Gemini Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğµ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ²Ñ‹Ñ€Ğ¾Ğ²Ğ½ÑÑ‚ÑŒ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ğ¿Ğ¾ ÑĞµÑ‚ĞºĞµ. Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:

1. **Ğ£ÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚** â€” ÑĞ²Ğ½Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ "exact 2Ã—2 grid, equal cell size, clear dividing lines"
2. **Trim Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ¸** â€” `sharp.trim()` ÑƒĞ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ Ğ¿Ğ¸ĞºÑĞµĞ»Ğ¸ Ñ„Ğ¾Ğ½Ğ° Ğ²Ğ¾ĞºÑ€ÑƒĞ³ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°
3. **rembg** â€” ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ñ„Ğ¾Ğ½ Ñ†ĞµĞ»Ğ¸ĞºĞ¾Ğ¼, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ÑÑ‡ĞµĞµĞº Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ Ğ¿Ğ¾ Ñ„Ğ¾Ğ½Ñƒ

ĞĞ° Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞµ: trim + rembg ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ¸Ñ€ÑƒÑÑ‚ Ğ½ĞµÑ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞµÑ‚ĞºĞ¸.

### Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹ (overlayText)

Ğ¢ĞµĞºÑÑ‚ Ğ½Ğ°ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ **Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ğ¾ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°** Ñ‡ĞµÑ€ĞµĞ· `sharp` + SVG.
Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ ÑƒĞ¶Ğµ 512Ã—512 â€” Ñ‚ĞµĞºÑÑ‚ Ñ€Ğ¸ÑÑƒĞµÑ‚ÑÑ Ğ² Ğ½Ğ¸Ğ¶Ğ½ĞµĞ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°.

```typescript
async function overlayText(stickerBuffer: Buffer, label: string): Promise<Buffer> {
  // Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ ÑƒĞ¶Ğµ 512Ã—512 Ğ¿Ğ¾ÑĞ»Ğµ resize
  const w = 512;
  const h = 512;
  const fontSize = 40; // ~8% Ğ¾Ñ‚ 512

  const svgText = `
    <svg width="${w}" height="${h}">
      <defs>
        <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
          <feDropShadow dx="0" dy="1" stdDeviation="2" flood-color="black" flood-opacity="0.5"/>
        </filter>
      </defs>
      <text
        x="${w / 2}" y="${h - 20}"
        text-anchor="middle"
        font-family="Arial, Helvetica, sans-serif"
        font-weight="bold"
        font-size="${fontSize}px"
        fill="white"
        stroke="black"
        stroke-width="2"
        filter="url(#shadow)"
      >${escapeXml(label)}</text>
    </svg>
  `;

  return sharp(stickerBuffer)
    .composite([{ input: Buffer.from(svgText), top: 0, left: 0 }])
    .webp({ quality: 95 })
    .toBuffer();
}
```

### Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ğ½Ğ°: rembg-only

Ğ”Ğ»Ñ Ğ¿Ğ°ĞºĞ¾Ğ² **Ğ²ÑĞµĞ³Ğ´Ğ°** rembg (ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼ pipeline Ğ¸ Ğ´ĞµÑˆĞµĞ²Ğ»Ğµ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ·Ğ°Ñ‚Ñ€Ğ°Ñ‚Ğ°Ğ¼).

```typescript
async function callRembgForPack(imageBuffer: Buffer): Promise<Buffer> {
  const result = await callRembg(imageBuffer, process.env.REMBG_URL, Math.round(imageBuffer.length / 1024));
  if (!result) throw new Error("rembg failed for pack sticker");
  return result;
}
```

### assemblePack() â€” ÑĞ±Ğ¾Ñ€ĞºĞ° ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ°

```
1. ĞÑ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹
2. Ğ•ÑĞ»Ğ¸ 0 â†’ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² + Ğ°Ğ»ĞµÑ€Ñ‚ + ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ·ĞµÑ€Ñƒ
3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Telegram sticker set:
   name = p2s_pack_{telegramId}_{timestamp}_by_{botUsername}
   title = template.name_ru/en + @username

4. createNewStickerSet Ñ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ¼
5. addStickerToSet Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)

6. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ pack_batches: status, sticker_set_name, counts
7. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
8. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑÑÑ‹Ğ»ĞºÑƒ + ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
```

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº (MVP â€” Ğ±ĞµĞ· retry)

ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿: **Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ â†’ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ñ‹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ÑÑ‚ÑÑ, Ğ°Ğ»ĞµÑ€Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ.**
Retry Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ Ğ¿Ğ¾Ğ·Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑÑ.

**Ğ¤Ğ°Ğ·Ğ° A (Ğ¿Ñ€ĞµĞ²ÑŒÑ):**

| Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|----------|----------|
| Gemini Ğ¾ÑˆĞ¸Ğ±ĞºĞ° (429 / 5xx / blocked / Ğ½ĞµÑ‚ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸) | Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚, Ğ°Ğ»ĞµÑ€Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ, ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ·ĞµÑ€Ñƒ |
| Gemini Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ½ĞµĞ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ | Ğ®Ğ·ĞµÑ€ ÑĞ°Ğ¼ Ñ€ĞµÑˆĞ°ĞµÑ‚: Ğ¿ĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ (1ğŸ’) Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ |

**Ğ¤Ğ°Ğ·Ğ° B (ÑĞ±Ğ¾Ñ€ĞºĞ°):**

| Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|----------|----------|
| rembg ÑƒĞ¿Ğ°Ğ» Ğ½Ğ° 1 Ğ¸Ğ· N ÑÑ‡ĞµĞµĞº | ĞŸĞ°Ğº Ğ¸Ğ· N-1 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ², `status='partial'`, Ğ°Ğ»ĞµÑ€Ñ‚ |
| Ğ’ÑĞµ rembg ÑƒĞ¿Ğ°Ğ»Ğ¸ | `status='failed'`, Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ², Ğ°Ğ»ĞµÑ€Ñ‚ |
| createNewStickerSet ÑƒĞ¿Ğ°Ğ» | `status='failed'`, Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ², Ğ°Ğ»ĞµÑ€Ñ‚ |
| Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹ ÑƒĞ¿Ğ°Ğ» | Ğ¡Ñ‚Ğ¸ĞºĞµÑ€ Ğ±ĞµĞ· Ñ‚ĞµĞºÑÑ‚Ğ° (fallback) |

### Ğ¢Ğ°Ğ¹Ğ¼Ğ¸Ğ½Ğ³Ğ¸

**Ğ¤Ğ°Ğ·Ğ° A (Ğ¿Ñ€ĞµĞ²ÑŒÑ):**

| Ğ¨Ğ°Ğ³ | Ğ¢ĞµÑÑ‚ (4, Flash) | Ğ¤Ğ¸Ğ½Ğ°Ğ» (16, Pro) |
|-----|-----------------|-----------------|
| Gemini (1 Ğ²Ñ‹Ğ·Ğ¾Ğ²) | ~15 ÑĞµĞº | ~20-30 ÑĞµĞº |
| **Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ Ğ¿Ñ€ĞµĞ²ÑŒÑ** | **~15 ÑĞµĞº** | **~20-30 ÑĞµĞº** |

**Ğ¤Ğ°Ğ·Ğ° B (ÑĞ±Ğ¾Ñ€ĞºĞ°, Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ):**

| Ğ¨Ğ°Ğ³ | Ğ¢ĞµÑÑ‚ (4, Flash) | Ğ¤Ğ¸Ğ½Ğ°Ğ» (16, Pro) |
|-----|-----------------|-----------------|
| Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ file_id | ~1 ÑĞµĞº | ~2 ÑĞµĞº |
| ĞĞ°Ñ€ĞµĞ·ĞºĞ° (sharp) | <1 ÑĞµĞº | <1 ÑĞµĞº |
| rembg Ã— N (Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾) | ~5-10 ÑĞµĞº | ~10-15 ÑĞµĞº |
| Trim + resize + Ñ‚ĞµĞºÑÑ‚ Ã— N | ~2 ÑĞµĞº | ~5 ÑĞµĞº |
| Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Telegram sticker set | ~3-5 ÑĞµĞº | ~10 ÑĞµĞº |
| **Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ** | **~12-18 ÑĞµĞº** | **~28-33 ÑĞµĞº** |

---

## 7. Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ Ğ¿Ğ°ĞºĞ°: Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ (labels) Ğ¸ ÑÑ†ĞµĞ½Ñ‹ (scenes)

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿: Labels-first

ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑÑ†ĞµĞ½ **Ğ·Ğ°Ğ´Ğ°ÑÑ‚ÑÑ Ğ² ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğµ** â€” ÑÑ‚Ğ¾ ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹,
Ğ¿Ğ¾ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸ Ğ² Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞµ.

Gemini Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ **ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ ÑÑ†ĞµĞ½Ñ‹** Ğ´Ğ»Ñ Ñ€Ğ¸ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
Ğ¢ĞµĞºÑÑ‚ Ğ±ĞµÑ€Ñ‘Ñ‚ÑÑ **Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°** Ğ¸ Ğ½Ğ°ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ğ¾.

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°

ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ´Ğ²Ğ° Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ°:

- `labels` â€” Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² (Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
- `scene_descriptions` â€” Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑÑ†ĞµĞ½ Ğ´Ğ»Ñ Gemini (Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ½Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)

**Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚:** `labels[i]` â€” Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ `scene_descriptions[i]`.

### Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ `couple_v1` (Ñ‚ĞµÑÑ‚ â€” 4 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°)

```json
{
  "labels": ["ĞœĞ¾Ñ ğŸ’•", "Ğ›ÑĞ±Ğ»Ñ ğŸ˜˜", "Ğ¡Ğ¿Ğ¸Ğ¼? ğŸ˜´", "Ğ’ĞºÑƒÑĞ½Ğ¾? ğŸ•"],
  "scene_descriptions": [
    "romantic, hugging tenderly",
    "blowing a kiss, hearts flying around",
    "sleeping together, cozy and peaceful",
    "eating pizza together, happy and playful"
  ]
}
```

### Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ `couple_v1` (Ñ„Ğ¸Ğ½Ğ°Ğ» â€” 16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²)

```json
{
  "labels": [
    "ĞœĞ¾Ñ ğŸ’•", "Ğ›ÑĞ±Ğ»Ñ ğŸ˜˜", "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ ğŸ‘‹", "Ğ¡Ğ¿Ğ¸Ğ¼? ğŸ˜´",
    "Ğ—Ğ»ÑĞºĞ° ğŸ˜¤", "Ğ’ĞºÑƒÑĞ½Ğ¾? ğŸ•", "ĞœĞ¸Ğ¼Ğ¸Ğ¼Ğ¸ ğŸ¥°", "Ğ£ÑÑ‚Ğ°Ğ» ğŸ˜©",
    "Ğ§Ğ¼Ğ¾Ğº ğŸ’‹", "ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº ğŸ", "ĞĞ¿ÑÑ‚ÑŒ Ñ‚Ñ‹ ğŸ™„", "Ğ¢Ğ°Ğ½Ñ†Ñ‹ ğŸ’ƒ",
    "Ğ¡ĞºÑƒÑ‡Ğ°Ñ ğŸ˜¢", "Ğ’Ğ¼ĞµÑÑ‚Ğµ ğŸ¤", "ĞšÑ€Ğ°ÑĞ¾Ñ‚ĞºĞ° ğŸ’…", "ĞĞ°Ğ²ÑĞµĞ³Ğ´Ğ° â™¾ï¸"
  ],
  "scene_descriptions": [
    "romantic, hugging tenderly",
    "blowing a kiss, hearts flying around",
    "waving hello, cheerful greeting",
    "sleeping together, cozy and peaceful",
    "angry, arms crossed, pouting face",
    "eating pizza together, happy and playful",
    "cuddling, extremely cute and sweet",
    "exhausted, lying down, tired expression",
    "giving a big kiss on the cheek",
    "holding a gift box, excited surprise",
    "eye rolling, playful annoyance",
    "dancing together, fun party vibes",
    "sad, missing each other, one looking at phone",
    "holding hands, walking together",
    "one doing makeup/nails, fabulous pose",
    "holding hands with infinity symbol, eternal love"
  ]
}
```

### Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

Ğ”Ğ»Ñ EN ÑĞ·ĞµÑ€Ğ¾Ğ² â€” Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ `labels_en`:

```json
{
  "labels_en": [
    "Mine ğŸ’•", "Love ğŸ˜˜", "Hey ğŸ‘‹", "Sleep? ğŸ˜´",
    "Angry ğŸ˜¤", "Yummy ğŸ•", "Aww ğŸ¥°", "Tired ğŸ˜©",
    "Smooch ğŸ’‹", "Gift ğŸ", "Not again ğŸ™„", "Dance ğŸ’ƒ",
    "Miss you ğŸ˜¢", "Together ğŸ¤", "Fabulous ğŸ’…", "Forever â™¾ï¸"
  ]
}
```

`scene_descriptions` â€” Ğ²ÑĞµĞ³Ğ´Ğ° Ğ½Ğ° EN (Ğ´Ğ»Ñ Gemini).

---

## 8. ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

### ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¿Ğ¾ Ñ„Ğ°Ğ·Ğ°Ğ¼

**Ğ¤Ğ°Ğ·Ğ° A (Ğ¿Ñ€ĞµĞ²ÑŒÑ):**
```
ğŸ‘€ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ...
â³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI...
```
â†“ (Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ â†’ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ, Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ-Ñ„Ğ¾Ñ‚Ğ¾ + ĞºĞ½Ğ¾Ğ¿ĞºĞ¸)

**Ğ¤Ğ°Ğ·Ğ° B (ÑĞ±Ğ¾Ñ€ĞºĞ°):**
```
ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...
â³ Ğ£Ğ´Ğ°Ğ»ÑÑ Ñ„Ğ¾Ğ½...
```
â†“
```
ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...
âœ… Ğ¤Ğ¾Ğ½ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½
â³ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ Ğ½Ğ°Ğ´Ğ¿Ğ¸ÑĞ¸...
```
â†“
```
ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...
âœ… Ğ¤Ğ¾Ğ½ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½
âœ… ĞĞ°Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹
â³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Telegram ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...
```
â†“ (Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ â†’ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ, Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚)

### Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```typescript
async function updatePackProgress(session: any, stage: string, lang: string) {
  if (!session.progress_message_id || !session.progress_chat_id) return;
  const stageTexts: Record<string, Record<string, string>> = {
    // Ğ¤Ğ°Ğ·Ğ° A
    generating_preview: {
      ru: "ğŸ‘€ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ...\nâ³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI...",
      en: "ğŸ‘€ Generating preview...\nâ³ Creating stickers with AI...",
    },
    // Ğ¤Ğ°Ğ·Ğ° B
    removing_bg: {
      ru: "ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...\nâ³ Ğ£Ğ´Ğ°Ğ»ÑÑ Ñ„Ğ¾Ğ½...",
      en: "ğŸ“¦ Assembling sticker pack...\nâ³ Removing background...",
    },
    finishing: {
      ru: "ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...\nâœ… Ğ¤Ğ¾Ğ½ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½\nâ³ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ Ğ½Ğ°Ğ´Ğ¿Ğ¸ÑĞ¸...",
      en: "ğŸ“¦ Assembling sticker pack...\nâœ… Background removed\nâ³ Adding labels...",
    },
    assembling: {
      ru: "ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...\nâœ… Ğ¤Ğ¾Ğ½ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½\nâœ… ĞĞ°Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹\nâ³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...",
      en: "ğŸ“¦ Assembling sticker pack...\nâœ… Background removed\nâœ… Labels added\nâ³ Creating sticker set...",
    },
  };
  try {
    const text = stageTexts[stage]?.[lang] || stageTexts[stage]?.["en"] || stage;
    await editMessageText(session.progress_chat_id, session.progress_message_id, text);
  } catch {}
}
```

---

## 9. ĞœĞµĞ½Ñ

### Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ¼ĞµĞ½Ñ (2Ã—2)

```
[ğŸ¤– ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº] [ğŸ¨ Ğ¡Ñ‚Ğ¸Ğ»Ğ¸]
[ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ]   [â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ]
```

### ĞĞ¾Ğ²Ğ¾Ğµ Ğ¼ĞµĞ½Ñ (3 Ñ€ÑĞ´Ğ°)

```
[ğŸ¤– ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº] [ğŸ¨ Ğ¡Ñ‚Ğ¸Ğ»Ğ¸]
[ğŸ“¦ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğº]
[ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ]   [â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ]
```

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº

```typescript
bot.hears(["ğŸ“¦ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğº", "ğŸ“¦ Make a pack"], async (ctx) => {
  // â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞºÑ€Ğ°Ğ½-Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ¿Ğ°ĞºĞ°
});
```

### ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

```
[ğŸ“¦ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº] (url)
[ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ğº]    (callback: make_new_pack)
```

---

## 10. ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ¸

ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ·Ğ°ĞºĞ°Ğ· Â«Ğ¿Ğ°ĞºĞ°Â» ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ **Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹** Telegram sticker set.
Ğ˜Ğ¼Ñ: `p2s_pack_{telegramId}_{timestamp}_by_{botUsername}`.

Ğ¡Ñ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ¸ Ğ¸Ğ· Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ» **Ğ½Ğµ** Ğ¿Ğ¸ÑˆÑƒÑ‚ÑÑ Ğ² `users.sticker_set_name` â€”
Ğ¾Ğ½Ğ¸ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ² `pack_batches.sticker_set_name`.

---

## 11. Ğ¢ĞµĞºÑÑ‚Ñ‹ (texts.ts)

### RU

```typescript
"menu.make_pack": "ğŸ“¦ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğº",
"pack.intro_title": "Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚ĞµĞ»ĞµĞ³Ñ€Ğ°Ğ¼ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ¹ Ğ¿Ğ°Ñ€Ñ‹ ğŸ’–",
"pack.intro_howto": "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾ â†’ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ²ÑŒÑ â†’ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº!",
"pack.intro_footer": "ĞšÑƒĞ»ÑŒÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹",
"pack.cta_button": "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
"pack.send_photo": "ğŸ“¸ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ Ğ¾Ğ´Ğ½Ğ¾ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ°.\n\nĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ° Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ñ‹.",
"pack.photo_received": "Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾! âœ…",
"pack.preview_offer": "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ĞºĞ°Ğº Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ñ‹Ğ³Ğ»ÑĞ´ĞµÑ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº?",
"pack.preview_caption": "Ğ’Ğ¾Ñ‚ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ñ‚Ğ²Ğ¾ĞµĞ³Ğ¾ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°ĞºĞ° Ğ¸Ğ· {count} ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²!\n\nĞÑ€Ğ°Ğ²Ğ¸Ñ‚ÑÑ? Ğ–Ğ¼Ğ¸ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ» ({price} ğŸ’)",
"pack.not_enough_credits": "ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² ğŸ˜”\nĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ!",
"pack.progress_generating": "ğŸ‘€ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ...\nâ³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI...",
"pack.progress_assembling": "ğŸ“¦ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº...",
"pack.done": "ğŸ‰ Ğ¢Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²!\n\n{count} ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² Ğ² Ğ¿Ğ°ĞºĞµ\n{link}",
"pack.done_partial": "ğŸ‰ Ğ¡Ñ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²!\n\n{count} Ğ¸Ğ· {total} ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ\n{link}",
"pack.failed": "ğŸ˜” Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¿Ğ°Ğº.\n\n{refund} ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ñ‹ Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.",
"pack.preview_failed": "ğŸ˜” ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ.\n\n1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ñ‘Ğ½ Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.",
"pack.cancelled": "ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾.",
"btn.preview_pack": "ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ â€” 1 ğŸ’",
"btn.approve_pack": "âœ… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº â€” {price} ğŸ’",
"btn.regenerate_pack": "ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” 1 ğŸ’",
"btn.cancel_pack": "âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°",
"btn.add_pack": "ğŸ“¦ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğº",
"btn.new_pack": "ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ğº",
"btn.topup_credits": "ğŸ’° ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ",
```

### EN

```typescript
"menu.make_pack": "ğŸ“¦ Make a pack",
"pack.intro_title": "Unique Telegram stickers for your couple ğŸ’–",
"pack.intro_howto": "Upload a photo â†’ see preview â†’ get a ready sticker pack!",
"pack.intro_footer": "A must-have reaction set for every occasion",
"pack.cta_button": "Try it",
"pack.send_photo": "ğŸ“¸ Send one photo for the sticker pack.\n\nCan be a photo of one person or a couple.",
"pack.photo_received": "Photo received! âœ…",
"pack.preview_offer": "Want to see how your sticker pack will look?",
"pack.preview_caption": "Here's a preview of your {count}-sticker pack!\n\nLike it? Tap Â«Get packÂ» ({price} ğŸ’)",
"pack.not_enough_credits": "Not enough credits ğŸ˜”\nTop up your balance!",
"pack.progress_generating": "ğŸ‘€ Generating preview...\nâ³ Creating stickers with AI...",
"pack.progress_assembling": "ğŸ“¦ Assembling sticker pack...",
"pack.done": "ğŸ‰ Your sticker pack is ready!\n\n{count} stickers in the pack\n{link}",
"pack.done_partial": "ğŸ‰ Sticker pack is ready!\n\n{count} of {total} stickers generated\n{link}",
"pack.failed": "ğŸ˜” Unfortunately, we couldn't generate the sticker pack.\n\n{refund} credits returned to your balance.",
"pack.preview_failed": "ğŸ˜” Couldn't generate the preview.\n\n1 credit returned to your balance.",
"pack.cancelled": "Cancelled.",
"btn.preview_pack": "ğŸ‘€ See preview â€” 1 ğŸ’",
"btn.approve_pack": "âœ… Get pack â€” {price} ğŸ’",
"btn.regenerate_pack": "ğŸ”„ Regenerate â€” 1 ğŸ’",
"btn.cancel_pack": "âŒ Cancel",
"btn.add_pack": "ğŸ“¦ Add pack",
"btn.new_pack": "ğŸ†• New pack",
"btn.topup_credits": "ğŸ’° Top up balance",
```

---

## 12. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â€” Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ SQL

```sql
-- 1. ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_pack_photo';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_pack_preview_payment';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'generating_pack_preview';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'wait_pack_approval';
ALTER TYPE session_state ADD VALUE IF NOT EXISTS 'processing_pack';

-- 2. Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ¿Ğ°ĞºĞ¾Ğ²
CREATE TABLE IF NOT EXISTS pack_templates (
  id text PRIMARY KEY,
  name_ru text NOT NULL,
  name_en text NOT NULL,
  description_ru text,
  description_en text,
  preview_file_id text,         -- Telegram file_id ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸-ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶Ğ° Ğ´Ğ»Ñ CTA
  preview_url text,             -- fallback URL
  collage_file_id text,         -- Telegram file_id ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶Ğ° Ğ´Ğ»Ñ Gemini (ÑÑ‚Ğ°Ğ¹Ğ»-Ñ€ĞµÑ„ĞµÑ€ĞµĞ½Ñ)
  collage_url text,             -- fallback URL
  sticker_count int NOT NULL DEFAULT 4,
  labels jsonb NOT NULL,             -- Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² (RU): ["ĞœĞ¾Ñ ğŸ’•", ...]
  labels_en jsonb,                   -- Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² (EN): ["Mine ğŸ’•", ...]
  scene_descriptions jsonb NOT NULL, -- Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑÑ†ĞµĞ½ Ğ´Ğ»Ñ Gemini: ["romantic, hugging", ...]
  style_prompt_base text NOT NULL,
  sort_order int DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now()
);
-- Ğ£Ğ±Ñ€Ğ°Ğ½Ğ¾: price_stars (Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°Ğ¼Ğ¸ = sticker_count ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²)

-- 3. Ğ‘Ğ°Ñ‚Ñ‡Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
CREATE TABLE IF NOT EXISTS pack_batches (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL REFERENCES sessions(id),
  user_id uuid NOT NULL REFERENCES users(id),
  template_id text NOT NULL REFERENCES pack_templates(id),
  size int NOT NULL,
  completed_count int DEFAULT 0,
  failed_count int DEFAULT 0,
  status text DEFAULT 'preview',  -- preview â†’ approved â†’ processing â†’ done/partial/failed/cancelled
  credits_spent int DEFAULT 0,    -- ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² ÑƒĞ¶Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¾ (Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ°Ñ†Ğ¸Ğ¸)
  sticker_set_name text,
  env text DEFAULT 'prod',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_pack_batches_user ON pack_batches(user_id);
CREATE INDEX IF NOT EXISTS idx_pack_batches_status ON pack_batches(status);

-- 4. ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ Ğ² sessions
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS pack_template_id text;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS pack_batch_id uuid;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS pack_sheet_file_id text;  -- file_id Ğ¿Ñ€ĞµĞ²ÑŒÑ-Ğ»Ğ¸ÑÑ‚Ğ°

-- 5. ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ° Ğ² jobs (type: 'pack_preview' | 'pack_assemble')
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS pack_batch_id uuid REFERENCES pack_batches(id);

-- 6. Pack columns Ğ² stickers
ALTER TABLE stickers ADD COLUMN IF NOT EXISTS pack_batch_id uuid REFERENCES pack_batches(id);
ALTER TABLE stickers ADD COLUMN IF NOT EXISTS pack_index int;

-- 7. RPC Ğ´Ğ»Ñ Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²
CREATE OR REPLACE FUNCTION deduct_credits(
  p_user_id uuid,
  p_amount int,
  p_reason text
) RETURNS boolean AS $$
DECLARE
  rows_affected int;
BEGIN
  UPDATE users
  SET credits = credits - p_amount
  WHERE id = p_user_id AND credits >= p_amount;

  GET DIAGNOSTICS rows_affected = ROW_COUNT;
  RETURN rows_affected > 0;
END;
$$ LANGUAGE plpgsql;

-- 8. Seed: Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ (Ñ‚ĞµÑÑ‚ â€” 4 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°)
INSERT INTO pack_templates (
  id, name_ru, name_en, description_ru, description_en,
  sticker_count,
  labels, labels_en, scene_descriptions,
  style_prompt_base, sort_order
) VALUES (
  'couple_v1',
  'ĞŸĞ°Ñ€Ğ°',
  'Couple',
  'Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚ĞµĞ»ĞµĞ³Ñ€Ğ°Ğ¼ ÑÑ‚Ğ¸ĞºĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ¹ Ğ¿Ğ°Ñ€Ñ‹ ğŸ’–',
  'Unique Telegram stickers for your couple ğŸ’–',
  4,
  '["ĞœĞ¾Ñ ğŸ’•", "Ğ›ÑĞ±Ğ»Ñ ğŸ˜˜", "Ğ¡Ğ¿Ğ¸Ğ¼? ğŸ˜´", "Ğ’ĞºÑƒÑĞ½Ğ¾? ğŸ•"]'::jsonb,
  '["Mine ğŸ’•", "Love ğŸ˜˜", "Sleep? ğŸ˜´", "Yummy? ğŸ•"]'::jsonb,
  '["romantic, hugging tenderly", "blowing a kiss, hearts flying around", "sleeping together, cozy and peaceful", "eating pizza together, happy and playful"]'::jsonb,
  'Cute couple sticker in cartoon style. The character(s) should be recognizable from the reference photo. White outline around the character. Clean, expressive, suitable for Telegram sticker pack.',
  1
) ON CONFLICT (id) DO NOTHING;
```

---

## 13. ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾ÑˆĞ°Ğ³Ğ¾Ğ²Ñ‹Ğ¹)

### Ğ¤Ğ°Ğ·Ğ° 1: Ğ‘Ğ” + Ğ¼ĞµĞ½Ñ + ÑĞºÑ€Ğ°Ğ½ Ğ¿Ñ€ĞµĞ²ÑŒÑ

1. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ SQL-Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸.
2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ» Ğ² `getMainMenuKeyboard`.
3. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ‚ĞµĞºÑÑ‚Ğ° Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ» â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ.
4. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ»Ğ°Ğ¶-ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ, Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ file_id, Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² `pack_templates`.
5. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ² `texts.ts`.

### Ğ¤Ğ°Ğ·Ğ° 2: ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ñ„Ğ¾Ñ‚Ğ¾ + Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°

6. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº `bot.on("photo")`: Ğ²ĞµÑ‚ĞºĞ° `wait_pack_photo` â†’ ĞºĞ½Ğ¾Ğ¿ĞºĞ° "ĞŸÑ€ĞµĞ²ÑŒÑ Ğ·Ğ° 1ğŸ’".
7. Callback `pack_preview_pay:BATCH_ID` â†’ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚ â†’ Ğ´Ğ¶Ğ¾Ğ±Ğ° `pack_preview`.
8. `runPackPreviewJob()`: Gemini â†’ Ğ¿Ñ€ĞµĞ²ÑŒÑ ÑĞ·ĞµÑ€Ñƒ â†’ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ.
9. Callback `pack_approve:BATCH_ID` â†’ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ N-1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ² â†’ Ğ´Ğ¶Ğ¾Ğ±Ğ° `pack_assemble`.
10. Callback `pack_regenerate:BATCH_ID` â†’ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ 1 ĞºÑ€ĞµĞ´Ğ¸Ñ‚ â†’ Ğ½Ğ¾Ğ²Ğ°Ñ Ğ´Ğ¶Ğ¾Ğ±Ğ° `pack_preview`.
11. Callback `pack_cancel:BATCH_ID` â†’ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ°.
12. `runPackAssembleJob()`: ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»Ğ¸ÑÑ‚ â†’ Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ° â†’ rembg â†’ Ñ‚ĞµĞºÑÑ‚ â†’ ÑĞ±Ğ¾Ñ€ĞºĞ°.

### Ğ¤Ğ°Ğ·Ğ° 3: ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ 16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²

13. ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ½Ğ° **Gemini 3 Pro** (`gemini-3-pro-image-preview`).
14. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `sticker_count=16` Ğ¸ `labels/scene_descriptions` (16 Ğ¿Ğ°Ñ€) Ğ² `pack_templates`.
15. ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚: `{grid}=4Ã—4`, `{count}=16`.
16. ĞšĞ¾Ğ´ Ğ½Ğ°Ñ€ĞµĞ·ĞºĞ¸ **Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ** â€” `cutSheetIntoCells` ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹.

### Ğ¤Ğ°Ğ·Ğ° 4: Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ (Ğ¿Ğ¾Ğ·Ğ¶Ğµ)

17. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½.
18. ĞšĞ°Ñ€ÑƒÑĞµĞ»ÑŒ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ² Ğ² Ğ¿Ñ€ĞµĞ²ÑŒÑ.
19. Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: `{lang}` Ğ² Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğµ Ğ´Ğ»Ñ EN/RU.

---

## 14. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹

| Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ | Ğ¢Ğ¸Ğ¿ Ğ°Ğ»ĞµÑ€Ñ‚Ğ° |
|---------|------------|
| ĞŸÑ€ĞµĞ²ÑŒÑ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ½Ğ¾ | `pack_preview_ordered` |
| ĞŸÑ€ĞµĞ²ÑŒÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° | `pack_preview_failed` |
| ĞŸĞ°Ğº Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½ | `pack_approved` |
| ĞŸĞ°Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ² (done) | `pack_completed` |
| ĞŸĞ°Ğº Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ (partial) | `pack_partial` |
| ĞŸĞ°Ğº Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½ (failed) | `pack_failed` |
| ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ | `pack_regenerated` |

---

## 15. Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

| Ğ¤Ğ°Ğ¹Ğ» | Ğ§Ñ‚Ğ¾ Ğ¼ĞµĞ½ÑÑ‚ÑŒ |
|------|-----------|
| `src/index.ts` | ĞœĞµĞ½Ñ, Â«Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ°ĞºÂ», Ñ„Ğ¾Ñ‚Ğ¾, callbacks (preview/approve/regenerate/cancel) |
| `src/worker.ts` | `runPackPreviewJob()`, `runPackAssembleJob()`, `cutSheetIntoCells()`, `overlayText()`, `assemblePack()` |
| `src/lib/texts.ts` | Ğ¢ĞµĞºÑÑ‚Ñ‹ `pack.*`, `menu.make_pack`, `btn.*` |
| `src/lib/alerts.ts` | ĞĞ¾Ğ²Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ Ğ°Ğ»ĞµÑ€Ñ‚Ğ¾Ğ² |
| `sql/` | ĞĞ¾Ğ²Ğ°Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ `076_make_pack.sql` |
| `docs/architecture/01-api-bot.md` | ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ, Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€Ñ‹, callbacks |
| `docs/architecture/02-worker.md` | Ğ”Ğ²Ğ° Ñ‚Ğ¸Ğ¿Ğ° Ğ´Ğ¶Ğ¾Ğ±: `pack_preview` + `pack_assemble` |
| `docs/architecture/04-database.md` | ĞĞ¾Ğ²Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹, RPC `deduct_credits` |

---

## 16. ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸ TODO

- [ ] Telegram Bot API: `createNewStickerSet` Ğ´Ğ¾ 50 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² (16 â€” Ğ¾Ğº).
- [ ] Gemini 2.5 Flash: 1024Ã—1024, Ğ´Ğ»Ñ 2Ã—2 = 512Ã—512/ÑÑ‚Ğ¸ĞºĞµÑ€ â€” Ñ‚ĞµÑÑ‚.
- [ ] Ğ”Ğ»Ñ 16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ²: Gemini 3 Pro (4096Ã—4096, 4Ã—4 = 1024/ÑÑ‚Ğ¸ĞºĞµÑ€).
- [ ] ĞĞ°Ñ€ĞµĞ·ĞºĞ°: ĞµÑĞ»Ğ¸ Gemini Ğ½Ğµ Ñ€Ğ¾Ğ²Ğ½Ğ¾ Ñ€Ğ°ÑÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ğ¾ ÑĞµÑ‚ĞºĞµ â€” ÑƒÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚.
- [ ] Labels-first: Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¸ ÑÑ†ĞµĞ½Ñ‹ ĞºÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ. Ğ”Ğ»Ñ 16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ¾Ğ² â€” 16 Ğ¿Ğ°Ñ€.
- [ ] Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹: SVG Ñ‡ĞµÑ€ĞµĞ· sharp Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… 512Ã—512. Fallback: ÑÑ‚Ğ¸ĞºĞµÑ€ Ğ±ĞµĞ· Ñ‚ĞµĞºÑÑ‚Ğ°.
- [ ] ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ rembg Ğ½Ğ° 16 ÑÑ‚Ğ¸ĞºĞµÑ€Ğ°Ñ… Ğ¿Ğ¾Ğ´ test/prod Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹.
- [ ] `opentype.js` ÑƒĞ¶Ğµ Ğ² deps â€” Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°.
- [ ] RPC `deduct_credits` â€” Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°.
- [ ] Telegram Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¶Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ¿Ñ€ĞµĞ²ÑŒÑ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ document).
- [ ] MVP Ğ±ĞµĞ· retry â€” Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ = Ğ°Ğ»ĞµÑ€Ñ‚ + Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ².
