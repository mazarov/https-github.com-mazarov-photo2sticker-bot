# Feedback Survey v2 (–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

## –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π

Support –±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å –Ω–∏–º –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∏.
Telegram API –∑–∞–ø—Ä–µ—â–∞–µ—Ç –±–æ—Ç–∞–º –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏ –Ω–µ–∑–Ω–∞–∫–æ–º—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

## –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  photo2sticker  ‚îÇ     ‚îÇ     Worker      ‚îÇ     ‚îÇ  p2s_support    ‚îÇ
‚îÇ   (–æ—Å–Ω–æ–≤–Ω–æ–π)    ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ   (feedback)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ              INSERT trigger                   ‚îÇ
         ‚îÇ              (credits = 0)                    ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
   cron: process triggers ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
   –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ                                  ‚îÇ
   —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞ support –±–æ—Ç                              ‚îÇ
         ‚îÇ                                               ‚îÇ
         ‚îÇ     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫    ‚îÇ
         ‚îÇ                                               ‚îÇ
         ‚îÇ                              /start feedback_<user_id>
         ‚îÇ                              –ø—Ä–∏—ë–º —Ç–µ–∫—Å—Ç–∞
         ‚îÇ                              —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ user_feedback
         ‚îÇ                              –∞–ª–µ—Ä—Ç –≤ Support Channel
         ‚îÇ                                               ‚îÇ
         ‚îÇ                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                                    ‚îÇ   Support Channel   ‚îÇ
         ‚îÇ                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ó–∞–¥–∞—á–∏ |
|-----------|--------|
| **Worker** | –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏ credits = 0 |
| **Main Bot (index.ts)** | Cron: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π |
| **Support Bot** | –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π feedback, –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –∞–¥–º–∏–Ω—É |

## –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞

```
–£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã üò¢

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –≤–∞–º –±–æ—Ç? –í–∞—à –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ!

[‚úçÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤]
```

–ö–Ω–æ–ø–∫–∞ ‚Üí `https://t.me/p2s_support_bot?start=feedback_<user_id>`

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. index.ts ‚Äî cron –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```typescript
// Cron: –æ–±—Ä–∞–±–æ—Ç–∫–∞ feedback —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
async function processFeedbackTriggers() {
  try {
    const now = new Date().toISOString();
    const { data: triggers, error } = await supabase
      .from("notification_triggers")
      .select("*")
      .eq("status", "pending")
      .eq("trigger_type", "feedback_zero_credits")
      .lte("fire_after", now)
      .limit(10);

    if (error || !triggers?.length) return;

    console.log(`Processing ${triggers.length} feedback triggers`);

    for (const trigger of triggers) {
      try {
        await bot.telegram.sendMessage(
          trigger.telegram_id,
          "–£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã üò¢\n\n" +
          "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –≤–∞–º –±–æ—Ç? –í–∞—à –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ!",
          {
            reply_markup: {
              inline_keyboard: [[
                { 
                  text: "‚úçÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", 
                  url: `https://t.me/p2s_support_bot?start=feedback_${trigger.user_id}` 
                }
              ]]
            }
          }
        );

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π
        await supabase
          .from("notification_triggers")
          .update({ status: "fired", fired_at: now })
          .eq("id", trigger.id);

        console.log(`Feedback message sent to ${trigger.telegram_id}`);
      } catch (err: any) {
        console.error(`Failed to send feedback to ${trigger.telegram_id}:`, err.message);

        // –ï—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ ‚Äî –æ—Ç–º–µ–Ω—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä
        if (err.response?.error_code === 403) {
          await supabase
            .from("notification_triggers")
            .update({ status: "cancelled", metadata: { error: "blocked" } })
            .eq("id", trigger.id);
        }
      }
    }
  } catch (err) {
    console.error("Error in processFeedbackTriggers:", err);
  }
}

// –ó–∞–ø—É—Å–∫ cron –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞
// –í –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞, –ø–æ—Å–ª–µ bot.launch():
processFeedbackTriggers();
setInterval(processFeedbackTriggers, 60 * 1000);
```

### 2. support-bot.ts ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ /start feedback_*

```typescript
// Map –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—Ç–æ –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞ feedback
const pendingFeedback = new Map<number, string>(); // telegram_id -> user_id

// –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π /start handler
bot.start(async (ctx) => {
  const payload = ctx.startPayload;
  
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à—ë–ª –æ—Å—Ç–∞–≤–∏—Ç—å feedback
  if (payload?.startsWith("feedback_")) {
    const userId = payload.replace("feedback_", "");
    pendingFeedback.set(ctx.from.id, userId);
    
    await ctx.reply(
      "–°–ø–∞—Å–∏–±–æ —á—Ç–æ —Ä–µ—à–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤! üôè\n\n" +
      "–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ ‚Äî —á—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, —á—Ç–æ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç?"
    );
    return;
  }
  
  // –ê–¥–º–∏–Ω —Ö–æ—á–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å
  if (payload?.startsWith("reply_") && ADMIN_IDS.includes(ctx.from.id)) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ ...
  }
  
  await ctx.reply("–≠—Ç–æ –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ photo2sticker. –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å!");
});

// –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π text handler
bot.on("text", async (ctx) => {
  const telegramId = ctx.from.id;
  
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–≤–ª—è–µ—Ç feedback
  if (pendingFeedback.has(telegramId)) {
    const userId = pendingFeedback.get(telegramId)!;
    pendingFeedback.delete(telegramId);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    await supabase.from("user_feedback").upsert({
      user_id: userId,
      telegram_id: telegramId,
      username: ctx.from.username,
      answer_text: ctx.message.text,
      answer_at: new Date().toISOString(),
    }, { onConflict: "user_id" });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç –≤ Support Channel
    await sendFeedbackAlert(ctx.from, ctx.message.text);
    
    await ctx.reply("–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–µ–º üíú");
    return;
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (admin reply, general message) ...
});
```

### 3. –£–±—Ä–∞—Ç—å cron –∏–∑ support-bot.ts

–£–¥–∞–ª–∏—Ç—å `processTriggers()` –∏ `setInterval(processTriggers, ...)` ‚Äî 
—Ç–µ–ø–µ—Ä—å —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç.

–û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ:
- –û–±—Ä–∞–±–æ—Ç–∫—É `/start feedback_*` –∏ `/start reply_*`
- –ü—Ä–∏—ë–º —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- Fallback –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/index.ts` | +40 —Å—Ç—Ä–æ–∫ (—Ñ—É–Ω–∫—Ü–∏—è processFeedbackTriggers + –∑–∞–ø—É—Å–∫ cron) |
| `src/support-bot.ts` | –î–æ–±–∞–≤–∏—Ç—å pendingFeedback Map, –æ–±—Ä–∞–±–æ—Ç–∫—É feedback_*, —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–π cron |
| `worker.ts` | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—É–∂–µ —Å–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã) |

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
2. **–ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** ‚Äî main –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç, support –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç
3. **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ support –±–æ—Ç–µ
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç** ‚Äî –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—á–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤

## Checklist

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `src/index.ts` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å processFeedbackTriggers cron
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `src/support-bot.ts` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É feedback_*, —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–π cron
- [ ] –û—Ç–º–µ–Ω–∏—Ç—å pending —Ç—Ä–∏–≥–≥–µ—Ä—ã (SQL: UPDATE ... SET status = 'cancelled')
- [ ] –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö users —Å credits = 0
- [ ] –î–µ–ø–ª–æ–π –æ–±–æ–∏—Ö –±–æ—Ç–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É

## SQL: –°–±—Ä–æ—Å –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```sql
-- –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ pending —Ç—Ä–∏–≥–≥–µ—Ä—ã
UPDATE notification_triggers 
SET status = 'cancelled' 
WHERE trigger_type = 'feedback_zero_credits' 
AND status = 'pending';

-- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
INSERT INTO notification_triggers (user_id, telegram_id, trigger_type, fire_after, status)
SELECT 
  u.id,
  u.telegram_id,
  'feedback_zero_credits',
  now() + (row_number() OVER () * interval '1 second'),
  'pending'
FROM users u
WHERE u.credits = 0
AND NOT EXISTS (
  SELECT 1 FROM notification_triggers nt 
  WHERE nt.user_id = u.id 
  AND nt.trigger_type = 'feedback_zero_credits'
  AND nt.status = 'fired'  -- —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏
);
```
