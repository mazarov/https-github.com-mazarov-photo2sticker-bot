# Админ: «Сделать примером» из меню по ссылке на стикерпак

**Дата:** 27.02.2026  
**Формат:** требования (docs)  
**Контекст:** Альтернативный способ заполнения примеров для карусели эмоций: админ выбирает эмоцию из списка (инлайн-кнопки) и присылает ссылку на стикерпак; бот парсит паку, собирает все стикеры в одно изображение 1024×1024 (сетка) и сохраняет как пример для этой эмоции в Storage.

---

## 1. Требования

### 1.1. Кнопка в меню для админа

- В нижнем меню (Reply Keyboard) у **админа** (test: `config.adminIds`, prod: по необходимости) появляется кнопка: **«Сделать примером»** (или «Make as example»).
- Расположение: отдельная кнопка или рядом с существующими админ-кнопками (например «Сгенерировать пак» на test). Конкретный ряд/порядок — на усмотрение реализации.
- По нажатию бот показывает список эмоций (инлайн-кнопки) и после выбора запрашивает ссылку на стикерпак (см. ниже).

### 1.2. Выбор эмоции (инлайн-кнопки)

- Админ указывает, **для какой эмоции** показывать пример, **нажимая инлайн-кнопку**.
- **Источник:** таблица **`emotion_presets`** (активные пресеты карусели эмоций). Бот загружает список (`getEmotionPresets`), для каждой записи — кнопка с подписью (emoji + name_ru / name_en по языку), callback_data: `admin_emotion_example:{id}`.
- Поведение:
  - Бот отправляет сообщение «Выбери эмоцию:» с клавиатурой из кнопок (одна кнопка на пресет).
  - Админ нажимает кнопку. Обработчик проверяет наличие и активность пресета в `emotion_presets`; при успехе переходим к шагу «ссылка на стикерпак».

### 1.3. Ссылка на стикерпак

- Админ присылает **ссылку на стикерпак** в формате Telegram:
  - `https://t.me/addstickers/{short_name}`
  - или `t.me/addstickers/{short_name}`
- Бот извлекает `short_name` (имя пака) и по нему запрашивает через Telegram Bot API метод **`getStickerSet(set_name)`** список стикеров пака.
- Если набор не найден или пуст — сообщение об ошибке, можно повторить ввод ссылки или выйти из сценария.

### 1.4. Парсинг стикерпака и сборка изображения 1024×1024

- По полученному набору стикеров:
  - Скачиваются **все** файлы стикеров (через `getFile` + загрузка по `file_path`).
  - Формат стикеров в Telegram — обычно PNG/WebP с прозрачностью; размер до 512×512 (или 512 по большей стороне). Нужно привести к единому размеру ячейки (см. ниже).
- **Сетка:** все стикеры собираются в **одно изображение 1024×1024** в формате **WebP**.
  - Каждый стикер помещается в **свою ячейку** сетки.
  - Размер сетки: например 3×3 (9 стикеров) или 2×2 (4), или 1×N — в зависимости от количества стикеров в пачке. Рекомендация: фиксировать размер сетки под типичный пак (например 9 стикеров → 3×3), при другом количестве — центрировать или дополнять пустыми ячейками / обрезать до 9.
  - Размер одной ячейки при 3×3: 1024/3 ≈ 341×341 пикселей; стикер масштабируется/вписывается в ячейку с сохранением пропорций, при необходимости с отступами.
- Итоговый файл: **одно изображение 1024×1024**, WebP, загружается в Storage по пути **`emotion-examples/{emotion_preset_id}.webp`** (бакет `stickers-examples` или аналог, см. 27-02-emotion-carousel-example-images.md).
- После успешной загрузки: сообщение админу «Пример для эмоции {id} сохранён»; сброс кэша примеров эмоций (например `emotionPresetsCache = null`), чтобы карусель подтянула новый пример.

---

## 2. Сценарий (flow)

1. Админ нажимает в меню кнопку **«Сделать примером»**.
2. Бот загружает активные пресеты из `emotion_presets` и отправляет сообщение «Выбери эмоцию:» с инлайн-кнопками (emoji + название по языку).
3. Админ нажимает кнопку нужной эмоции. Бот проверяет пресет в БД, сохраняет выбранный emotion_id в памяти (Map по telegram_id) и просит ссылку.
4. Бот: «Пришли ссылку на стикерпак (https://t.me/addstickers/...)».
5. Админ присылает ссылку. Бот парсит short_name, вызывает getStickerSet, скачивает все стикеры, собирает сетку 1024×1024, сохраняет в Storage как `emotion-examples/{emotion_preset_id}.webp`, сбрасывает кэш и пишет «Пример для эмоции {id} сохранён».
6. Выход из сценария. Повтор: снова нажать «Сделать примером» и выбрать эмоцию.

---

## 3. Технические детали

### 3.1. Telegram Bot API

- **getStickerSet(name)** — имя набора (short_name из ссылки). Возвращает объект с полем `stickers` — массив стикеров; у каждого есть `file_id` (или `file_unique_id`).
- Для загрузки файла по `file_id` — **getFile(file_id)** → получение `file_path` → скачивание по `https://api.telegram.org/file/bot<token>/<file_path>`.
- Размеры стикеров в наборе: обычно до 512 px по большей стороне; формат — PNG или WebP (статичные).

### 3.2. Сборка сетки 1024×1024

- Библиотека: существующие у проекта средства работы с изображениями (например Sharp, Jimp, canvas — что уже используется в worker/index для стикеров).
- Алгоритм:
  - Определить количество стикеров N.
  - Выбрать размер сетки (например 3×3 при N=9; при N<9 можно оставить пустые ячейки или уменьшить сетку).
  - Создать холст 1024×1024.
  - Для каждой ячейки: взять очередной стикер, масштабировать/вписать в размер ячейки (с сохранением пропорций, фон прозрачный или белый — на усмотрение), нарисовать в соответствующей позиции.
  - Экспорт в WebP, буфер загрузить в Storage.

### 3.3. Storage и кэш

- Путь: `emotion-examples/{emotion_preset_id}.webp` в бакете примеров (как в 27-02-emotion-carousel-example-images.md).
- После загрузки: обнулить кэш примеров эмоций в боте (например `emotionPresetsCache = null`), чтобы при следующем открытии карусели проверка наличия примера в Storage увидела новый файл.

### 3.4. Состояние админа

- Состояние хранится в памяти: `adminEmotionExampleFlow` — Map по telegram_id, значение `{ step: 2, emotionId }` после выбора эмоции кнопкой. Шаг 1 (выбор эмоции) — только отображение кнопок, в Map не пишем.
- При рестарте процесса состояние теряется; для редкого использования допустимо.

---

## 4. Критерии приёмки

- [ ] У админа в меню есть кнопка «Сделать примером».
- [ ] По нажатию бот показывает список эмоций инлайн-кнопками (из активных `emotion_presets`); после выбора кнопки запрашивает ссылку на стикерпак (t.me/addstickers/...).
- [ ] По ссылке бот получает набор стикеров (getStickerSet), скачивает все файлы, собирает их в одно изображение 1024×1024 (сетка, каждая ячейка — стикер), формат WebP.
- [ ] Файл сохраняется в Storage как `emotion-examples/{emotion_preset_id}.webp`; кэш примеров эмоций сбрасывается; админу выводится подтверждение.
- [ ] В карусели эмоций пример для данной эмоции при следующем открытии отображается (если эта эмоция первая с примером по sort_order).

---

## 5. Связанные документы и код

- Примеры эмоций, Storage, карусель: `docs/27-02-emotion-carousel-example-images.md`.
- Меню админа: `docs/20-02-admin-generate-pack-menu-button.md`, `src/index.ts` — `getMainMenuKeyboard`.
- Telegram Bot API: getStickerSet, getFile.
- Работа с изображениями: `src/worker.ts` (сетки, ресайз), `src/lib/image-utils.ts`.
- БД: `emotion_presets` — `docs/architecture/04-database.md`.

---

## 6. Не в scope (на первом этапе)

- Редактирование/удаление примера через бота (достаточно перезаписать по тому же id).
- Поддержка анимированных стикеров (TGS) — только статичные стикеры; анимации можно пропускать или брать первый кадр при наличии инструментов.
